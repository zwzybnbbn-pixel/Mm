<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo';}
body{background:#eef3f3;padding:12px;}

.back-btn{display:inline-block;background:#444;color:#fff;padding:10px 16px;border-radius:10px;text-decoration:none;margin-bottom:15px;font-size:16px;}

.card{width:100%;background:white;padding:18px;border-radius:15px;box-shadow:0 3px 12px #00000022;margin-bottom:15px;}

h2{font-size:22px;color:#00695C;text-align:center;margin-bottom:15px;font-weight:800;}

.info{background:#f9ffff;padding:12px;border-left:5px solid #00796B;border-radius:12px;margin-bottom:12px;}
.label{font-size:15px;font-weight:700;color:#00695C;}
.value{font-size:16px;color:#333;margin-top:4px;}

.hospital-imgcircle {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  object-fit: cover;
  display: block;
  margin: 10px auto;
  border: 3px solid #009688;
}

.map-btn {
  display: block;
  width: 100%;
  padding: 14px;
  margin-top: 12px;
  background: #00796B;
  color: white;
  font-size: 17px;
  border-radius: 10px;
  text-align: center;
  text-decoration: none;
  font-weight: 700;
}

.map-btn:hover {
  background: #009688;
}

/* Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
.avg-box{text-align:center;margin-bottom:10px;}
.avg-rating{font-size:40px;font-weight:900;color:#ffb300;}
.rating-stars{font-size:22px;color:#ffb300;}

.reviews .review{
  background:#fff;
  padding:12px;
  border-radius:12px;
  margin-bottom:12px;
  box-shadow:0 2px 10px #00000015;
}

.review .stars{color:#ffb300;font-size:18px;}

.review-like{margin-top:8px;font-size:15px;color:#00695C;cursor:pointer;}
.review-like span{font-weight:bold;color:#00796B;}

.add-review textarea{width:100%;min-height:100px;padding:10px;border-radius:10px;border:1px solid #ccc;}

.stars-input span{font-size:30px;color:#ccc;cursor:pointer;}
.stars-input .active{color:#ffb300;}

.btn{
  background:#009688;color:white;padding:10px;border:0;border-radius:10px;
  font-size:16px;cursor:pointer;margin-top:10px;
}
</style>
</head>

<body>

<a href="clinics.html" class="back-btn">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø©</a>

<img id="clinicImg" class="hospital-imgcircle" alt="clinic">

<div class="card">
  <h2 id="cName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>

  <div class="info">
    <div class="label">ğŸ“ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</div>
    <div class="value" id="cCity"></div>
  </div>

  <div class="info">
    <div class="label">ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</div>
    <div class="value" id="cPhone"></div>
  </div>

  <div class="info">
    <div class="label">ğŸ§© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</div>
    <div class="value" id="cDepartment"></div>
  </div>

  <div class="info">
    <div class="label">ğŸ“ Ø§Ù„ÙˆØµÙ:</div>
    <div class="value" id="cDescription"></div>
  </div>
  <div class="card">
  <h2 style="color:#00695C; margin-bottom:12px; text-align:center;">
    Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
  </h2>
  <div id="hospitalDoctors" style="display:grid; gap:15px;"></div>
</div>

  <a id="mapBtn" class="map-btn" href="#" target="_blank">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>

</div>

<!-- Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
<div class="card">
  <div class="avg-box">
    <div class="avg-rating" id="avgRating">0.0</div>
    <div class="rating-stars" id="ratingStars">â˜…â˜…â˜…â˜…â˜…</div>
    <div id="ratingCount">0 ØªÙ‚ÙŠÙŠÙ…</div>
  </div>

  <div class="reviews" id="reviewsList">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.</div>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… -->
<div class="card add-review">
  <h3>Ø§ÙƒØªØ¨ ØªÙ‚ÙŠÙŠÙ…Ùƒ</h3>

  <div id="starsInput" class="stars-input"></div>

  <textarea id="reviewText" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§..."></textarea>

  <button id="sendReview" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import {
  doc, getDoc,
  collection, addDoc, getDocs, updateDoc,
  query, orderBy, serverTimestamp, increment
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const id = new URLSearchParams(location.search).get("id");

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
async function loadClinic(){
  const ref = doc(db, "clinics", id);
  const snap = await getDoc(ref);

  if(!snap.exists()) return;

  const c = snap.data();

  document.getElementById("cName").textContent = c.name;
  document.getElementById("cCity").textContent = c.city || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  document.getElementById("cPhone").textContent = c.phone || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  document.getElementById("cDepartment").textContent = c.department || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  document.getElementById("cDescription").textContent = c.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
  document.getElementById("clinicImg").src = c.img || "images/default.jpg";
  document.getElementById("mapBtn").href = c.map || "#";
}

/* Ø§Ù„Ù†Ø¬ÙˆÙ… */
let selected = 5;
function drawStarsInput(){
  let html="";
  for(let i=1;i<=5;i++){
    html+=`<span data-id="${i}" class="${i<=selected?'active':''}">â˜…</span>`;
  }
  starsInput.innerHTML=html;
}
drawStarsInput();

starsInput.addEventListener("click", e=>{
  const s=e.target.closest("span");
  if(!s) return;
  selected = Number(s.dataset.id);
  drawStarsInput();
});
async function loadHospitalDoctors() {
  const box = document.getElementById("hospitalDoctors");
  box.innerHTML = "<p>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>";

  const doctorsRef = collection(db, "doctors");
  const snap = await getDocs(doctorsRef);

  let found = 0;
  box.innerHTML = "";

  // Ø§Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const clinicName = document.getElementById("cName").textContent.trim();

  snap.forEach(docSnap => {
    const d = docSnap.data();

    // Ù‡Ù†Ø§ Ø§Ù„Ø­Ù„:
    // ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø­Ù‚Ù„ hospital Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
    const match = (d.hospital || "").trim() === clinicName;

    if (match) {
      found++;

      box.innerHTML += `
        <div style="
          background:#fff;
          padding:15px;
          border-radius:12px;
          box-shadow:0 2px 8px #0002;
          display:flex;
          gap:12px;
          align-items:center;
        ">
        
          <img src="${d.img || 'images/default.jpg'}"
               style="width:70px;height:70px;border-radius:50%;object-fit:cover;border:3px solid #009688">

          <div style="flex:1;">
            <div style="font-weight:700;color:#004D40;font-size:18px;">
              ${d.name}
            </div>
            <div>Ø§Ù„ØªØ®ØµØµ: ${d.specialty || ""}</div>
            <div>Ø§Ù„Ø£ÙŠØ§Ù…: ${d.days || ""}</div>
            <div>Ø§Ù„ÙˆÙ‚Øª: ${d.times || ""}</div>
          </div>

          <a href="doctor.html?id=${docSnap.id}"
             style="
               padding:8px 14px;
               background:#00796B;
               color:white;
               border-radius:8px;
               text-decoration:none;
             ">
            Ø¹Ø±Ø¶
          </a>

        </div>
      `;
    }
  });

  if(found === 0){
    box.innerHTML = `<p style="text-align:center;color:#555">
      Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡ Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©.
    </p>`;
  }
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª */
async function loadReviews(){
  const ref = collection(db, "clinics", id, "reviews");
  const q = query(ref, orderBy("date","desc"));
  const snap = await getDocs(q);

  let sum=0, count=0, html="";

  snap.forEach(r=>{
    count++;
    const d=r.data();
    sum+=d.rating;

    const rid = r.id;
    const likes = d.likes || 0;

    html+=`
      <div class="review">
        <div class="stars">${"â˜…".repeat(d.rating)}${"â˜†".repeat(5-d.rating)}</div>
        <p>${d.text}</p>

        <div class="review-like" onclick="likeReview('${rid}')">
          â¤ï¸ Ø£Ø¹Ø¬Ø¨Ù†ÙŠ <span>(${likes})</span>
        </div>
      </div>
    `;
  });

  avgRating.textContent = count ? (sum/count).toFixed(1) : "0.0";
  ratingCount.textContent = count+" ØªÙ‚ÙŠÙŠÙ…";
  ratingStars.textContent = "â˜…".repeat(Math.round(sum/count)) + "â˜†".repeat(5-Math.round(sum/count));

  reviewsList.innerHTML = html || "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.";
}

/* Ø¥Ø¹Ø¬Ø§Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ */
window.likeReview = async function(rid){
  if(localStorage.getItem("liked_"+rid)) return alert("Ù„Ù‚Ø¯ Ø£Ø¹Ø¬Ø¨Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù…Ø³Ø¨Ù‚Ø§Ù‹");

  const ref = doc(db, "clinics", id, "reviews", rid);
  await updateDoc(ref,{ likes: increment(1) });

  localStorage.setItem("liked_"+rid,"yes");
  loadReviews();
};

/* Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
sendReview.addEventListener("click", async ()=>{
  const text = reviewText.value.trim();
  if(!text) return alert("Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹");

  await addDoc(collection(db,"clinics",id,"reviews"),{
    rating:selected,
    text,
    likes:0,
    date:serverTimestamp()
  });

  reviewText.value="";
  selected=5;
  drawStarsInput();
  loadReviews();
});

// ØªØ´ØºÙŠÙ„
loadClinic();
loadHospitalDoctors()
loadReviews();
</script>

</body>
</html>
