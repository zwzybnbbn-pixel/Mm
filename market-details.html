<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل السوق</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- استيراد Supabase SDK -->
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabaseUrl = "https://gxuumjhtutkipvkljjhj.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4dXVtamh0dXRraXB2a2xqamhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NTM2MzEsImV4cCI6MjA4MTEyOTYzMX0.rmsSRTQ57cAJ3VAiQMe0mdxEYcERh6zQDep7DN_frFI";

        const supabase = createClient(supabaseUrl, supabaseKey);
        
        function getUserInfo() {
            let userInfo = localStorage.getItem('market_user_info');
            if (!userInfo) {
                userInfo = JSON.stringify({
                    id: 'user_' + Math.random().toString(36).substr(2, 9),
                    name: 'زائر'
                });
                localStorage.setItem('market_user_info', userInfo);
            }
            return JSON.parse(userInfo);
        }
        
        function updateUserName(name) {
            let userInfo = getUserInfo();
            userInfo.name = name || 'زائر';
            localStorage.setItem('market_user_info', JSON.stringify(userInfo));
            return userInfo;
        }
        
        window.supabase = supabase;
        window.getUserInfo = getUserInfo;
        window.updateUserName = updateUserName;
    </script>

    <style>
        :root {
            --market-primary: #2e7d32;
            --market-secondary: #43a047;
            --market-light: #66bb6a;
            --market-dark: #1b5e20;
            --market-bg: #f1f8e9;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow-light: 0 4px 15px rgba(46, 125, 50, 0.1);
            --shadow-hover: 0 8px 25px rgba(46, 125, 50, 0.2);
            --rating-color: #ffc107;
        }

        * { 
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        html { scroll-behavior: smooth; }

        body {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--market-dark), var(--market-primary));
            color: #fff;
            padding: 12px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(27, 94, 32, 0.3);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .back-btn:hover {
            transform: translateX(-5px);
            box-shadow: 0 6px 20px rgba(27, 94, 32, 0.4);
            background: linear-gradient(135deg, var(--market-primary), var(--market-dark));
        }

        .details-card {
            background: var(--card-bg);
            padding: 30px 25px;
            border-radius: 25px;
            box-shadow: var(--shadow-light);
            margin-top: 20px;
            border: 1px solid rgba(46, 125, 50, 0.1);
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .market-image-container {
            width: 100%;
            max-width: 300px;
            height: 300px;
            margin: 0 auto 30px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .market-image-container:hover {
            transform: scale(1.02);
        }

        .market-img {
            width: 100%;
            height: 100%;
            border-radius: 20px;
            object-fit: cover;
            border: 5px solid var(--market-secondary);
            box-shadow: 0 6px 20px rgba(67, 160, 71, 0.25);
        }

        .image-placeholder {
            width: 100%;
            height: 100%;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--market-light), var(--market-primary));
            display: flex;
            align-items: center;
            justify-content: center;
            border: 5px solid var(--market-secondary);
        }

        .image-placeholder i {
            font-size: 60px;
            color: white;
            opacity: 0.9;
        }

        .market-title {
            font-size: 28px;
            font-weight: 900;
            color: var(--market-primary);
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.4;
            position: relative;
            padding-bottom: 15px;
        }

        .market-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 50%;
            transform: translateX(50%);
            width: 120px;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--market-secondary), transparent);
            border-radius: 2px;
        }

        .info-section {
            margin-bottom: 30px;
        }

        .info-item {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(67, 160, 71, 0.05);
            border-radius: 15px;
            border-right: 4px solid var(--market-secondary);
        }

        .info-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--market-dark);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .info-label i {
            color: var(--market-secondary);
            font-size: 20px;
        }

        .info-value {
            color: #444;
            font-size: 16px;
            line-height: 1.6;
            padding-right: 30px;
        }

        .features-section {
            margin: 35px 0;
        }

        .section-title {
            font-size: 22px;
            font-weight: 800;
            color: var(--market-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .feature-card {
            background: white;
            padding: 20px 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(46, 125, 50, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .feature-card.active {
            border-color: var(--market-secondary);
            background: rgba(67, 160, 71, 0.05);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(46, 125, 50, 0.15);
        }

        .feature-icon {
            font-size: 28px;
            color: var(--market-primary);
            margin-bottom: 10px;
        }

        .feature-name {
            font-weight: 700;
            color: var(--market-dark);
            font-size: 16px;
        }

        .feature-status {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .map-btn {
            display: block;
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--market-secondary), var(--market-primary));
            color: white;
            text-align: center;
            font-size: 18px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(67, 160, 71, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .map-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(67, 160, 71, 0.4);
            background: linear-gradient(135deg, var(--market-primary), var(--market-secondary));
        }

        /* قسم التقييمات */
        .ratings-section {
            margin: 40px 0;
            padding: 25px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-light);
        }

        .add-rating-card {
            background: rgba(67, 160, 71, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed var(--market-light);
        }

        .rating-input-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--market-dark);
            margin-bottom: 15px;
            text-align: center;
        }

        .user-name-input-container {
            margin-bottom: 20px;
        }

        .user-name-label {
            display: block;
            color: var(--market-dark);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .user-name-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--market-light);
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Cairo';
            text-align: right;
        }

        .stars-rating {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 20px;
            direction: ltr;
        }

        .star-btn {
            background: none;
            border: none;
            font-size: 32px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 5px;
        }

        .star-btn:hover {
            color: var(--rating-color);
            transform: scale(1.2);
        }

        .star-btn.selected {
            color: var(--rating-color);
        }

        .rating-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--market-light);
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 100px;
            font-family: 'Cairo';
            text-align: right;
        }

        .submit-rating-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--market-secondary), var(--market-primary));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-rating-btn:hover {
            background: linear-gradient(135deg, var(--market-primary), var(--market-secondary));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 160, 71, 0.3);
        }

        .ratings-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), rgba(67, 160, 71, 0.05));
            border-radius: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--market-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .ratings-list {
            max-height: 500px;
            overflow-y: auto;
            padding-left: 10px;
        }

        .rating-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(46, 125, 50, 0.1);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .rating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--market-primary), var(--market-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .user-name {
            font-weight: 700;
            color: var(--market-dark);
        }

        .rating-date {
            color: #777;
            font-size: 14px;
        }

        .rating-stars-small {
            color: var(--rating-color);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .rating-comment {
            color: #444;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .rating-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .like-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            padding: 8px 15px;
            border-radius: 20px;
        }

        .like-btn:hover {
            color: #e53935;
        }

        .like-btn.liked {
            color: #e53935;
            font-weight: 700;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: rgba(244, 67, 54, 0.1);
        }

        .no-ratings {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .no-ratings i {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .error-message {
            text-align: center;
            padding: 40px 20px;
            color: #f44336;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-light);
            margin: 20px 0;
        }

        .error-message i {
            font-size: 60px;
            margin-bottom: 20px;
        }

        @media (max-width: 767px) {
            .container {
                padding: 10px;
            }
            
            .details-card {
                padding: 20px 15px;
            }
            
            .market-image-container {
                height: 250px;
            }
            
            .market-title {
                font-size: 24px;
            }
            
            .ratings-stats {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="markets.html" class="back-btn">
            <i class="fas fa-arrow-right"></i>
            العودة للأسواق
        </a>

        <!-- رسالة الخطأ -->
        <div id="error-message" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <h3 id="error-title">حدث خطأ</h3>
            <p id="error-details"></p>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: var(--market-primary); color: white; border: none; border-radius: 10px; cursor: pointer;">
                إعادة تحميل الصفحة
            </button>
        </div>

        <div id="market-details" class="details-card">
            <!-- سيتم تعبئة هذا القسم بالجافاسكريبت -->
        </div>

        <div class="ratings-section">
            <h3 class="section-title">التقييمات والتعليقات</h3>
            
            <div class="ratings-stats">
                <div class="stat-item">
                    <div id="averageRating" class="stat-value">0.0</div>
                    <div class="stat-label">متوسط التقييم</div>
                </div>
                <div class="stat-item">
                    <div id="totalRatings" class="stat-value">0</div>
                    <div class="stat-label">عدد التقييمات</div>
                </div>
            </div>

            <div class="add-rating-card">
                <div class="rating-input-title">أضف تقييمك</div>
                
                <div class="user-name-input-container">
                    <label class="user-name-label" for="userName">اسمك:</label>
                    <input type="text" id="userName" class="user-name-input" 
                           placeholder="اكتب اسمك هنا..." value="">
                </div>
                
                <div class="stars-rating" id="ratingStarsInput">
                    <button class="star-btn" data-value="1">☆</button>
                    <button class="star-btn" data-value="2">☆</button>
                    <button class="star-btn" data-value="3">☆</button>
                    <button class="star-btn" data-value="4">☆</button>
                    <button class="star-btn" data-value="5">☆</button>
                </div>
                
                <textarea class="rating-input" id="ratingComment" 
                          placeholder="اكتب تعليقك هنا..."></textarea>
                
                <button class="submit-rating-btn" id="submitRating">
                    <i class="fas fa-paper-plane"></i>
                    إرسال التقييم
                </button>
            </div>

            <div class="ratings-list" id="ratingsList">
                <div class="no-ratings">
                    <i class="far fa-comment-alt"></i>
                    <p>جاري تحميل التقييمات...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            let currentMarket = null;
            let selectedRating = 0;
            
            const urlParams = new URLSearchParams(window.location.search);
            const marketId = urlParams.get('id');
            
            if (!marketId) {
                showError('معرف السوق غير موجود', 'يرجى العودة إلى صفحة الأسواق وتحديد سوق لعرضه.');
                return;
            }
            
            await loadMarketDetails(marketId);
            setupRatingSystem();
            
            const userNameInput = document.getElementById('userName');
            const userInfo = window.getUserInfo();
            userNameInput.value = userInfo.name;
            
            async function loadMarketDetails(id) {
                try {
                    console.log('جاري تحميل بيانات السوق...');
                    
                    // التحقق من اتصال Supabase
                    if (!window.supabase) {
                        throw new Error('Supabase غير متوفر');
                    }
                    
                    // جلب بيانات السوق
                    const { data: market, error } = await window.supabase
                        .from('tourism_markets')
                        .select('*')
                        .eq('id', id)
                        .single();
                    
                    console.log('نتيجة الاستعلام:', { market, error });
                    
                    if (error) {
                        console.error('خطأ في الاستعلام:', error);
                        
                        if (error.code === 'PGRST116') {
                            throw new Error('الجدول "tourism_markets" غير موجود في قاعدة البيانات');
                        } else if (error.code === 'PGRST103') {
                            throw new Error('لم يتم العثور على السوق المطلوب');
                        } else {
                            throw error;
                        }
                    }
                    
                    if (!market) {
                        throw new Error('لم يتم العثور على السوق المطلوب');
                    }
                    
                    currentMarket = market;
                    displayMarketDetails(market);
                    
                    // محاولة جلب التقييمات
                    try {
                        await loadRatings(marketId);
                    } catch (ratingsError) {
                        console.warn('تحذير: تعذر تحميل التقييمات:', ratingsError);
                        showRatingsError('تعذر تحميل التقييمات. يمكنك إضافة تقييم جديد.');
                    }
                    
                } catch (error) {
                    console.error('خطأ في تحميل بيانات السوق:', error);
                    showError('حدث خطأ في تحميل بيانات السوق', 
                        error.message || 'يرجى التأكد من وجود جدول الأسواق في قاعدة البيانات');
                }
            }
            
            function displayMarketDetails(market) {
                const marketDetails = document.getElementById('market-details');
                
                // إنشاء HTML لعرض بيانات السوق
                let html = `
                    <div class="market-image-container">
                        ${market.image ? 
                            `<img src="${market.image}" alt="${market.name}" class="market-img">` :
                            `<div class="image-placeholder">
                                <i class="fas fa-store"></i>
                            </div>`
                        }
                    </div>

                    <h1 class="market-title">${market.name || 'سوق بدون اسم'}</h1>

                    <div class="info-section">
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-map-marker-alt"></i>
                                الموقع:
                            </div>
                            <div class="info-value">${market.location || 'غير محدد'}</div>
                        </div>

                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-clock"></i>
                                ساعات العمل:
                            </div>
                            <div class="info-value">${market.working_hours || 'غير محدد'}</div>
                        </div>

                        ${market.phone ? `
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-phone"></i>
                                الهاتف:
                            </div>
                            <div class="info-value">${market.phone}</div>
                        </div>
                        ` : ''}

                        ${market.specialties ? `
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-tags"></i>
                                التخصصات:
                            </div>
                            <div class="info-value">${market.specialties}</div>
                        </div>
                        ` : ''}

                        ${market.description ? `
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-info-circle"></i>
                                الوصف:
                            </div>
                            <div class="info-value">${market.description}</div>
                        </div>
                        ` : ''}
                    </div>

                    <!-- المميزات -->
                    <div class="features-section">
                        <h3 class="section-title">المميزات والخدمات</h3>
                        <div class="features-grid" id="featuresGrid"></div>
                    </div>
                `;
                
                // زر الخريطة
                if (market.map_link || market.location) {
                    const mapLink = market.map_link || 
                        `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(market.location || '')}`;
                    
                    html += `
                        <a href="${mapLink}" class="map-btn" target="_blank">
                            <i class="fas fa-map-marked-alt"></i>
                            عرض على الخريطة
                        </a>
                    `;
                }
                
                marketDetails.innerHTML = html;
                
                // عرض المميزات
                const featuresGrid = document.getElementById('featuresGrid');
                if (featuresGrid) {
                    const features = [
                        { id: 'parking', name: 'مواقف سيارات', icon: 'fa-parking', value: market.has_parking },
                        { id: 'restrooms', name: 'دورات مياه', icon: 'fa-restroom', value: market.has_restrooms },
                        { id: 'atm', name: 'صراف آلي', icon: 'fa-money-bill-wave', value: market.has_atm }
                    ];
                    
                    features.forEach(feature => {
                        const featureCard = document.createElement('div');
                        featureCard.className = `feature-card ${feature.value ? 'active' : ''}`;
                        featureCard.innerHTML = `
                            <div class="feature-icon">
                                <i class="fas ${feature.icon}"></i>
                            </div>
                            <div class="feature-name">${feature.name}</div>
                            <div class="feature-status">${feature.value ? 'متاح' : 'غير متاح'}</div>
                        `;
                        featuresGrid.appendChild(featureCard);
                    });
                }
            }
            
            async function loadRatings(marketId) {
                try {
                    const ratingsList = document.getElementById('ratingsList');
                    
                    // محاولة جلب التقييمات
                    const { data: ratings, error } = await window.supabase
                        .from('market_ratings')
                        .select('*')
                        .eq('market_id', marketId)
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        // إذا لم يكن الجدول موجوداً، عرض رسالة
                        if (error.code === 'PGRST116') {
                            throw new Error('جدول التقييمات غير موجود');
                        }
                        throw error;
                    }
                    
                    displayRatings(ratings || []);
                    updateStats(ratings || []);
                    
                } catch (error) {
                    console.error('خطأ في تحميل التقييمات:', error);
                    showRatingsError('تعذر تحميل التقييمات. يمكنك إضافة تقييم جديد.');
                }
            }
            
            function displayRatings(ratings) {
                const ratingsList = document.getElementById('ratingsList');
                
                if (!ratings || ratings.length === 0) {
                    ratingsList.innerHTML = `
                        <div class="no-ratings">
                            <i class="far fa-comment-alt"></i>
                            <p>لا توجد تقييمات بعد. كن أول من يقيّم!</p>
                        </div>
                    `;
                    return;
                }
                
                ratingsList.innerHTML = '';
                
                ratings.forEach(rating => {
                    const ratingItem = document.createElement('div');
                    ratingItem.className = 'rating-item';
                    
                    const userInfo = getUserInfo();
                    const isCurrentUser = rating.user_id === userInfo.id;
                    
                    ratingItem.innerHTML = `
                        <div class="rating-header">
                            <div class="user-info">
                                <div class="user-avatar">
                                    ${getInitials(rating.user_name || rating.user_id)}
                                </div>
                                <div>
                                    <div class="user-name">${rating.user_name || rating.user_id}</div>
                                    <div class="rating-date">${formatDate(rating.created_at)}</div>
                                </div>
                            </div>
                            <div class="rating-stars-small">
                                ${generateStarRating(rating.rating)}
                            </div>
                        </div>
                        
                        <div class="rating-comment">
                            ${rating.comment || 'لا يوجد تعليق'}
                        </div>
                        
                        ${isCurrentUser ? `
                        <div class="rating-actions">
                            <button class="delete-btn" onclick="deleteRating('${rating.id}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                        ` : ''}
                    `;
                    
                    ratingsList.appendChild(ratingItem);
                });
            }
            
            function updateStats(ratings) {
                if (!ratings || ratings.length === 0) {
                    document.getElementById('averageRating').textContent = '0.0';
                    document.getElementById('totalRatings').textContent = '0';
                    return;
                }
                
                const totalRating = ratings.reduce((sum, rating) => sum + rating.rating, 0);
                const averageRating = (totalRating / ratings.length).toFixed(1);
                
                document.getElementById('averageRating').textContent = averageRating;
                document.getElementById('totalRatings').textContent = ratings.length;
            }
            
            function setupRatingSystem() {
                const starButtons = document.querySelectorAll('.star-btn');
                const submitButton = document.getElementById('submitRating');
                const commentInput = document.getElementById('ratingComment');
                const userNameInput = document.getElementById('userName');
                
                starButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const value = parseInt(button.dataset.value);
                        selectedRating = value;
                        
                        starButtons.forEach((btn, index) => {
                            if (index < value) {
                                btn.textContent = '★';
                                btn.classList.add('selected');
                            } else {
                                btn.textContent = '☆';
                                btn.classList.remove('selected');
                            }
                        });
                    });
                });
                
                userNameInput.addEventListener('input', () => {
                    window.updateUserName(userNameInput.value.trim());
                });
                
                submitButton.addEventListener('click', async () => {
                    if (selectedRating === 0) {
                        alert('الرجاء اختيار تقييم من 1 إلى 5 نجوم');
                        return;
                    }
                    
                    const comment = commentInput.value.trim();
                    const userName = userNameInput.value.trim() || 'زائر';
                    const userInfo = getUserInfo();
                    
                    updateUserName(userName);
                    
                    try {
                        // محاولة إضافة التقييم
                        const { error } = await window.supabase
                            .from('market_ratings')
                            .insert({
                                market_id: marketId,
                                user_id: userInfo.id,
                                user_name: userName,
                                rating: selectedRating,
                                comment: comment
                            });
                        
                        if (error) {
                            // إذا كان الجدول غير موجود، عرض رسالة للمستخدم
                            if (error.code === 'PGRST116') {
                                alert('نظام التقييمات غير متوفر حالياً. سيتم إصلاحه قريباً.');
                                return;
                            }
                            throw error;
                        }
                        
                        // إعادة تحميل التقييمات
                        await loadRatings(marketId);
                        
                        // إعادة تعيين الحقول
                        selectedRating = 0;
                        commentInput.value = '';
                        starButtons.forEach(btn => {
                            btn.textContent = '☆';
                            btn.classList.remove('selected');
                        });
                        
                        alert('تم إرسال تقييمك بنجاح!');
                        
                    } catch (error) {
                        console.error('خطأ في إرسال التقييم:', error);
                        alert('حدث خطأ في إرسال التقييم. يرجى المحاولة مرة أخرى.');
                    }
                });
            }
            
            window.deleteRating = async function(ratingId) {
                if (!confirm('هل أنت متأكد من حذف هذا التقييم؟')) return;
                
                try {
                    const { error } = await window.supabase
                        .from('market_ratings')
                        .delete()
                        .eq('id', ratingId);
                    
                    if (error) throw error;
                    
                    await loadRatings(marketId);
                    alert('تم حذف التقييم بنجاح!');
                    
                } catch (error) {
                    console.error('خطأ في حذف التقييم:', error);
                    alert('حدث خطأ في حذف التقييم');
                }
            };
            
            function showError(title, details) {
                document.getElementById('market-details').style.display = 'none';
                document.querySelector('.ratings-section').style.display = 'none';
                
                const errorDiv = document.getElementById('error-message');
                document.getElementById('error-title').textContent = title;
                document.getElementById('error-details').textContent = details;
                errorDiv.style.display = 'block';
            }
            
            function showRatingsError(message) {
                const ratingsList = document.getElementById('ratingsList');
                ratingsList.innerHTML = `
                    <div class="no-ratings">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>${message}</p>
                    </div>
                `;
            }
            
            function getInitials(text) {
                if (!text || text.trim() === '') return 'ز';
                const words = text.trim().split(' ');
                if (words.length >= 2) {
                    return (words[0][0] + words[1][0]).toUpperCase();
                }
                return text.substring(0, 2).toUpperCase();
            }
            
            function formatDate(dateString) {
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('ar-SA', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch {
                    return 'تاريخ غير معروف';
                }
            }
            
            function generateStarRating(rating) {
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    stars += i <= rating ? '★' : '☆';
                }
                return stars;
            }
            
            function getUserInfo() {
                return window.getUserInfo();
            }
            
            function updateUserName(name) {
                return window.updateUserName(name);
            }
        });
    </script>
</body>
</html>

