<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ø³ÙŠØ§Ø­ÙŠØ©</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Supabase SDK -->
<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ğŸ”— Ø±Ø§Ø¨Ø· Ù…Ø´Ø±ÙˆØ¹Ùƒ
    const supabaseUrl = "https://gxuumjhtutkipvkljjhj.supabase.co";
    // ğŸ”‘ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… (anon key)
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4dXVtamh0dXRraXB2a2xqamhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NTM2MzEsImV4cCI6MjA4MTEyOTYzMX0.rmsSRTQ57cAJ3VAiQMe0mdxEYcERh6zQDep7DN_frFI";

    // ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase
    window.supabase = createClient(supabaseUrl, supabaseKey);
</script>

<style>
  :root {
    --market-primary: #2e7d32;
    --market-secondary: #43a047;
    --market-light: #66bb6a;
    --market-dark: #1b5e20;
  }

  * { 
    margin:0; padding:0; box-sizing:border-box;
    font-family:'Cairo', sans-serif;
  }

  body {
    background:#f1f8e9;
    display:flex;
    justify-content:center;
    padding:0;
    min-height: 100vh;
  }

  .container {
    width:100%;
    max-width:400px;
    padding:12px;
  }

  .back-btn{
    display:inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--market-dark);
    color:#fff;
    padding:10px 16px;
    border-radius:10px;
    text-decoration:none;
    font-size:15px;
    margin-bottom:15px;
    transition: all 0.3s ease;
    box-shadow: 0 3px 8px rgba(43, 108, 46, 0.3);
  }

  .back-btn:hover {
    background: var(--market-primary);
    transform: translateX(-3px);
    box-shadow: 0 5px 12px rgba(43, 108, 46, 0.4);
  }

  h1 {
    text-align:center;
    color: var(--market-primary);
    margin-bottom:20px;
    font-size:24px;
    font-weight:800;
    position: relative;
    padding-bottom: 10px;
  }

  h1::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 50%;
    transform: translateX(50%);
    width: 80px;
    height: 3px;
    background: var(--market-secondary);
    border-radius: 2px;
  }

  /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
  .loading-container {
    text-align: center;
    padding: 40px 20px;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(46, 125, 50, 0.2);
    border-radius: 50%;
    border-top-color: var(--market-primary);
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-text {
    color: var(--market-primary);
    font-size: 16px;
    font-weight: 600;
  }

  .card {
    background:white;
    width:100%;
    padding:20px;
    border-radius:16px;
    margin-bottom:16px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    transition:0.3s;
    border: 1px solid rgba(46, 125, 50, 0.1);
  }

  .card:hover { 
    transform:translateY(-5px); 
    box-shadow:0 8px 20px rgba(0,0,0,0.15);
    border-color: rgba(46, 125, 50, 0.2);
  }

  .market-imgcircle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    display: block;
    margin: 0 auto 15px auto;
    border: 4px solid var(--market-secondary);
    box-shadow: 0 4px 10px rgba(67, 160, 71, 0.2);
    transition: all 0.3s ease;
  }

  .card:hover .market-imgcircle {
    border-color: var(--market-primary);
    transform: scale(1.05);
  }

  .market-title {
    font-size:20px;
    font-weight:800;
    color: var(--market-primary);
    margin-bottom:12px;
    text-align:center;
    line-height: 1.4;
  }

  .info {
    color:#333;
    font-size:15px;
    margin-bottom:8px;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .info i {
    color: var(--market-secondary);
    font-size: 16px;
    margin-top: 2px;
    min-width: 20px;
  }

  .info b {
    color: var(--market-dark);
    min-width: 70px;
    display: inline-block;
  }

  .btn {
    display:flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width:100%;
    padding:12px;
    margin-top:15px;
    background: var(--market-primary);
    color:white;
    text-align:center;
    font-size:16px;
    border-radius:10px;
    text-decoration:none;
    font-weight:600;
    transition: all 0.3s ease;
    box-shadow: 0 3px 8px rgba(46, 125, 50, 0.3);
  }

  .btn:hover {
    background: var(--market-dark);
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(46, 125, 50, 0.4);
  }

  .image-placeholder {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--market-secondary), var(--market-primary));
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px auto;
    border: 4px solid var(--market-secondary);
  }

  .image-placeholder i {
    font-size: 40px;
    color: white;
    opacity: 0.9;
  }

  /* Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin: 20px 0;
  }

  .empty-icon {
    font-size: 60px;
    color: var(--market-primary);
    margin-bottom: 20px;
    opacity: 0.6;
  }

  .empty-state h3 {
    color: var(--market-primary);
    font-size: 22px;
    margin-bottom: 10px;
    font-weight: 800;
  }

  .empty-state p {
    color: #666;
    font-size: 16px;
    line-height: 1.6;
  }

  /* Ø§Ù„ÙÙˆØªØ± */
  .footer {
    text-align: center;
    margin-top: 30px;
    padding: 20px 0;
    color: #666;
    font-size: 14px;
    border-top: 1px solid rgba(46, 125, 50, 0.1);
  }

  .market-count {
    background: rgba(46, 125, 50, 0.1);
    color: var(--market-primary);
    padding: 6px 15px;
    border-radius: 50px;
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 10px;
    display: inline-block;
  }

  @media (max-width: 480px) {
    .container {
      padding: 10px;
    }
    
    .card {
      padding: 16px;
    }
    
    .market-imgcircle {
      width: 90px;
      height: 90px;
    }
    
    .image-placeholder {
      width: 90px;
      height: 90px;
    }
    
    .market-title {
      font-size: 18px;
    }
  }
</style>
</head>

<body>

<div class="container">

  <a href="index1.html" class="back-btn">
    <i class="fas fa-arrow-right"></i>
    Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  </a>

  <h1>ğŸ›ï¸ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚</h1>

  <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  <div id="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚...</p>
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ -->
  <div id="markets"></div>

  <!-- Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© -->
  <div id="empty-state" class="empty-state" style="display: none;">
    <div class="empty-icon">
      <i class="fas fa-store"></i>
    </div>
    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³ÙˆØ§Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
    <p>Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£Ø³ÙˆØ§Ù‚ Ø³ÙŠØ§Ø­ÙŠØ© Ø¨Ø¹Ø¯. Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ù‡Ù†Ø§ ÙÙˆØ± Ø¥Ø¶Ø§ÙØªÙ‡Ø§.</p>
  </div>

  <!-- Ø§Ù„ÙÙˆØªØ± -->
  <footer class="footer">
    <div class="market-count" id="market-count">0 Ø³ÙˆÙ‚</div>
    <p>Ø§Ø³ØªÙƒØ´Ù Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ ÙˆØ§Ù„ØªØ³ÙˆÙ‚ ÙÙŠ Ø´Ø¨ÙˆØ©</p>
    <p style="margin-top: 10px; font-size: 13px; opacity: 0.7;">
      Â© 2025 - Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ø³ÙŠØ§Ø­ÙŠØ©
    </p>
  </footer>

</div>

<script>
  document.addEventListener('DOMContentLoaded', async function() {
    await loadMarkets();
    
    async function loadMarkets() {
      const marketsContainer = document.getElementById('markets');
      const loading = document.getElementById('loading');
      const emptyState = document.getElementById('empty-state');
      const marketCount = document.getElementById('market-count');
      
      try {
        // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Supabase
        await waitForSupabase();
        
        if (!window.supabase) {
          throw new Error('Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±');
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ù…Ù† Supabase
        const { data: markets, error } = await window.supabase
          .from('tourism_markets')
          .select('*')
          .order('created_at', { ascending: false });
        
        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loading.style.display = 'none';
        
        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚:', error);
          showEmptyState('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚');
          return;
        }
        
        if (!markets || markets.length === 0) {
          showEmptyState('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³ÙˆØ§Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹');
          return;
        }
        
        // Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚
        marketCount.textContent = `${markets.length} Ø³ÙˆÙ‚${markets.length > 1 ? 'Ø§Øª' : ''}`;
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚
        markets.forEach((market, index) => {
          const card = createMarketCard(market, index);
          marketsContainer.appendChild(card);
        });
        
      } catch (error) {
        console.error('Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', error);
        loading.style.display = 'none';
        showEmptyState('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚');
      }
    }
    
    function createMarketCard(market, index) {
      const card = document.createElement('div');
      card.className = 'card';
      
      // ØªØ£Ø®ÙŠØ± Ø¸Ù‡ÙˆØ± Ø§Ù„ÙƒØ±ÙˆØª
      card.style.animationDelay = `${index * 0.1}s`;
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const name = market.name || 'Ø³ÙˆÙ‚ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
      const location = market.location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const working_hours = market.working_hours || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const description = market.description || '';
      const specialties = market.specialties || '';
      const imageUrl = market.image || null;
      const id = market.id;
      const phone = market.phone || '';
      const rating = market.rating || 0;
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØ§Ø±Øª
      card.innerHTML = `
        <div class="market-image-container">
          ${imageUrl ? 
            `<img src="${imageUrl}" alt="${name}" class="market-imgcircle" loading="lazy">` :
            `<div class="image-placeholder">
                <i class="fas fa-store"></i>
            </div>`
          }
        </div>
        
        <div class="market-title">${name}</div>
        
        <div class="market-info">
          <p class="info">
            <i class="fas fa-map-marker-alt"></i>
            <b>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b> ${location}
          </p>
          
          ${working_hours ? `
          <p class="info">
            <i class="fas fa-clock"></i>
            <b>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„:</b> ${working_hours}
          </p>
          ` : ''}
          
          ${phone ? `
          <p class="info">
            <i class="fas fa-phone"></i>
            <b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${phone}
          </p>
          ` : ''}
          
          ${specialties ? `
          <p class="info">
            <i class="fas fa-tags"></i>
            <b>Ø§Ù„ØªØ®ØµØµØ§Øª:</b> ${truncateText(specialties, 50)}
          </p>
          ` : ''}
          
          ${description ? `
          <p class="info">
            <i class="fas fa-info-circle"></i>
            <b>Ø§Ù„ÙˆØµÙ:</b> ${truncateText(description, 60)}
          </p>
          ` : ''}
          
          ${rating > 0 ? `
          <p class="info">
            <i class="fas fa-star"></i>
            <b>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</b> ${rating.toFixed(1)} / 5
          </p>
          ` : ''}
        </div>
        
        <a class="btn" href="market-details.html?id=${id}">
          <span>Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
          <i class="fas fa-arrow-left"></i>
        </a>
      `;
      
      return card;
    }
    
    function showEmptyState(message) {
      document.getElementById('empty-state').style.display = 'block';
      document.getElementById('empty-state').querySelector('h3').textContent = message;
    }
    
    function truncateText(text, maxLength) {
      if (!text) return '';
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }
    
    async function waitForSupabase() {
      let attempts = 0;
      const maxAttempts = 10;
      
      return new Promise((resolve, reject) => {
        const checkSupabase = () => {
          attempts++;
          if (window.supabase) {
            resolve();
          } else if (attempts >= maxAttempts) {
            reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Supabase'));
          } else {
            setTimeout(checkSupabase, 500);
          }
        };
        checkSupabase();
      });
    }
  });
</script>

</body>
</html>