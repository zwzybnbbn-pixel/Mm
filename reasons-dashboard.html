<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
body {
  background: #f8f9fa;
  font-family: 'Cairo', sans-serif;
  padding: 20px;
  margin: 0;
}

h2 {
  text-align: center;
  margin-bottom: 25px;
  color: #333;
  font-weight: 800;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  border: 1px solid #e0e0e0;
}

.input {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin: 8px 0;
  font-family: 'Cairo', sans-serif;
  font-size: 16px;
  resize: vertical;
}

.input:focus {
  outline: none;
  border-color: #1f6feb;
  box-shadow: 0 0 0 2px rgba(31, 111, 235, 0.1);
}

.btn {
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Cairo', sans-serif;
  font-weight: 600;
  font-size: 16px;
  transition: all 0.2s;
}

.addBtn { 
  background: #28a745; 
  color: white; 
  width: 100%; 
  margin-top: 10px;
}
.addBtn:hover { background: #218838; }

.save { 
  background: #007bff; 
  color: white; 
  margin-right: 8px;
}
.save:hover { background: #0056b3; }

.delete { 
  background: #dc3545; 
  color: white; 
}
.delete:hover { background: #c82333; }

.cancel {
  background: #6c757d;
  color: white;
  margin-right: 8px;
}
.cancel:hover { background: #545b62; }

.date {
  color: #666;
  font-size: 14px;
  margin: 5px 0 15px 0;
}

hr {
  border: none;
  border-top: 2px solid #ddd;
  margin: 25px 0;
}

.alert {
  padding: 12px;
  border-radius: 8px;
  margin: 10px 0;
  text-align: center;
  font-weight: 600;
}

.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.loading {
  text-align: center;
  padding: 20px;
  color: #666;
}

/* Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ */
.auth-check {
  display: none;
  text-align: center;
  padding: 40px;
  background: white;
  border-radius: 12px;
  margin: 50px auto;
  max-width: 400px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.auth-check h3 {
  color: #dc3545;
  margin-bottom: 20px;
}

.auth-check a {
  color: #007bff;
  text-decoration: none;
}
</style>
</head>

<body>

<!-- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ - Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ -->
<div id="authCheck" class="auth-check">
  <h3>ğŸ” ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„</h3>
  <p>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©</p>
  <a href="login.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
</div>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚) -->
<div id="mainContent" style="display: none;">

<h2>âš  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ø¥Ø¯Ø§Ø±Ø© Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹</h2>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø³Ø¨Ø¨ Ø¬Ø¯ÙŠØ¯ -->
<div class="card">
  <h3>â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¨Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
  <textarea id="new-reason" class="input" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹..."></textarea>
  <div style="display: flex; gap: 10px;">
    <input type="text" id="new-details" class="input" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <input type="text" id="new-areas" class="input" placeholder="Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØªØ£Ø«Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  </div>
  <input type="text" id="new-time" class="input" placeholder="Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ø¥ØµÙ„Ø§Ø­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <select id="new-status" class="input" style="width: auto; min-width: 200px;">
    <option value="Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­">Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
    <option value="ØªÙ… Ø§Ù„Ø­Ù„">ØªÙ… Ø§Ù„Ø­Ù„</option>
    <option value="Ù…Ø¤Ø¬Ù„">Ù…Ø¤Ø¬Ù„</option>
  </select>
  <button class="btn addBtn" id="addBtn">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¨Ø¨</button>
</div>

<hr><br>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ -->
<h3>ğŸ“‹ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù…Ø¶Ø§ÙØ©</h3>
<div id="list" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

</div>

<!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
<div id="alertContainer"></div>

<script type="module">
// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Supabase
import { supabase } from './supabase.js';

// Ø¹Ù†Ø§ØµØ± DOM
const authCheck = document.getElementById('authCheck');
const mainContent = document.getElementById('mainContent');
const list = document.getElementById('list');
const alertContainer = document.getElementById('alertContainer');

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
function showAlert(message, type = 'success') {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert ${type}`;
  alertDiv.textContent = message;
  alertContainer.appendChild(alertDiv);
  
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
  setTimeout(() => {
    alertDiv.remove();
  }, 3000);
}

// =========================
// ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
// =========================
async function checkAuth() {
  try {
    const { data: { session }, error } = await supabase.auth.getSession();
    
    if (error || !session) {
      authCheck.style.display = 'block';
      mainContent.style.display = 'none';
      return false;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù…Ùƒ)
    // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù†Ø§
    const user = session.user;
    console.log('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„:', user.email);
    
    authCheck.style.display = 'none';
    mainContent.style.display = 'block';
    return true;
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', error);
    authCheck.style.display = 'block';
    mainContent.style.display = 'none';
    return false;
  }
}

// =========================
// â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¨Ø¨ Ø¬Ø¯ÙŠØ¯
// =========================
document.getElementById('addBtn').onclick = async () => {
  const text = document.getElementById('new-reason').value.trim();
  const details = document.getElementById('new-details').value.trim();
  const areas = document.getElementById('new-areas').value.trim();
  const time = document.getElementById('new-time').value.trim();
  const status = document.getElementById('new-status').value;

  if (!text) {
    showAlert('â— ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', 'error');
    return;
  }

  try {
    const newReason = {
      text,
      details: details || null,
      affected_areas: areas || null,
      estimated_time: time || null,
      status: status || 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­',
      updated_at: new Date().toISOString(),
      created_at: new Date().toISOString()
    };

    const { data, error } = await supabase
      .from('reasons')
      .insert([newReason])
      .select();

    if (error) throw error;

    showAlert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¨Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('new-reason').value = '';
    document.getElementById('new-details').value = '';
    document.getElementById('new-areas').value = '';
    document.getElementById('new-time').value = '';
    
    loadData();
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¨Ø¨:', error);
    showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¨Ø¨', 'error');
  }
};

// =========================
// ğŸ“Œ Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨
// =========================
async function loadData() {
  list.innerHTML = '<div class="loading">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>';

  try {
    const { data: reasons, error } = await supabase
      .from('reasons')
      .select('*')
      .order('updated_at', { ascending: false });

    if (error) throw error;

    if (!reasons || reasons.length === 0) {
      list.innerHTML = '<div class="card"><p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¨Ø§Ø¨ Ù…Ø³Ø¬Ù„Ø©</p></div>';
      return;
    }

    let html = '';

    reasons.forEach(reason => {
      const date = reason.updated_at 
        ? new Date(reason.updated_at).toLocaleString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })
        : 'â€”';

      html += `
        <div class="card" id="reason-${reason.id}">
          <label><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong></label>
          <textarea class="input reason-text" rows="3" data-id="${reason.id}">${reason.text || ''}</textarea>
          
          ${reason.details ? `<p><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${reason.details}</p>` : ''}
          ${reason.affected_areas ? `<p><strong>Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:</strong> ${reason.affected_areas}</p>` : ''}
          ${reason.estimated_time ? `<p><strong>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</strong> ${reason.estimated_time}</p>` : ''}
          
          <div style="margin: 10px 0;">
            <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
            <select class="input status-select" data-id="${reason.id}" style="width: auto; min-width: 150px; margin-right: 10px;">
              <option value="Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­" ${reason.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
              <option value="ØªÙ… Ø§Ù„Ø­Ù„" ${reason.status === 'ØªÙ… Ø§Ù„Ø­Ù„' ? 'selected' : ''}>ØªÙ… Ø§Ù„Ø­Ù„</option>
              <option value="Ù…Ø¤Ø¬Ù„" ${reason.status === 'Ù…Ø¤Ø¬Ù„' ? 'selected' : ''}>Ù…Ø¤Ø¬Ù„</option>
            </select>
          </div>
          
          <p class="date"><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> ${date}</p>
          
          <div>
            <button class="btn save" onclick="saveReason('${reason.id}')">ğŸ’¾ Ø­ÙØ¸</button>
            <button class="btn delete" onclick="deleteReason('${reason.id}')">ğŸ—‘ Ø­Ø°Ù</button>
          </div>
        </div>
      `;
    });

    list.innerHTML = html;
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    list.innerHTML = '<div class="alert error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
  }
}

// =========================
// ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø³Ø¨Ø¨
// =========================
window.saveReason = async (id) => {
  try {
    const textElement = document.querySelector(`.reason-text[data-id="${id}"]`);
    const statusElement = document.querySelector(`.status-select[data-id="${id}"]`);
    
    if (!textElement || !statusElement) return;

    const text = textElement.value.trim();
    const status = statusElement.value;

    if (!text) {
      showAlert('â— Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„Ø³Ø¨Ø¨ ÙØ§Ø±Øº', 'error');
      return;
    }

    const updates = {
      text,
      status,
      updated_at: new Date().toISOString()
    };

    const { error } = await supabase
      .from('reasons')
      .update(updates)
      .eq('id', id);

    if (error) throw error;

    showAlert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¨Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    
    // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const dateElement = document.querySelector(`#reason-${id} .date`);
    if (dateElement) {
      const now = new Date().toLocaleString('ar-EG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      dateElement.innerHTML = `<strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> ${now}`;
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¨Ø¨:', error);
    showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error');
  }
};

// =========================
// ğŸ—‘ Ø­Ø°Ù Ø³Ø¨Ø¨
// =========================
window.deleteReason = async (id) => {
  if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¨Ø¨ØŸ')) {
    return;
  }

  try {
    const { error } = await supabase
      .from('reasons')
      .delete()
      .eq('id', id);

    if (error) throw error;

    showAlert('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¨Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const element = document.getElementById(`reason-${id}`);
    if (element) {
      element.style.opacity = '0.5';
      setTimeout(() => {
        element.remove();
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ¨Ù‚Ù‰ Ø¹Ù†Ø§ØµØ±ØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
        if (list.children.length === 0) {
          list.innerHTML = '<div class="card"><p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¨Ø§Ø¨ Ù…Ø³Ø¬Ù„Ø©</p></div>';
        }
      }, 300);
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¨Ø¨:', error);
    showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
  }
};

// =========================
// ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
// =========================
async function init() {
  const isAuthenticated = await checkAuth();
  
  if (isAuthenticated) {
    loadData();
    
    // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
    const channel = supabase
      .channel('realtime-dashboard')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'reasons'
        },
        () => {
          loadData();
        }
      )
      .subscribe();
  }
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
init();
</script>

</body>
</html>