<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ â€“ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø¹ØªÙ‚</title>

<!-- ğŸ”§ CSP Ù…Ø¹Ø¯Ù„ - ÙŠØ³Ù…Ø­ Ø¨Ù…Ø§ Ù‡Ùˆ Ø¶Ø±ÙˆØ±ÙŠ ÙÙ‚Ø· -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://*.supabase.co;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  connect-src 'self' https://*.supabase.co;
  img-src 'self' data:;
  frame-src 'none';
">

<!-- Ø±Ø¤ÙˆØ³ Ø£Ù…Ø§Ù† Ø£Ø³Ø§Ø³ÙŠØ© -->
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo',sans-serif;}
body{background:linear-gradient(to bottom,#0a0a0a,#111,#1a1a1a,#222);min-height:100vh;color:white;padding:15px;}
header{text-align:center;margin-bottom:25px;}
header h2{font-size:32px;font-weight:800;color:#1f6feb;}
#reason-box{display:flex;flex-direction:column;gap:16px;max-width:650px;margin:0 auto;}
.item{background:rgba(255,255,255,0.07);padding:18px;border-radius:16px;backdrop-filter:blur(5px);box-shadow:0 6px 18px rgba(0,0,0,0.45);border:1px solid #30363d;transition:0.25s;}
.item:hover{background:rgba(255,255,255,0.12);transform:translateY(-3px);}
.item p{font-size:18px;margin-bottom:8px;line-height:1.6;}
.item strong{color:#1f6feb;font-weight:700;}
.item small{font-size:14px;opacity:.8;display:block;margin-top:10px;color:#aaa;}
.back-btn{display:block;width:100%;max-width:250px;margin:25px auto;background:#1f6feb;color:white;text-align:center;padding:12px;font-size:18px;text-decoration:none;font-weight:700;border-radius:14px;transition:0.2s;border:none;cursor:pointer;}
.back-btn:hover{background:#2b7fff;transform:scale(1.05);}
.no-data{text-align:center;padding:30px;font-size:18px;color:#aaa;background:rgba(255,255,255,0.05);border-radius:12px;border:1px dashed #444;}
.error-message{text-align:center;padding:30px;font-size:18px;color:#ff6b6b;background:rgba(255,107,107,0.1);border-radius:12px;border:1px solid #ff6b6b;}
.loader{border:4px solid rgba(255,255,255,0.1);border-top:4px solid #1f6feb;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.error-btn{background:#1f6feb;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin-top:15px;font-family:inherit;}
.debug-panel{background:rgba(0,0,0,0.3);padding:10px;border-radius:5px;margin-top:10px;font-size:12px;}
</style>
</head>
<body>

<header>
  <h2>âš¡ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹</h2>
  <p style="text-align:center; opacity:0.8; margin-top:10px;">Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
</header>

<div id="reason-box">
  <div class="loader"></div>
  <p style="text-align:center; opacity:0.7;">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
</div>

<a href="index2.html" class="back-btn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

<script>
// ==================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¢Ù…Ù†Ø© ====================
console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');

// Ø¨ÙŠØ§Ù†Ø§Øª Supabase - Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©
const SUPABASE_CONFIG = {
    url: 'https://gxuumjhtutkipvkljjhj.supabase.co',
    key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4dXVtamh0dXRraXB2a2xqamhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NTM2MzEsImV4cCI6MjA4MTEyOTYzMX0.rmsSRTQ57cAJ3VAiQMe0mdxEYcERh6zQDep7DN_frFI'
};

const box = document.getElementById('reason-box');
let supabaseClient = null;

// ğŸ”§ Ù†Ø¸Ø§Ù… ØªØ´Ø®ÙŠØµ
function logStatus(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ”';
    console.log(`${icon} [${timestamp}] ${message}`);
}

// ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Supabase
async function initializeSupabase() {
    try {
        logStatus('Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙƒØªØ¨Ø© Supabase...');
        
        if (!window.supabase || !window.supabase.createClient) {
            logStatus('Ù…ÙƒØªØ¨Ø© Supabase ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...');
            
            // Ø§Ù†ØªØ¸Ø± 3 Ø«ÙˆØ§Ù†ÙŠ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            if (!window.supabase) {
                throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Supabase. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
            }
        }
        
        logStatus('Ù…ÙƒØªØ¨Ø© Supabase Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„...');
        
        const { createClient } = window.supabase;
        supabaseClient = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
        
        logStatus('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase Ø¨Ù†Ø¬Ø§Ø­');
        return true;
        
    } catch (error) {
        logStatus(`Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Supabase: ${error.message}`, 'error');
        return false;
    }
}

// ğŸ”§ Ø¯Ø§Ù„Ø© Ø¢Ù…Ù†Ø© Ù„ØªØ·Ù‡ÙŠØ± Ø§Ù„Ù†Øµ
function sanitizeText(text) {
    if (!text) return '';
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… textContent Ù„Ù…Ù†Ø¹ XSS
    const div = document.createElement('div');
    div.textContent = String(text);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø¨ÙŠØ« Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
    return div.innerHTML
        .replace(/javascript:/gi, '')
        .replace(/data:/gi, '')
        .replace(/on\w+\s*=/gi, '');
}

// ğŸ”§ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function loadReasons() {
    try {
        logStatus('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        if (!navigator.onLine) {
            throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Supabase
        if (!supabaseClient) {
            const initialized = await initializeSupabase();
            if (!initialized) {
                throw new Error('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }
        
        logStatus('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase...');
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù‡Ù„Ø© Ù„Ù„Ø·Ù„Ø¨
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const { data: reasons, error } = await supabaseClient
                .from('reasons')
                .select('*')
                .order('updated_at', { ascending: false })
                .limit(50);
            
            clearTimeout(timeoutId);
            
            if (error) {
                logStatus(`Ø®Ø·Ø£ Ù…Ù† Supabase: ${error.message}`, 'error');
                throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
            }
            
            logStatus(`ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ${reasons?.length || 0} Ø³Ø¨Ø¨`);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            displayReasons(reasons);
            
        } catch (fetchError) {
            clearTimeout(timeoutId);
            throw fetchError;
        }
        
    } catch (error) {
        logStatus(`Ø®Ø·Ø£: ${error.message}`, 'error');
        showError(error);
    }
}

// ğŸ”§ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø©)
function displayReasons(reasons) {
    // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    box.innerHTML = '';
    
    if (!reasons || reasons.length === 0) {
        const noDataDiv = document.createElement('div');
        noDataDiv.className = 'no-data';
        
        const message = document.createElement('p');
        message.textContent = 'ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¨Ø§Ø¨ Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹';
        noDataDiv.appendChild(message);
        
        const subMessage = document.createElement('small');
        subMessage.textContent = 'Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
        noDataDiv.appendChild(subMessage);
        
        box.appendChild(noDataDiv);
        return;
    }
    
    // Ø¹Ø±Ø¶ ÙƒÙ„ Ø³Ø¨Ø¨
    reasons.forEach((reason, index) => {
        // Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„
        if (index === 1) {
            const separator = document.createElement('div');
            separator.textContent = 'â€”â€”â€” Ø£Ø³Ø¨Ø§Ø¨ Ø³Ø§Ø¨Ù‚Ø© â€”â€”â€”';
            separator.style.cssText = 'text-align:center; margin:20px 0; color:#666; font-size:14px;';
            box.appendChild(separator);
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ±
        const item = document.createElement('div');
        item.className = 'item';
        
        // Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        addField(item, 'Ø§Ù„Ø³Ø¨Ø¨:', reason.text);
        
        // Ø§Ù„ØªÙØ§ØµÙŠÙ„
        if (reason.details) {
            addField(item, 'Ø§Ù„ØªÙØ§ØµÙŠÙ„:', reason.details, 'details');
        }
        
        // Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©
        if (reason.affected_areas) {
            addField(item, 'Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:', reason.affected_areas, 'areas');
        }
        
        // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
        if (reason.estimated_time) {
            const timeField = document.createElement('p');
            timeField.style.cssText = 'margin-top:8px; color:#4ecdc4;';
            
            const strong = document.createElement('strong');
            strong.textContent = 'Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ø¥ØµÙ„Ø§Ø­: ';
            timeField.appendChild(strong);
            
            const text = document.createTextNode(sanitizeText(reason.estimated_time));
            timeField.appendChild(text);
            
            item.appendChild(timeField);
        }
        
        // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«
        const updateField = document.createElement('small');
        const updateStrong = document.createElement('strong');
        updateStrong.textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ';
        updateField.appendChild(updateStrong);
        
        try {
            const date = new Date(reason.updated_at);
            updateField.appendChild(document.createTextNode(
                date.toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            ));
        } catch {
            updateField.appendChild(document.createTextNode('â€”'));
        }
        item.appendChild(updateField);
        
        // Ø§Ù„Ø­Ø§Ù„Ø©
        if (reason.status) {
            const statusField = document.createElement('small');
            statusField.style.display = 'block';
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ†
            const colors = {
                'ØªÙ… Ø§Ù„Ø­Ù„': '#2ecc71',
                'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©': '#3498db',
                'Ù…Ø¹Ù„Ù‚': '#e74c3c',
                'ØªØ­Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø©': '#9b59b6'
            };
            
            statusField.style.color = colors[reason.status] || '#f39c12';
            
            const statusStrong = document.createElement('strong');
            statusStrong.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: ';
            statusField.appendChild(statusStrong);
            
            statusField.appendChild(document.createTextNode(sanitizeText(reason.status)));
            item.appendChild(statusField);
        }
        
        box.appendChild(item);
    });
    
    // Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    const counter = document.createElement('div');
    counter.style.cssText = 'text-align:center; margin-top:20px; color:#666; font-size:14px;';
    counter.textContent = `Ø¹Ø±Ø¶ ${reasons.length} Ø³Ø¨Ø¨`;
    box.appendChild(counter);
}

// ğŸ”§ Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„
function addField(container, label, value, className = '') {
    if (!value) return;
    
    const field = document.createElement('p');
    if (className) field.className = className;
    field.style.marginTop = '8px';
    
    const strong = document.createElement('strong');
    strong.textContent = label + ' ';
    field.appendChild(strong);
    
    field.appendChild(document.createTextNode(sanitizeText(value)));
    container.appendChild(field);
}

// ğŸ”§ Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£
function showError(error) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    
    const title = document.createElement('p');
    title.textContent = 'âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    errorDiv.appendChild(title);
    
    const message = document.createElement('small');
    message.textContent = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    errorDiv.appendChild(message);
    
    const retryBtn = document.createElement('button');
    retryBtn.className = 'error-btn';
    retryBtn.textContent = 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
    retryBtn.onclick = () => {
        box.innerHTML = '<div class="loader"></div><p style="text-align:center; opacity:0.7;">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>';
        setTimeout(loadReasons, 1000);
    };
    errorDiv.appendChild(retryBtn);
    
    // Ù„ÙˆØ­Ø© ØªØ´Ø®ÙŠØµ
    const debugPanel = document.createElement('div');
    debugPanel.className = 'debug-panel';
    debugPanel.innerHTML = `
        <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ:</strong><br>
        â€¢ Ø§Ù„Ø§ØªØµØ§Ù„: ${navigator.onLine ? 'âœ…' : 'âŒ'}<br>
        â€¢ Supabase: ${supabaseClient ? 'âœ…' : 'âŒ'}<br>
        â€¢ Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleTimeString()}
    `;
    errorDiv.appendChild(debugPanel);
    
    box.innerHTML = '';
    box.appendChild(errorDiv);
}

// ==================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====================
document.addEventListener('DOMContentLoaded', async () => {
    logStatus('Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...');
    
    // ØªÙ‡ÙŠØ¦Ø© Supabase Ø£ÙˆÙ„Ø§Ù‹
    const initialized = await initializeSupabase();
    
    if (initialized) {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© Ù†Ø§Ø¬Ø­Ø©
        setTimeout(loadReasons, 500);
        
        // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ
        setInterval(() => {
            if (!document.hidden && navigator.onLine) {
                loadReasons();
            }
        }, 60000); // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
    } else {
        showError(new Error('ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…'));
    }
});

// ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø©
document.addEventListener('visibilitychange', () => {
    if (!document.hidden && supabaseClient) {
        logStatus('Ø§Ù„ØµÙØ­Ø© Ø£ØµØ¨Ø­Øª Ù…Ø±Ø¦ÙŠØ©ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        loadReasons();
    }
});

// ØªØµØ¯ÙŠØ± Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
window.App = {
    loadReasons,
    sanitizeText,
    getStatus: () => ({
        online: navigator.onLine,
        supabase: !!supabaseClient,
        url: SUPABASE_CONFIG.url ? 'âœ…' : 'âŒ'
    })
};
</script>
</body>
</html>
