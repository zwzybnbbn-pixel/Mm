<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ â€“ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø¹ØªÙ‚</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo',sans-serif;}

/* Ù†ÙØ³ Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
body{
  background:linear-gradient(to bottom,#0a0a0a,#111,#1a1a1a,#222);
  min-height:100vh;
  color:white;
  padding:15px;
}

/* Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© */
header{
  text-align:center;
  margin-bottom:25px;
}

header h2{
  font-size:32px;
  font-weight:800;
  color:#1f6feb;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ */
#reason-box{
  display:flex;
  flex-direction:column;
  gap:16px;
  max-width:650px;
  margin:0 auto;
}

/* Ù†ÙØ³ ØªØµÙ…ÙŠÙ… Ø§Ù„ÙƒØ±ÙˆØª ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.item{
  background:rgba(255,255,255,0.07);
  padding:18px;
  border-radius:16px;
  backdrop-filter:blur(5px);
  box-shadow:0 6px 18px rgba(0,0,0,0.45);
  border:1px solid #30363d;
  transition:0.25s;
}

.item:hover{
  background:rgba(255,255,255,0.12);
  transform:translateY(-3px);
}

.item p{
  font-size:18px;
  margin-bottom:8px;
  line-height:1.6;
}

.item strong{
  color:#1f6feb;
  font-weight:700;
}

.item small{
  font-size:14px;
  opacity:.8;
  display:block;
  margin-top:10px;
  color:#aaa;
}

/* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© */
.back-btn{
  display:block;
  width:100%;
  max-width:250px;
  margin:25px auto;
  background:#1f6feb;
  color:white;
  text-align:center;
  padding:12px;
  font-size:18px;
  text-decoration:none;
  font-weight:700;
  border-radius:14px;
  transition:0.2s;
  border:none;
  cursor:pointer;
}

.back-btn:hover{
  background:#2b7fff;
  transform:scale(1.05);
}

.no-data{
  text-align:center;
  padding:30px;
  font-size:18px;
  color:#aaa;
  background:rgba(255,255,255,0.05);
  border-radius:12px;
  border:1px dashed #444;
}

.error-message{
  text-align:center;
  padding:30px;
  font-size:18px;
  color:#ff6b6b;
  background:rgba(255,107,107,0.1);
  border-radius:12px;
  border:1px solid #ff6b6b;
}
</style>
</head>

<body>

<header>
  <h2>âš¡ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹</h2>
  <p style="text-align:center; opacity:0.8; margin-top:10px;">Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
</header>

<div id="reason-box">
  <p style="text-align:center; opacity:0.7;">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
</div>

<a href="index2.html" class="back-btn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

<script type="module">
// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Supabase Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
import { supabase } from './supabase.js';

const box = document.getElementById("reason-box");

// Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¨ÙŠ
function formatDate(dateString) {
  if (!dateString) return "â€”";
  
  try {
    const date = new Date(dateString);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® ØµØ§Ù„Ø­
    if (isNaN(date.getTime())) {
      return "ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­";
    }
    
    return date.toLocaleString("ar-EG", {
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  } catch (error) {
    console.error("Error formatting date:", error);
    return "â€”";
  }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹
async function loadReasons() {
  try {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯ÙˆÙ„ reasons ÙÙŠ Supabase
    const { data: reasons, error } = await supabase
      .from('reasons')
      .select('*')
      .order('updated_at', { ascending: false }); // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«

    if (error) {
      throw error;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
    if (!reasons || reasons.length === 0) {
      box.innerHTML = `
        <div class="no-data">
          <p>ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¨Ø§Ø¨ Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
          <small>Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</small>
        </div>
      `;
      return;
    }

    // Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    let html = '';
    
    reasons.forEach((reason, index) => {
      // Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„ Ù„Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£ÙˆÙ„)
      if (index === 1) {
        html += `<div style="text-align:center; margin:20px 0; color:#666; font-size:14px;">â€”â€”â€” Ø£Ø³Ø¨Ø§Ø¨ Ø³Ø§Ø¨Ù‚Ø© â€”â€”â€”</div>`;
      }
      
      html += `
        <div class="item">
          <p><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${reason.text || "â€”"}</p>
          ${reason.details ? `<p style="margin-top:8px;"><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${reason.details}</p>` : ''}
          ${reason.affected_areas ? `<p style="margin-top:8px;"><strong>Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:</strong> ${reason.affected_areas}</p>` : ''}
          ${reason.estimated_time ? `<p style="margin-top:8px; color:#4ecdc4;"><strong>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ø¥ØµÙ„Ø§Ø­:</strong> ${reason.estimated_time}</p>` : ''}
          <small><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> ${formatDate(reason.updated_at)}</small>
          ${reason.status ? `<small style="color:${reason.status === 'ØªÙ… Ø§Ù„Ø­Ù„' ? '#2ecc71' : '#f39c12'}"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${reason.status}</small>` : ''}
        </div>
      `;
    });

    box.innerHTML = html;

  } catch (error) {
    console.error("Error loading reasons:", error);
    box.innerHTML = `
      <div class="error-message">
        <p>âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
        <small>ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</small>
      </div>
    `;
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
function subscribeToRealtimeUpdates() {
  try {
    const channel = supabase
      .channel('reasons-updates')
      .on(
        'postgres_changes',
        {
          event: '*', // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (INSERT, UPDATE, DELETE)
          schema: 'public',
          table: 'reasons'
        },
        () => {
          // Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ±ØŒ Ø£Ø¹ÙØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
          loadReasons();
        }
      )
      .subscribe();

    // Ø¥Ø¶Ø§ÙØ© Channel Ø¥Ù„Ù‰ window Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
    window.reasonsChannel = channel;

  } catch (error) {
    console.error("Error setting up realtime subscription:", error);
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadReasons();

// Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
subscribeToRealtimeUpdates();

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
setInterval(() => {
  loadReasons();
}, 30000);
</script>

</body>
</html>
