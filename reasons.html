<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ â€“ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø¹ØªÙ‚</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://*.supabase.co; style-src 'self' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co;">

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo',sans-serif;}

body{
  background:linear-gradient(to bottom,#0a0a0a,#111,#1a1a1a,#222);
  min-height:100vh;
  color:white;
  padding:15px;
}

header{
  text-align:center;
  margin-bottom:25px;
}

header h2{
  font-size:32px;
  font-weight:800;
  color:#1f6feb;
}

#reason-box{
  display:flex;
  flex-direction:column;
  gap:16px;
  max-width:650px;
  margin:0 auto;
}

.item{
  background:rgba(255,255,255,0.07);
  padding:18px;
  border-radius:16px;
  backdrop-filter:blur(5px);
  box-shadow:0 6px 18px rgba(0,0,0,0.45);
  border:1px solid #30363d;
  transition:0.25s;
}

.item:hover{
  background:rgba(255,255,255,0.12);
  transform:translateY(-3px);
}

.item p{
  font-size:18px;
  margin-bottom:8px;
  line-height:1.6;
}

.item strong{
  color:#1f6feb;
  font-weight:700;
}

.item small{
  font-size:14px;
  opacity:.8;
  display:block;
  margin-top:10px;
  color:#aaa;
}

.back-btn{
  display:block;
  width:100%;
  max-width:250px;
  margin:25px auto;
  background:#1f6feb;
  color:white;
  text-align:center;
  padding:12px;
  font-size:18px;
  text-decoration:none;
  font-weight:700;
  border-radius:14px;
  transition:0.2s;
  border:none;
  cursor:pointer;
}

.back-btn:hover{
  background:#2b7fff;
  transform:scale(1.05);
}

.no-data{
  text-align:center;
  padding:30px;
  font-size:18px;
  color:#aaa;
  background:rgba(255,255,255,0.05);
  border-radius:12px;
  border:1px dashed #444;
}

.error-message{
  text-align:center;
  padding:30px;
  font-size:18px;
  color:#ff6b6b;
  background:rgba(255,107,107,0.1);
  border-radius:12px;
  border:1px solid #ff6b6b;
}

.loader {
  border: 4px solid rgba(255,255,255,0.1);
  border-top: 4px solid #1f6feb;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>

<body>

<header>
  <h2>âš¡ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹</h2>
  <p style="text-align:center; opacity:0.8; margin-top:10px;">Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
</header>

<div id="reason-box">
  <div class="loader"></div>
  <p style="text-align:center; opacity:0.7;">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
</div>

<a href="index2.html" class="back-btn">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

<script type="module">
// ğŸ”’ Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„ Ø¶Ø¯ Ø§Ù„Ù‡Ø¬Ù…Ø§Øª
const Security = {
    // ØªØ·Ù‡ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø§Ù„Ù‡Ø¬Ù…Ø§Øª XSS
    sanitize: function(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    },

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¨Ø¨
    validateReason: function(reason) {
        if (!reason || typeof reason !== 'object') return false;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (!reason.text || typeof reason.text !== 'string') return false;
        if (!reason.updated_at || typeof reason.updated_at !== 'string') return false;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·ÙˆÙ„ Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ù‡Ø¬Ù…Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ø®Ù…Ø©
        if (reason.text.length > 1000) return false;
        if (reason.details && reason.details.length > 2000) return false;
        if (reason.affected_areas && reason.affected_areas.length > 500) return false;
        
        return true;
    },

    // Ù…Ù†Ø¹ Ù‡Ø¬Ù…Ø§Øª Ø­Ù‚Ù† SQL/NoSQL (Ø·Ø¨Ù‚Ø© Ø¯ÙØ§Ø¹ÙŠØ©)
    sanitizeForDatabase: function(data) {
        const dangerousPatterns = [
            /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|UNION|ALTER|CREATE|EXEC|EXECUTE|MERGE|TRUNCATE)\b)/gi,
            /(\b(OR|AND)\s+['"]?\d+['"]?\s*[=<>]+\s*['"]?\d+['"]?)/gi,
            /(\b(true|false|null)\b)/gi,
            /(['";\\])/g,
            /(\-\-)|(#)/g
        ];
        
        let sanitized = String(data);
        dangerousPatterns.forEach(pattern => {
            sanitized = sanitized.replace(pattern, '');
        });
        
        return sanitized.trim();
    },

    // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ù‡Ø¬Ù…Ø§Øª CSRF
    generateCSRFToken: function() {
        const token = window.crypto.getRandomValues(new Uint32Array(1))[0].toString(16);
        sessionStorage.setItem('csrf_token', token);
        return token;
    },

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙƒÙ† CSRF
    verifyCSRFToken: function(token) {
        const storedToken = sessionStorage.getItem('csrf_token');
        return storedToken && storedToken === token;
    }
};

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Supabase Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
import { supabase } from './supabase.js';

const box = document.getElementById("reason-box");

// Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¨ÙŠ - Ø¢Ù…Ù†Ø©
function formatDate(dateString) {
    if (!dateString) return "â€”";
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "â€”";
        
        return new Intl.DateTimeFormat('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Africa/Cairo'
        }).format(date);
    } catch (error) {
        console.error("Error formatting date:", error);
        return "â€”";
    }
}

// ğŸ”’ Ø¯Ø§Ù„Ø© Ù…Ø­Ù…ÙŠØ© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function loadReasons() {
    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
        if (!navigator.onLine) {
            throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù„Ø© Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ù‡Ø¬Ù…Ø§Øª DDoS
        const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„')), 10000);
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø­Ù…Ø§ÙŠØ©
        const fetchPromise = supabase
            .from('reasons')
            .select('*')
            .order('updated_at', { ascending: false })
            .limit(100); // ØªØ­Ø¯ÙŠØ¯ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø­Ù…Ø§ÙŠØ©

        const { data: reasons, error } = await Promise.race([fetchPromise, timeoutPromise]);

        if (error) throw error;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!reasons || !Array.isArray(reasons)) {
            throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ø¢Ù…Ù†Ø©
        const safeReasons = reasons.filter(Security.validateReason);

        if (safeReasons.length === 0) {
            showNoData();
            return;
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø©
        displaySafeReasons(safeReasons);

    } catch (error) {
        console.error("Error loading reasons:", error);
        showError(error.message);
    }
}

// ğŸ”’ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© (Ø¨Ø¯ÙˆÙ† innerHTML)
function displaySafeReasons(reasons) {
    box.innerHTML = '';
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± DOM Ù…Ø¨Ø§Ø´Ø±Ø© (Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ø§Ù‹)
    reasons.forEach((reason, index) => {
        if (index === 1) {
            const separator = document.createElement('div');
            separator.textContent = 'â€”â€”â€” Ø£Ø³Ø¨Ø§Ø¨ Ø³Ø§Ø¨Ù‚Ø© â€”â€”â€”';
            separator.style.cssText = 'text-align:center; margin:20px 0; color:#666; font-size:14px;';
            box.appendChild(separator);
        }

        const item = document.createElement('div');
        item.className = 'item';
        
        // Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        const reasonText = document.createElement('p');
        const strongReason = document.createElement('strong');
        strongReason.textContent = 'Ø§Ù„Ø³Ø¨Ø¨: ';
        reasonText.appendChild(strongReason);
        reasonText.appendChild(document.createTextNode(Security.sanitize(reason.text)));
        item.appendChild(reasonText);
        
        // Ø§Ù„ØªÙØ§ØµÙŠÙ„
        if (reason.details) {
            const details = document.createElement('p');
            details.style.marginTop = '8px';
            const strongDetails = document.createElement('strong');
            strongDetails.textContent = 'Ø§Ù„ØªÙØ§ØµÙŠÙ„: ';
            details.appendChild(strongDetails);
            details.appendChild(document.createTextNode(Security.sanitize(reason.details)));
            item.appendChild(details);
        }
        
        // Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©
        if (reason.affected_areas) {
            const areas = document.createElement('p');
            areas.style.marginTop = '8px';
            const strongAreas = document.createElement('strong');
            strongAreas.textContent = 'Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©: ';
            areas.appendChild(strongAreas);
            areas.appendChild(document.createTextNode(Security.sanitize(reason.affected_areas)));
            item.appendChild(areas);
        }
        
        // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
        if (reason.estimated_time) {
            const time = document.createElement('p');
            time.style.marginTop = '8px';
            time.style.color = '#4ecdc4';
            const strongTime = document.createElement('strong');
            strongTime.textContent = 'Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ø¥ØµÙ„Ø§Ø­: ';
            time.appendChild(strongTime);
            time.appendChild(document.createTextNode(Security.sanitize(reason.estimated_time)));
            item.appendChild(time);
        }
        
        // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«
        const updateDate = document.createElement('small');
        const strongUpdate = document.createElement('strong');
        strongUpdate.textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ';
        updateDate.appendChild(strongUpdate);
        updateDate.appendChild(document.createTextNode(formatDate(reason.updated_at)));
        item.appendChild(updateDate);
        
        // Ø§Ù„Ø­Ø§Ù„Ø©
        if (reason.status) {
            const status = document.createElement('small');
            status.style.display = 'block';
            status.style.color = reason.status === 'ØªÙ… Ø§Ù„Ø­Ù„' ? '#2ecc71' : 
                               reason.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' ? '#f39c12' : '#e74c3c';
            const strongStatus = document.createElement('strong');
            strongStatus.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: ';
            status.appendChild(strongStatus);
            status.appendChild(document.createTextNode(Security.sanitize(reason.status)));
            item.appendChild(status);
        }
        
        box.appendChild(item);
    });
}

function showNoData() {
    const noDataDiv = document.createElement('div');
    noDataDiv.className = 'no-data';
    
    const message = document.createElement('p');
    message.textContent = 'ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¨Ø§Ø¨ Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹';
    noDataDiv.appendChild(message);
    
    const subMessage = document.createElement('small');
    subMessage.textContent = 'Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
    noDataDiv.appendChild(subMessage);
    
    box.innerHTML = '';
    box.appendChild(noDataDiv);
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    
    const errorMsg = document.createElement('p');
    errorMsg.textContent = 'âš ï¸ ' + (message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    errorDiv.appendChild(errorMsg);
    
    const subMsg = document.createElement('small');
    subMsg.textContent = 'ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
    errorDiv.appendChild(subMsg);
    
    const retryBtn = document.createElement('button');
    retryBtn.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
    retryBtn.style.cssText = 'margin-top:15px; padding:8px 16px; background:#1f6feb; color:white; border:none; border-radius:8px; cursor:pointer;';
    retryBtn.onclick = loadReasons;
    errorDiv.appendChild(retryBtn);
    
    box.innerHTML = '';
    box.appendChild(errorDiv);
}

// ğŸ”’ Ø¯Ø§Ù„Ø© Ø¢Ù…Ù†Ø© Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
function subscribeToRealtimeUpdates() {
    try {
        const channel = supabase
            .channel('reasons-updates')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'reasons' },
                (payload) => {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    if (payload && Security.validateReason(payload.new || payload.old)) {
                        console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
                        loadReasons();
                    }
                }
            )
            .subscribe();
            
        return channel;
    } catch (error) {
        console.error("Error in realtime updates:", error);
        return null;
    }
}

// ğŸ”’ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('DOMContentLoaded', () => {
    // Ù…Ù‡Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    setTimeout(loadReasons, 100);
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
    const channel = subscribeToRealtimeUpdates();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø©
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            loadReasons();
        }
    });
});

// ğŸ”’ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 30 Ø«Ø§Ù†ÙŠØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„)
let refreshInterval = setInterval(loadReasons, 60000);

// Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ ØªØ±Ùƒ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        clearInterval(refreshInterval);
    } else {
        clearInterval(refreshInterval);
        refreshInterval = setInterval(loadReasons, 60000);
    }
});

// ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ø¶Ø¯ Ø§Ù„Ù‡Ø¬Ù…Ø§Øª
document.addEventListener('DOMContentLoaded', () => {
    // Ù…Ù†Ø¹ ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±
    document.addEventListener('contextmenu', e => e.preventDefault());
    
    // Ù…Ù†Ø¹ Ø§Ù„Ù†Ø³Ø® ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡
    document.addEventListener('copy', e => {
        if (!window.confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ø³Ø® Ø§Ù„Ù†ØµØŸ')) {
            e.preventDefault();
        }
    });
    
    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    document.addEventListener('click', e => {
        if (e.target.tagName === 'A') {
            const href = e.target.getAttribute('href');
            if (href && !href.startsWith('#') && !href.includes('index2.html')) {
                e.preventDefault();
                window.location.href = 'index2.html';
            }
        }
    });
});
</script>
</body>
  </html>
