<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ â€“ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø¹ØªÙ‚</title>

<!-- SRI (Subresource Integrity) -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" 
      rel="stylesheet"
      integrity="sha384-YOUR_FONT_INTEGRITY_HASH"
      crossorigin="anonymous"
      referrerpolicy="no-referrer">

<!-- Ø³ÙŠØ§Ø³Ø§Øª Ø£Ù…Ø§Ù† HTTP -->
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
               font-src 'self' https://fonts.gstatic.com; 
               img-src 'self' data:; 
               connect-src 'self' https://*.supabase.co; 
               frame-ancestors 'none'; 
               form-action 'self'; 
               base-uri 'self'; 
               object-src 'none';">

<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
/* Ù…Ù†Ø¹ Ø§Ø³ØªØºÙ„Ø§Ù„ CSS */
:root {
  --safe-primary: #1f6feb;
  --safe-dark-bg: #0a0a0a;
  --safe-border: #30363d;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Cairo', sans-serif;
}

/* Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ CSS Injection */
body {
  background: linear-gradient(to bottom, #0a0a0a, #111, #1a1a1a, #222);
  min-height: 100vh;
  color: white;
  padding: 15px;
  /* Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  /* Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ø³ØªØºÙ„Ø§Ù„ :hover */
  pointer-events: auto;
}

/* Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø­Ù…Ø§ÙŠØ© */
#security-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 99999;
  pointer-events: none;
}

/* Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© */
header {
  text-align: center;
  margin-bottom: 25px;
  position: relative;
}

header h2 {
  font-size: 32px;
  font-weight: 800;
  color: var(--safe-primary);
  /* Ù…Ù†Ø¹ Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ */
  unicode-bidi: normal;
  direction: rtl;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ */
#reason-box {
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-width: 650px;
  margin: 0 auto;
  position: relative;
}

/* ØªØµÙ…ÙŠÙ… Ø§Ù„ÙƒØ±ÙˆØª Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© */
.item {
  background: rgba(255, 255, 255, 0.07);
  padding: 18px;
  border-radius: 16px;
  backdrop-filter: blur(5px);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
  border: 1px solid var(--safe-border);
  transition: 0.25s;
  /* Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ CSS Injection */
  overflow: hidden;
  word-break: break-word;
}

/* Ø­Ù…Ø§ÙŠØ© :hover */
@media (hover: hover) {
  .item:hover {
    background: rgba(255, 255, 255, 0.12);
    transform: translateY(-3px);
  }
}

/* Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†ØµÙˆØµ */
.item p {
  font-size: 18px;
  margin-bottom: 8px;
  line-height: 1.6;
  /* Ù…Ù†Ø¹ Ø­Ù‚Ù† Ø§Ù„Ù†ØµÙˆØµ */
  unicode-bidi: embed;
  direction: rtl;
}

.item strong {
  color: var(--safe-primary);
  font-weight: 700;
}

.item small {
  font-size: 14px;
  opacity: .8;
  display: block;
  margin-top: 10px;
  color: #aaa;
}

/* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© */
.back-btn {
  display: block;
  width: 100%;
  max-width: 250px;
  margin: 25px auto;
  background: var(--safe-primary);
  color: white;
  text-align: center;
  padding: 12px;
  font-size: 18px;
  text-decoration: none;
  font-weight: 700;
  border-radius: 14px;
  transition: 0.2s;
  border: none;
  cursor: pointer;
  /* Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
  onclick: "return false";
}

/* Ø­Ù…Ø§ÙŠØ© :hover Ù„Ù„Ø²Ø± */
@media (hover: hover) {
  .back-btn:hover {
    background: #2b7fff;
    transform: scale(1.05);
  }
}

/* Ø­Ø§Ù„Ø§Øª Ø®Ø§ØµØ© */
.no-data {
  text-align: center;
  padding: 30px;
  font-size: 18px;
  color: #aaa;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  border: 1px dashed #444;
}

.error-message {
  text-align: center;
  padding: 30px;
  font-size: 18px;
  color: #ff6b6b;
  background: rgba(255, 107, 107, 0.1);
  border-radius: 12px;
  border: 1px solid #ff6b6b;
}

/* Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¶Ø§Ø±Ø© */
img:not([src^="data:"]):not([src^="/"]):not([src^="./"]):not([src^="../"]) {
  display: none !important;
}

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®ÙÙŠØ© */
[style*="display: none"],
[style*="visibility: hidden"],
[hidden] {
  display: none !important;
}

/* Ù…Ù†Ø¹ Ø­Ù‚Ù† Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ø²ÙŠÙØ© */
[style*="content:"] {
  content: none !important;
}

/* Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ CSS Keylogger */
input[type="password"],
input[type="text"],
textarea {
  font-family: 'Cairo', sans-serif !important;
}

/* Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ hover attacks */
a:hover, button:hover {
  position: relative;
  z-index: 1;
}
</style>
</head>

<body oncontextmenu="return false" 
      onkeydown="return !(event.ctrlKey && event.shiftKey && event.key === 'I')"
      onbeforeunload="return 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©ØŸ'">

<!-- Ø·Ø¨Ù‚Ø© Ø­Ù…Ø§ÙŠØ© -->
<div id="security-overlay"></div>

<header>
  <h2>âš¡ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹</h2>
  <p style="text-align:center; opacity:0.8; margin-top:10px;" id="subtitle">Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
</header>

<div id="reason-box">
  <p style="text-align:center; opacity:0.7;" id="loading-text">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
</div>

<a href="index2.html" class="back-btn" onclick="return validateNavigation(this)">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

<!-- Ù…ÙƒØªØ¨Ø© DOMPurify Ù„Ù„ØªÙ†Ø¸ÙŠÙ -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"
        integrity="sha256-WqC0poWYf8nPJZR0SXm6p1bMwzWPLbgbcL7Lvlh6p+o="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>

<script type="module">
// === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ù…Ø§Ù† Ø£Ø³Ø§Ø³ÙŠØ© ===
Object.freeze(Object.prototype);
Object.freeze(Array.prototype);
Object.freeze(Function.prototype);

// Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ console
if (window.console && console.log) {
  const originalLog = console.log;
  console.log = function(...args) {
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡
    if (args.some(arg => typeof arg === 'string' && 
        (arg.includes('<script') || arg.includes('javascript:')))) {
      logSecurityEvent('Ù…Ø­ØªÙˆÙ‰ Ø®Ø·ÙŠØ± ÙÙŠ console.log');
    }
    originalLog.apply(console, args);
  };
}

// === Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===
const box = document.getElementById("reason-box");
const loadingText = document.getElementById("loading-text");
const subtitle = document.getElementById("subtitle");
let securityToken = null;
let lastDataHash = null;

// === Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† ===

// ØªÙˆÙ„ÙŠØ¯ ØªÙˆÙƒÙ† Ø£Ù…Ø§Ù†
function generateSecurityToken() {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substr(2, 9);
  const token = btoa(`${timestamp}:${random}:${navigator.userAgent}`);
  securityToken = token;
  sessionStorage.setItem('sec_token', token);
  return token;
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†
function verifySecurityToken() {
  const stored = sessionStorage.getItem('sec_token');
  return stored && stored === securityToken;
}

// ØªØ³Ø¬ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ù…Ø§Ù†
function logSecurityEvent(event, details = '') {
  const eventData = {
    event,
    details,
    timestamp: new Date().toISOString(),
    userAgent: navigator.userAgent,
    referrer: document.referrer,
    url: window.location.href
  };
  
  // ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ø®Ø§Ø¯Ù…
  console.warn('Ø­Ø¯Ø« Ø£Ù…Ø§Ù†:', eventData);
  
  // ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ
  const securityLogs = JSON.parse(localStorage.getItem('sec_logs') || '[]');
  securityLogs.push(eventData);
  if (securityLogs.length > 100) securityLogs.shift();
  localStorage.setItem('sec_logs', JSON.stringify(securityLogs));
}

// ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„ Ù„Ù„Ù†Øµ
function deepSanitize(text) {
  if (typeof text !== 'string') return '';
  
  // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø±Ù…ÙˆØ² HTML
  let clean = text.replace(/[<>]/g, '');
  
  // Ø¥Ø²Ø§Ù„Ø© event handlers
  clean = clean.replace(/on\w+\s*=/gi, '');
  
  // Ø¥Ø²Ø§Ù„Ø© JavaScript protocols
  clean = clean.replace(/javascript:/gi, '');
  clean = clean.replace(/data:/gi, '');
  clean = clean.replace(/vbscript:/gi, '');
  
  // Ø¥Ø²Ø§Ù„Ø© ØªØ¹Ø¨ÙŠØ±Ø§Øª CSS
  clean = clean.replace(/expression\s*\(/gi, '');
  
  // Ø¥Ø²Ø§Ù„Ø© Ø¯ÙˆØ§Ù„ Ø®Ø·ÙŠØ±Ø©
  const dangerousFunctions = [
    'eval', 'setTimeout', 'setInterval', 'Function',
    'execScript', 'document.write', 'innerHTML',
    'outerHTML', 'insertAdjacentHTML', 'createContextualFragment'
  ];
  
  dangerousFunctions.forEach(func => {
    clean = clean.replace(new RegExp(func + '\\s*\\(', 'gi'), '');
  });
  
  // Ø¥Ø²Ø§Ù„Ø© null bytes
  clean = clean.replace(/\0/g, '');
  
  // Ø¥Ø²Ø§Ù„Ø© Unicode Ù…Ø®Ø§Ø¯Ø¹
  clean = clean.replace(/[\u202A-\u202E\u200E\u200F\u061C]/g, '');
  
  // ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø·ÙˆÙ„
  if (clean.length > 1000) clean = clean.substring(0, 1000);
  
  return DOMPurify.sanitize(clean, {
    ALLOWED_TAGS: [],
    ALLOWED_ATTR: [],
    FORBID_TAGS: ['style', 'script', 'iframe', 'object', 'embed', 'frame'],
    FORBID_ATTR: ['style', 'onerror', 'onload', 'onclick', 'onmouseover']
  });
}

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
function safeFormatDate(dateString) {
  if (!dateString) return "â€”";
  
  try {
    // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return "â€”";
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… textContent Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† innerHTML
    const formatted = date.toLocaleString("ar-EG", {
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
    
    return deepSanitize(formatted);
  } catch (error) {
    logSecurityEvent('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®', error.message);
    return "â€”";
  }
}

// ØªÙˆÙ„ÙŠØ¯ hash Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function generateDataHash(data) {
  if (!data) return null;
  const json = JSON.stringify(data);
  let hash = 0;
  for (let i = 0; i < json.length; i++) {
    hash = ((hash << 5) - hash) + json.charCodeAt(i);
    hash |= 0;
  }
  return hash.toString(36);
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function verifyDataIntegrity(data, expectedHash) {
  const currentHash = generateDataHash(data);
  if (currentHash !== expectedHash) {
    logSecurityEvent('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', `Hash: ${currentHash}, Expected: ${expectedHash}`);
    return false;
  }
  return true;
}

// ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
async function loadReasons() {
  try {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†
    if (!verifySecurityToken()) {
      throw new Error('ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†');
    }
    
    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Supabase Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
    const { supabase } = await import('./supabase.js?t=' + Date.now());
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ù…Ù‡Ù„Ø© Ø²Ù…Ù†ÙŠØ©
    const timeoutPromise = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„')), 10000)
    );
    
    const fetchPromise = supabase
      .from('reasons')
      .select('*')
      .order('updated_at', { ascending: false })
      .limit(20); // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰

    const { data: reasons, error } = await Promise.race([fetchPromise, timeoutPromise]);

    if (error) {
      logSecurityEvent('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', error.message);
      throw error;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const dataHash = generateDataHash(reasons);
    if (!verifyDataIntegrity(reasons, dataHash)) {
      throw new Error('ØªÙ… Ø§Ù„Ø¹Ø¨Ø« Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
    
    lastDataHash = dataHash;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
    if (!reasons || reasons.length === 0) {
      box.innerHTML = DOMPurify.sanitize(`
        <div class="no-data">
          <p>ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¨Ø§Ø¨ Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
          <small>Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</small>
        </div>
      `, {
        ALLOWED_TAGS: ['div', 'p', 'small'],
        ALLOWED_ATTR: ['class']
      });
      return;
    }

    // Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
    let html = '';
    
    reasons.forEach((reason, index) => {
      // ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const cleanReason = {
        text: deepSanitize(reason.text || "â€”"),
        details: deepSanitize(reason.details || ""),
        affected_areas: deepSanitize(reason.affected_areas || ""),
        estimated_time: deepSanitize(reason.estimated_time || ""),
        status: deepSanitize(reason.status || ""),
        updated_at: safeFormatDate(reason.updated_at)
      };

      // Ø¨Ù†Ø§Ø¡ HTML Ø¢Ù…Ù†
      let itemHtml = `
        <div class="item">
          <p><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${cleanReason.text}</p>
      `;
      
      if (cleanReason.details) {
        itemHtml += `<p style="margin-top:8px;"><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${cleanReason.details}</p>`;
      }
      
      if (cleanReason.affected_areas) {
        itemHtml += `<p style="margin-top:8px;"><strong>Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©:</strong> ${cleanReason.affected_areas}</p>`;
      }
      
      if (cleanReason.estimated_time) {
        itemHtml += `<p style="margin-top:8px; color:#4ecdc4;"><strong>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ø¥ØµÙ„Ø§Ø­:</strong> ${cleanReason.estimated_time}</p>`;
      }
      
      itemHtml += `<small><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> ${cleanReason.updated_at}</small>`;
      
      if (cleanReason.status) {
        const statusColor = cleanReason.status === 'ØªÙ… Ø§Ù„Ø­Ù„' ? '#2ecc71' : '#f39c12';
        itemHtml += `<small style="color:${statusColor}"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${cleanReason.status}</small>`;
      }
      
      itemHtml += `</div>`;
      
      // Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„ Ù„Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      if (index === 1 && reasons.length > 2) {
        html += `<div style="text-align:center; margin:20px 0; color:#666; font-size:14px;">â€”â€”â€” Ø£Ø³Ø¨Ø§Ø¨ Ø³Ø§Ø¨Ù‚Ø© â€”â€”â€”</div>`;
      }
      
      html += itemHtml;
    });

    // ØªÙ†Ø¸ÙŠÙ HTML Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    box.innerHTML = DOMPurify.sanitize(html, {
      ALLOWED_TAGS: ['div', 'p', 'strong', 'small', 'span'],
      ALLOWED_ATTR: ['class', 'style'],
      ALLOW_DATA_ATTR: false
    });

  } catch (error) {
    logSecurityEvent('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', error.message);
    
    box.innerHTML = DOMPurify.sanitize(`
      <div class="error-message">
        <p>âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
        <small>ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</small>
        <br>
        <small style="font-size:12px; opacity:0.6">${deepSanitize(error.message)}</small>
      </div>
    `, {
      ALLOWED_TAGS: ['div', 'p', 'small', 'br'],
      ALLOWED_ATTR: ['class', 'style']
    });
  } finally {
    // Ø¥Ø®ÙØ§Ø¡ Ù†Øµ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    if (loadingText) {
      loadingText.style.display = 'none';
    }
  }
}

// Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
function subscribeToRealtimeUpdates() {
  try {
    import('./supabase.js').then(({ supabase }) => {
      const channel = supabase
        .channel('reasons-updates')
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'reasons'
          },
          (payload) => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø£ÙˆÙ„Ø§Ù‹
            if (!verifySecurityToken()) {
              logSecurityEvent('Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ« ØºÙŠØ± Ù…ØµØ±Ø­');
              return;
            }
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø«
            logSecurityEvent('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', payload.eventType);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            setTimeout(() => {
              if (verifySecurityToken()) {
                loadReasons();
              }
            }, 1000 + Math.random() * 2000);
          }
        )
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('âœ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù…ÙØ¹Ù„');
          }
        });
    }).catch(error => {
      logSecurityEvent('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Supabase', error.message);
    });
    
  } catch (error) {
    logSecurityEvent('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±', error.message);
  }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªÙ†Ù‚Ù„
function validateNavigation(link) {
  try {
    const href = link.getAttribute('href');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¢Ù…Ù†
    if (!href || !href.startsWith(window.location.origin) && !href.startsWith('./')) {
      logSecurityEvent('Ø±Ø§Ø¨Ø· ØªÙ†Ù‚Ù„ Ù…Ø´Ø¨ÙˆÙ‡', href);
      return false;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†
    if (!verifySecurityToken()) {
      logSecurityEvent('ØªÙ†Ù‚Ù„ Ø¨Ø¯ÙˆÙ† ØªÙˆÙƒÙ† Ø£Ù…Ø§Ù†');
      generateSecurityToken();
    }
    
    return true;
  } catch (error) {
    logSecurityEvent('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ†Ù‚Ù„', error.message);
    return false;
  }
}

// Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ XSS Injection ÙÙŠ DOM
function setupDOMMonitoring() {
  // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª DOM
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'childList') {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === 1) { // Ø¹Ù†ØµØ±
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ scripts
            if (node.tagName === 'SCRIPT') {
              logSecurityEvent('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© script', node.outerHTML);
              node.remove();
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† event handlers
            if (node.attributes) {
              Array.from(node.attributes).forEach(attr => {
                if (attr.name.startsWith('on') || 
                    attr.value.includes('javascript:') ||
                    attr.value.includes('data:')) {
                  logSecurityEvent('Ø®Ø§ØµÙŠØ© Ø®Ø·ÙŠØ±Ø©', `${attr.name}="${attr.value}"`);
                  node.remove();
                }
              });
            }
          }
        });
      }
    });
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true,
    attributeFilter: ['onclick', 'onload', 'onerror', 'onmouseover', 'href', 'src']
  });
  
  return observer;
}

// Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ù‡Ø¬Ù…Ø§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØª
function setupTimingProtection() {
  let lastCall = Date.now();
  
  return function protectedCall(callback, minDelay = 1000) {
    const now = Date.now();
    const timeSinceLastCall = now - lastCall;
    
    if (timeSinceLastCall < minDelay) {
      logSecurityEvent('Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹', `${timeSinceLastCall}ms`);
      return Promise.reject(new Error('Ù…Ù‡Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ©'));
    }
    
    lastCall = now;
    return callback();
  };
}

// === ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===
async function initApp() {
  try {
    // ØªÙˆÙ„ÙŠØ¯ ØªÙˆÙƒÙ† Ø£Ù…Ø§Ù†
    generateSecurityToken();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨Ø© DOM
    setupDOMMonitoring();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªÙˆÙ‚ÙŠØª
    const safeLoad = setupTimingProtection();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰
    await safeLoad(() => loadReasons(), 500);
    
    // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
    setTimeout(() => {
      subscribeToRealtimeUpdates();
    }, 2000);
    
    // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù…Ø¹ Ø­Ù…Ø§ÙŠØ©
    setInterval(() => {
      if (verifySecurityToken()) {
        safeLoad(() => loadReasons(), 30000);
      }
    }, 30000);
    
    // Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
    setupAdditionalProtections();
    
  } catch (error) {
    logSecurityEvent('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', error.message);
  }
}

// Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
function setupAdditionalProtections() {
  // Ù…Ù†Ø¹ ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ°
  window.open = function() {
    logSecurityEvent('Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø©');
    return null;
  };
  
  // Ø­Ù…Ø§ÙŠØ© eval
  window.eval = function() {
    logSecurityEvent('Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… eval');
    throw new Error('ØªÙ… ØªØ¹Ø·ÙŠÙ„ eval');
  };
  
  // Ù…Ø±Ø§Ù‚Ø¨Ø© localStorage
  const originalSetItem = localStorage.setItem;
  localStorage.setItem = function(key, value) {
    if (typeof value === 'string' && 
        (value.includes('<script') || value.includes('javascript:'))) {
      logSecurityEvent('Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ®Ø²ÙŠÙ† Ù…Ø­ØªÙˆÙ‰ Ø®Ø·ÙŠØ±', key);
      return;
    }
    originalSetItem.call(localStorage, key, value);
  };
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', () => {
  // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªÙ‡ÙŠØ¦Ø©
  setTimeout(initApp, 100);
});

// Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ
Object.defineProperty(window, 'eval', {
  value: function() {
    throw new Error('ØªÙ… ØªØ¹Ø·ÙŠÙ„ eval');
  },
  writable: false,
  configurable: false
});

Object.defineProperty(window, 'Function', {
  value: function() {
    throw new Error('ØªÙ… ØªØ¹Ø·ÙŠÙ„ Function constructor');
  },
  writable: false,
  configurable: false
});

console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„');
</script>

</body>
</html>
