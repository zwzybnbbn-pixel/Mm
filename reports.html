<script type="module">
import { db } from "./firebase.js";
import { 
  collection, addDoc, onSnapshot, query, orderBy, getDocs 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const form = document.getElementById("reportForm");

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const btn = document.querySelector(".btn-submit");
  btn.disabled = true;
  btn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

  // =============================
  // ğŸŸ¥ Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø£ÙƒØ«Ø± Ù…Ù† Ø¨Ù„Ø§Øº Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² (LocalStorage)
  // =============================
  if (localStorage.getItem("sent_report_today")) {
    alert("âŒ Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø§Ù„ÙŠÙˆÙ…. Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø¢Ø®Ø±.");
    btn.disabled = false;
    btn.innerText = "ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº";
    return;
  }

  // =====================
  // ğŸŸ¦ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
  // =====================
  let ip = "unknown";
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const json = await res.json();
    ip = json.ip;
  } catch (err) {
    console.log("IP fetch failed:", err);
  }

  // =====================
  // ğŸŸ§ ÙØ­Øµ Ø¢Ø®Ø± Ø¨Ù„Ø§Øº Ù„Ù†ÙØ³ Ø§Ù„Ù€ IP
  // =====================
  const qIP = query(collection(db, "reports"), orderBy("created_at", "desc"));
  const snap = await getDocs(qIP);

  let lastReport = null;

  snap.forEach(doc => {
    const r = doc.data();
    if (r.ip === ip && !lastReport) {
      lastReport = r;
    }
  });

  // =====================
  // ğŸŸ¥ Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø£ÙƒØ«Ø± Ù…Ù† Ø¨Ù„Ø§Øº Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø© Ù„Ù†ÙØ³ IP
  // =====================
  if (lastReport) {
    const last = lastReport.created_at.toDate();
    const diffHours = (Date.now() - last) / 1000 / 60 / 60;

    if (diffHours < 24) {
      btn.disabled = false;
      btn.innerText = "ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº";

      return alert(
        `âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø£ÙƒØ«Ø± Ù…Ù† Ø¨Ù„Ø§Øº Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.\nâ³ ØªØ¨Ù‚Ù‰ ${(24 - diffHours).toFixed(1)} Ø³Ø§Ø¹Ø©.`
      );
    }
  }

  // =====================
  // ğŸŸ© ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù„Ø§Øº
  // =====================
  const data = {
    type: document.getElementById("type").value.trim(),
    name: document.getElementById("name").value.trim(),
    location: document.getElementById("location").value.trim(),
    details: document.getElementById("details").value.trim(),
    created_at: new Date(),
    ip: ip,
    status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
    reply: ""
  };

  try {
    await addDoc(collection(db, "reports"), data);

    // ğŸŸ¥ Ø­ÙØ¸ Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù…Ø¯Ø© ÙŠÙˆÙ…
    localStorage.setItem("sent_report_today", "1");

    alert("âœ” ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­");
    form.reset();
  } catch (err) {
    alert("âš  Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
  }

  btn.disabled = false;
  btn.innerText = "ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº";
});

// ============================
// ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
// ============================
const list = document.getElementById("list");
const q = query(collection(db, "reports"), orderBy("created_at", "desc"));

onSnapshot(q, (snap) => {
  if (snap.empty) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª.</p>";
    return;
  }

  let html = "";

  snap.forEach(doc => {
    const r = doc.data();

    html += `
      <div class="item">
        <strong>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº:</strong> ${r.type}<br>
        <strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${r.name}<br>
        <strong>Ø§Ù„Ø­ÙŠ:</strong> ${r.location}<br>
        <strong>ØªÙØ§ØµÙŠÙ„:</strong> ${r.details}<br><br>
        <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
        <span style="color:${r.status === 'ØªÙ… Ø§Ù„Ø­Ù„' ? '#2ecc71' : '#d29922'};">
          ${r.status}
        </span>
    `;

    if (r.reply && r.reply.trim() !== "") {
      html += `
        <div class="reply-box">
          <strong>Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</strong><br>
          ${r.reply}
        </div>
      `;
    }

    html += `</div>`;
  });

  list.innerHTML = html;
});
</script>
