<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“ Ù†Ø¸Ø§Ù… Ø¥Ø¨Ù„Ø§Øº Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</title>

<!-- Ø±Ø¤ÙˆØ³ Ø£Ù…Ø§Ù† ØµØ§Ø±Ù…Ø© -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://*.supabase.co;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
  font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
  connect-src 'self' https://*.supabase.co;
  img-src 'self' data:;
  frame-src 'none';
  object-src 'none';
">

<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --primary: #1f6feb;
  --primary-dark: #0d5bc0;
  --success: #2ecc71;
  --warning: #f39c12;
  --danger: #e74c3c;
  --dark-bg: #0a0a0a;
  --card-bg: rgba(255, 255, 255, 0.06);
  --border-color: #30363d;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Cairo', sans-serif;
}

body {
  background: linear-gradient(135deg, var(--dark-bg) 0%, #111 50%, #1a1a1a 100%);
  min-height: 100vh;
  color: #e6edf3;
  padding: 15px;
  line-height: 1.6;
  /* Ù…Ù†Ø¹ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ù†Ø³Ø® ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡ */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†Ø³Ø® Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®ØµØµØ© ÙÙ‚Ø· */
.allow-copy {
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

.container {
  max-width: 700px;
  margin: 0 auto;
}

.card {
  background: var(--card-bg);
  padding: 25px;
  border-radius: 20px;
  margin-bottom: 25px;
  backdrop-filter: blur(10px);
  border: 1px solid var(--border-color);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  transition: all 0.3s ease;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.card:hover {
  border-color: rgba(31, 111, 235, 0.3);
  box-shadow: 0 12px 40px rgba(31, 111, 235, 0.2);
}

.title {
  text-align: center;
  font-size: 28px;
  font-weight: 800;
  margin: 20px 0 30px;
  color: #fff;
  position: relative;
  padding-bottom: 15px;
}

.title::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 150px;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), #4db8ff);
  border-radius: 3px;
}

.form-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.input-group {
  margin-bottom: 20px;
}

.input-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  font-size: 16px;
  color: #d0d7de;
}

.input-group input,
.input-group textarea,
.input-group select {
  width: 100%;
  padding: 14px 16px;
  font-size: 16px;
  border-radius: 12px;
  border: 2px solid var(--border-color);
  background: rgba(22, 27, 34, 0.8);
  color: #e6edf3;
  transition: all 0.3s ease;
}

.input-group input:focus,
.input-group textarea:focus,
.input-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.2);
}

.input-group textarea {
  min-height: 120px;
  resize: vertical;
}

.btn-submit {
  width: 100%;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  padding: 16px;
  border-radius: 12px;
  color: white;
  font-size: 18px;
  font-weight: 700;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.btn-submit:hover:not(:disabled) {
  background: linear-gradient(135deg, var(--primary-dark), var(--primary));
  transform: translateY(-2px);
}

.btn-submit:disabled {
  background: #555;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.separator {
  display: flex;
  align-items: center;
  margin: 30px 0;
  color: #666;
}

.separator::before,
.separator::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border-color);
}

.reports-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.reports-header h2 {
  font-size: 22px;
  font-weight: 700;
  color: #fff;
}

.reports-count {
  background: rgba(31, 111, 235, 0.2);
  color: #4db8ff;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† */
.report-item {
  background: rgba(255, 255, 255, 0.05);
  padding: 20px;
  border-radius: 16px;
  margin-bottom: 20px;
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

.report-item.allow-copy {
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

.report-meta {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}

.meta-item {
  background: rgba(0, 0, 0, 0.3);
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.meta-item strong {
  color: #4db8ff;
  font-size: 14px;
  display: block;
  margin-bottom: 5px;
}

.meta-item span {
  font-size: 16px;
  color: #fff;
}

.status-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  margin-top: 10px;
}

.status-pending {
  background: rgba(243, 156, 18, 0.2);
  color: var(--warning);
}

.status-progress {
  background: rgba(52, 152, 219, 0.2);
  color: #3498db;
}

.status-solved {
  background: rgba(46, 204, 113, 0.2);
  color: var(--success);
}

.reply-box {
  margin-top: 15px;
  padding: 15px;
  border-radius: 12px;
  background: rgba(17, 37, 66, 0.5);
  border-right: 4px solid var(--primary);
}

.reply-box strong {
  color: #4db8ff;
  font-size: 15px;
  display: block;
  margin-bottom: 8px;
}

.reply-box p {
  font-size: 16px;
  line-height: 1.6;
  color: #d0d7de;
}

.report-date {
  font-size: 13px;
  color: #888;
  margin-top: 10px;
  direction: ltr;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #888;
}

.empty-state i {
  font-size: 48px;
  margin-bottom: 15px;
  color: #444;
}

.alert {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 12px;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(10px);
  border-left: 5px solid;
  color: white;
  font-weight: 600;
  z-index: 1000;
  animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
  max-width: 400px;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.alert.success {
  border-left-color: var(--success);
  background: rgba(46, 204, 113, 0.15);
}

.alert.warning {
  border-left-color: var(--warning);
  background: rgba(243, 156, 18, 0.15);
}

.alert.error {
  border-left-color: var(--danger);
  background: rgba(231, 76, 60, 0.15);
}

.loader {
  border: 4px solid rgba(255, 255, 255, 0.1);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<!-- Ù…Ù†Ø¹ ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ± Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø§Ø³ÙŠ -->
<script>
// Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  // Ù…Ù†Ø¹ F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
  if (e.key === 'F12' || 
      (e.ctrlKey && e.shiftKey && e.key === 'I') ||
      (e.ctrlKey && e.shiftKey && e.key === 'J') ||
      (e.ctrlKey && e.key === 'u')) {
    e.preventDefault();
    return false;
  }
});
</script>
</head>

<body>

<div class="container">
  <h1 class="title">ğŸ“ Ù†Ø¸Ø§Ù… Ø¥Ø¨Ù„Ø§Øº Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h1>
  
  <div class="card">
    <div class="form-header">
      <i class="fas fa-exclamation-triangle"></i>
      <h2>Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯</h2>
    </div>
    
    <form id="reportForm">
      <div class="input-group">
        <label><i class="fas fa-bolt"></i> Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
        <select id="type" required>
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</option>
          <option value="Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙƒØ§Ù…Ù„">Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙƒØ§Ù…Ù„</option>
          <option value="Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø¬Ù‡Ø¯">Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø¬Ù‡Ø¯</option>
          <option value="ÙˆÙ…ÙŠØ¶ Ù…Ø³ØªÙ…Ø±">ÙˆÙ…ÙŠØ¶ Ù…Ø³ØªÙ…Ø±</option>
          <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      
      <div class="input-group">
        <label><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù…</label>
        <input type="text" id="name" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„"
               pattern="[\u0600-\u06FF\s]{2,50}" 
               maxlength="50"
               title="Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø· (2-50 Ø­Ø±Ù)">
      </div>
      
      <div class="input-group">
        <label><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input type="tel" id="phone" pattern="[0-9]{9}" placeholder="7xxxxxxxx" required
               maxlength="9"
               title="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 9 Ø£Ø±Ù‚Ø§Ù…">
      </div>
      
      <div class="input-group">
        <label><i class="fas fa-map-marker-alt"></i> Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
        <input type="text" id="location" required placeholder="Ù…Ø«Ø§Ù„: Ø­ÙŠ Ø§Ù„Ù†Ø®ÙŠÙ„"
               pattern="[\u0600-\u06FF0-9\s\-ØŒ,]+"
               maxlength="100">
      </div>
      
      <div class="input-group">
        <label><i class="fas fa-info-circle"></i> Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
        <textarea id="details" required placeholder="ØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„" 
                  rows="4" maxlength="500"></textarea>
      </div>
      
      <button type="submit" class="btn-submit" id="submitBtn">
        <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº
      </button>
    </form>
  </div>
  
  <div class="separator">
    <span><i class="fas fa-list"></i> Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</span>
  </div>
  
  <div class="card">
    <div class="reports-header">
      <h2>Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h2>
      <span class="reports-count" id="reportsCount">0 Ø¨Ù„Ø§Øº</span>
    </div>
    
    <div id="list">
      <div class="loader"></div>
      <p style="text-align:center; opacity:0.7;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª...</p>
    </div>
  </div>
</div>

<div id="alertContainer"></div>

<!-- ØªØ­Ù…ÙŠÙ„ Supabase Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† module -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ XSS ====================

class XSSProtection {
    constructor() {
        this.dangerousPatterns = [
            /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
            /javascript:/gi,
            /on\w+\s*=/gi,
            /data:/gi,
            /vbscript:/gi,
            /expression\s*\(/gi,
            /eval\s*\(/gi,
            /alert\s*\(/gi,
            /document\./gi,
            /window\./gi,
            /location\./gi,
            /cookie/gi,
            /<iframe/gi,
            /<object/gi,
            /<embed/gi,
            /<applet/gi,
            /<form/gi,
            /<input/gi,
            /<button/gi,
            /<link/gi,
            /<meta/gi,
            /<style/gi,
            /<svg/gi,
            /<math/gi
        ];
        
        this.initProtection();
    }
    
    initProtection() {
        // Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ innerHTML ØºÙŠØ± Ø§Ù„Ø¢Ù…Ù†
        this.protectInnerHTML();
        // Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ document.write
        this.protectDocumentWrite();
        // Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ eval
        this.protectEval();
    }
    
    // ØªØ·Ù‡ÙŠØ± Ø§Ù„Ù†Øµ Ù…Ù† XSS
    sanitizeText(text) {
        if (text === null || text === undefined) return '';
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… textContent Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† innerHTML
        const div = document.createElement('div');
        div.textContent = String(text);
        let sanitized = div.innerHTML;
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø®Ø·Ø±Ø©
        this.dangerousPatterns.forEach(pattern => {
            sanitized = sanitized.replace(pattern, '');
        });
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø®Ø§ØµØ©
        sanitized = sanitized
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;')
            .replace(/\//g, '&#x2F;');
            
        return sanitized;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± DOM Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
    createSafeElement(tag, text, attributes = {}) {
        const element = document.createElement(tag);
        element.textContent = this.sanitizeText(text);
        
        Object.entries(attributes).forEach(([key, value]) => {
            if (key.startsWith('on')) {
                console.warn('ØªÙ… Ù…Ù†Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ø®Ø·ÙŠØ±:', key);
                return;
            }
            element.setAttribute(key, this.sanitizeText(value));
        });
        
        return element;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    validateInput(input, type = 'text') {
        if (!input) return false;
        
        const patterns = {
            text: /^[\u0600-\u06FF\s\-ØŒ,.0-9]{2,500}$/,
            name: /^[\u0600-\u06FF\s]{2,50}$/,
            phone: /^[0-9]{10}$/,
            location: /^[\u0600-\u06FF0-9\s\-ØŒ,.]{2,100}$/
        };
        
        const pattern = patterns[type] || patterns.text;
        return pattern.test(input) && !this.containsDangerousCode(input);
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙˆØ¯ Ø®Ø·ÙŠØ±
    containsDangerousCode(text) {
        return this.dangerousPatterns.some(pattern => pattern.test(text));
    }
    
    // Ø­Ù…Ø§ÙŠØ© innerHTML
    protectInnerHTML() {
        const originalInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML').set;
        
        Object.defineProperty(Element.prototype, 'innerHTML', {
            set: function(value) {
                const xss = new XSSProtection();
                if (xss.containsDangerousCode(value)) {
                    console.warn('ğŸš¨ ØªÙ… Ù…Ù†Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ù‚Ù† XSS Ø¹Ø¨Ø± innerHTML');
                    return;
                }
                return originalInnerHTML.call(this, value);
            },
            get: function() {
                return originalInnerHTML;
            }
        });
    }
    
    // Ø­Ù…Ø§ÙŠØ© document.write
    protectDocumentWrite() {
        const originalWrite = document.write;
        document.write = function(content) {
            const xss = new XSSProtection();
            if (xss.containsDangerousCode(content)) {
                console.warn('ğŸš¨ ØªÙ… Ù…Ù†Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ù‚Ù† XSS Ø¹Ø¨Ø± document.write');
                return;
            }
            return originalWrite.call(document, content);
        };
    }
    
    // Ø­Ù…Ø§ÙŠØ© eval
    protectEval() {
        window.eval = function(code) {
            console.warn('ğŸš¨ ØªÙ… Ù…Ù†Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… eval Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©');
            return undefined;
        };
    }
}

// ==================== Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ====================

const xss = new XSSProtection();
const SUPABASE_CONFIG = {
    url: 'https://gxuumjhtutkipvkljjhj.supabase.co',
    key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4dXVtamh0dXRraXB2a2xqamhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NTM2MzEsImV4cCI6MjA4MTEyOTYzMX0.rmsSRTQ57cAJ3VAiQMe0mdxEYcERh6zQDep7DN_frFI'
};

let supabaseClient = null;

// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
function showAlert(message, type = 'success') {
    const container = document.getElementById('alertContainer');
    const alertDiv = xss.createSafeElement('div', '', {
        class: `alert ${type}`
    });
    
    const icon = xss.createSafeElement('i', '', {
        class: `fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'}`
    });
    
    alertDiv.appendChild(icon);
    alertDiv.appendChild(document.createTextNode(' ' + xss.sanitizeText(message)));
    container.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode === container) {
            container.removeChild(alertDiv);
        }
    }, 3000);
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'â€”';
        
        return date.toLocaleString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return 'â€”';
    }
}

// ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
async function loadReports() {
    const list = document.getElementById('list');
    
    try {
        list.innerHTML = '<div class="loader"></div><p style="text-align:center; opacity:0.7;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª...</p>';
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase
        if (!supabaseClient && window.supabase?.createClient) {
            const { createClient } = window.supabase;
            supabaseClient = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
        }
        
        if (!supabaseClient) {
            throw new Error('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
        
        const { data: reports, error } = await supabaseClient
            .from('reports')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        document.getElementById('reportsCount').textContent = `${reports?.length || 0} Ø¨Ù„Ø§Øº`;
        
        if (!reports || reports.length === 0) {
            const emptyDiv = xss.createSafeElement('div', '', { class: 'empty-state' });
            const icon = xss.createSafeElement('i', '', { class: 'far fa-folder-open' });
            const message = xss.createSafeElement('p', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ù…Ø³Ø¬Ù„Ø©');
            const subMessage = xss.createSafeElement('p', 'ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¨Ù„Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©', {
                style: 'font-size: 14px; color: #666;'
            });
            
            emptyDiv.appendChild(icon);
            emptyDiv.appendChild(message);
            emptyDiv.appendChild(subMessage);
            
            list.innerHTML = '';
            list.appendChild(emptyDiv);
            return;
        }
        
        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
        const fragment = document.createDocumentFragment();
        
        reports.forEach(report => {
            const item = xss.createSafeElement('div', '', { 
                class: 'report-item allow-copy',
                'data-id': report.id
            });
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ù…Ù†Ø©
            const safeData = {
                name: xss.sanitizeText(report.name || 'ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±'),
                type: xss.sanitizeText(report.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
                location: xss.sanitizeText(report.location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
                phone: xss.sanitizeText(report.phone || 'ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±'),
                details: xss.sanitizeText(report.details || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„'),
                status: xss.sanitizeText(report.status || 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'),
                reply: xss.sanitizeText(report.reply || ''),
                date: formatDate(report.created_at)
            };
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ø²Ø¡ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
            if (safeData.phone.length > 4) {
                safeData.phone = safeData.phone.substring(0, 4) + '******';
            }
            
            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            const metaDiv = xss.createSafeElement('div', '', { class: 'report-meta' });
            
            const metaItems = [
                { icon: 'user', label: 'Ø§Ù„Ù…Ø±Ø³Ù„', value: safeData.name },
                { icon: 'bolt', label: 'Ø§Ù„Ù†ÙˆØ¹', value: safeData.type },
                { icon: 'map-marker-alt', label: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹', value: safeData.location },
                { icon: 'phone', label: 'Ø§Ù„Ù‡Ø§ØªÙ', value: safeData.phone }
            ];
            
            metaItems.forEach(meta => {
                const metaItem = xss.createSafeElement('div', '', { class: 'meta-item' });
                const strong = xss.createSafeElement('strong', '', {});
                const icon = xss.createSafeElement('i', '', { class: `fas fa-${meta.icon}` });
                strong.appendChild(icon);
                strong.appendChild(document.createTextNode(' ' + meta.label));
                
                const span = xss.createSafeElement('span', safeData[meta.value]);
                
                metaItem.appendChild(strong);
                metaItem.appendChild(span);
                metaDiv.appendChild(metaItem);
            });
            
            item.appendChild(metaDiv);
            
            // Ø§Ù„ØªÙØ§ØµÙŠÙ„
            const detailsItem = xss.createSafeElement('div', '', { 
                class: 'meta-item',
                style: 'grid-column: 1 / -1;'
            });
            const detailsStrong = xss.createSafeElement('strong', '', {});
            const detailsIcon = xss.createSafeElement('i', '', { class: 'fas fa-info-circle' });
            detailsStrong.appendChild(detailsIcon);
            detailsStrong.appendChild(document.createTextNode(' Ø§Ù„ØªÙØ§ØµÙŠÙ„'));
            
            const detailsSpan = xss.createSafeElement('span', safeData.details);
            
            detailsItem.appendChild(detailsStrong);
            detailsItem.appendChild(detailsSpan);
            item.appendChild(detailsItem);
            
            // Ø§Ù„Ø­Ø§Ù„Ø©
            let statusClass = 'status-pending';
            let statusIcon = 'clock';
            
            if (safeData.status.includes('Ø¬Ø§Ø±')) {
                statusClass = 'status-progress';
                statusIcon = 'tools';
            } else if (safeData.status.includes('ØªÙ…')) {
                statusClass = 'status-solved';
                statusIcon = 'check-circle';
            }
            
            const statusDiv = xss.createSafeElement('div', '', { class: `${statusClass} status-badge` });
            const statusIconEl = xss.createSafeElement('i', '', { class: `fas fa-${statusIcon}` });
            statusDiv.appendChild(statusIconEl);
            statusDiv.appendChild(document.createTextNode(' ' + safeData.status));
            item.appendChild(statusDiv);
            
            // Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            if (safeData.reply) {
                const replyDiv = xss.createSafeElement('div', '', { class: 'reply-box' });
                const replyStrong = xss.createSafeElement('strong', '', {});
                const replyIcon = xss.createSafeElement('i', '', { class: 'fas fa-reply' });
                replyStrong.appendChild(replyIcon);
                replyStrong.appendChild(document.createTextNode(' Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©'));
                
                const replyP = xss.createSafeElement('p', safeData.reply);
                
                replyDiv.appendChild(replyStrong);
                replyDiv.appendChild(replyP);
                item.appendChild(replyDiv);
            }
            
            // Ø§Ù„ØªØ§Ø±ÙŠØ®
            const dateDiv = xss.createSafeElement('div', '', { class: 'report-date' });
            const dateIcon = xss.createSafeElement('i', '', { class: 'far fa-clock' });
            dateDiv.appendChild(dateIcon);
            dateDiv.appendChild(document.createTextNode(' ' + safeData.date));
            item.appendChild(dateDiv);
            
            fragment.appendChild(item);
        });
        
        list.innerHTML = '';
        list.appendChild(fragment);
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª:', error);
        list.innerHTML = '<div class="alert error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</div>';
    }
}

// Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯
async function submitReport(event) {
    event.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    try {
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ù…Ø¤Ù‚ØªØ§Ù‹
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
        
        // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªÙ†Ø¸ÙŠÙÙ‡Ø§
        const reportData = {
            type: xss.sanitizeText(document.getElementById('type').value),
            name: xss.sanitizeText(document.getElementById('name').value.trim()),
            phone: xss.sanitizeText(document.getElementById('phone').value.trim()),
            location: xss.sanitizeText(document.getElementById('location').value.trim()),
            details: xss.sanitizeText(document.getElementById('details').value.trim()),
            status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
            reply: '',
            created_at: new Date().toISOString()
        };
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        if (!xss.validateInput(reportData.name, 'name')) {
            throw new Error('Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø· (2-50 Ø­Ø±Ù)');
        }
        
        if (!xss.validateInput(reportData.phone, 'phone')) {
            throw new Error('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 9 Ø£Ø±Ù‚Ø§Ù…');
        }
        
        if (!xss.validateInput(reportData.location, 'location')) {
            throw new Error('Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
        }
        
        if (!xss.validateInput(reportData.details, 'text')) {
            throw new Error('Ø§Ù„ØªÙØ§ØµÙŠÙ„ ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
        }
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase
        if (!supabaseClient && window.supabase?.createClient) {
            const { createClient } = window.supabase;
            supabaseClient = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
        }
        
        if (!supabaseClient) {
            throw new Error('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { data, error } = await supabaseClient
            .from('reports')
            .insert([reportData])
            .select();
        
        if (error) throw error;
        
        showAlert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­', 'success');
        document.getElementById('reportForm').reset();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        setTimeout(loadReports, 1000);
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº:', error);
        showAlert(`âŒ ${error.message}`, 'error');
    } finally {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø²Ø±
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', () => {
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('reportForm').addEventListener('submit', submitReport);
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª
    setTimeout(loadReports, 500);
    
    // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ
    setInterval(() => {
        if (!document.hidden) {
            loadReports();
        }
    }, 60000);
});

console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ XSS');
</script>
</body>
</html>
