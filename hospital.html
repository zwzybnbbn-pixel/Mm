<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</title>

<!-- Ø±Ø¤ÙˆØ³ Ø£Ù…Ø§Ù† HTTP -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://esm.sh;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
  font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
  img-src 'self' data: https:;
  connect-src 'self' https://gxuumjhtutkipvkljjhj.supabase.co https://api.ipify.org;
  frame-ancestors 'self';
">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta name="referrer" content="strict-origin-when-cross-origin">

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo';}
body{background:#eef3f3;padding:12px;}
.back-btn{display:inline-block;background:#444;color:#fff;padding:10px 16px;border-radius:10px;text-decoration:none;margin-bottom:15px;font-size:16px;}
.back-btn:hover{background:#555;}
.card{width:100%;background:white;padding:18px;border-radius:15px;box-shadow:0 3px 12px #00000022;margin-bottom:15px;}
h2{font-size:22px;color:#00695C;text-align:center;margin-bottom:15px;font-weight:800;}
.info{background:#f9ffff;padding:12px;border-left:5px solid #00796B;border-radius:12px;margin-bottom:12px;}
.label{font-size:15px;font-weight:700;color:#00695C;}
.value{font-size:16px;color:#333;margin-top:4px;}
.like-btn { background:none; border:none; cursor:pointer; font-size:16px; padding:5px 10px; border-radius:20px; transition:all 0.3s; display:inline-flex; align-items:center; gap:5px; margin-top:10px;}
.like-btn:hover { background: rgba(255,105,105,0.1);}
.like-btn.liked { color:#d32f2f; font-weight:bold;}
.like-btn i { font-size:18px; }
.stars-input { margin:15px 0; direction:ltr; text-align:center; }
.stars-input .star { font-size:32px; color:#ddd; cursor:pointer; transition:color 0.2s; padding:0 3px; }
.stars-input .star.active { color:#ffc107; }
.avg-rating { font-size:48px; font-weight:900; color:#ff9800; text-align:center; }
.rating-stars { font-size:24px; color:#ffc107; text-align:center; margin:10px 0; }
.review { background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px; border-right:4px solid #00796B; }
.review .stars { color:#ffc107; font-size:18px; margin-bottom:8px; }
.btn-submit { background:#00796B; color:white; border:none; padding:12px 24px; border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer; width:100%; transition:all 0.3s; margin-top:15px; }
.btn-submit:hover:not(:disabled) { background:#009688; transform:translateY(-2px); }
.btn-submit:disabled { background:#ccc; cursor:not-allowed; }
.hospital-img { width:150px; height:150px; border-radius:50%; object-fit:cover; display:block; margin:20px auto; border:4px solid #00796B; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
.alert { padding:12px; border-radius:8px; margin:10px 0; text-align:center; font-weight:bold; animation:fadeIn 0.3s; }
@keyframes fadeIn { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
.alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
.alert-error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
textarea { width:100%; min-height:120px; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; resize:vertical; transition:border-color 0.3s; }
textarea:focus { outline:none; border-color:#00796B; }
.rating-message {
  margin-top: 8px;
  font-size: 14px;
  display: none;
}

.rating-message.error {
  color: #d32f2f;
}

.rating-message.success {
  color: #2e7d32;
}
</style>
</head>

<body>

<a href="hospitals.html" class="back-btn">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª</a>
<div style="text-align:center; margin-bottom:20px;">
  <img id="hospitalImg" class="hospital-img" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰" src="https://via.placeholder.com/150">
</div>

<div class="card">
  <h2 id="hName">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰...</h2>
  <div class="info"><div class="label">ğŸ“ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</div><div class="value" id="hCity">-</div></div>
  <div class="info"><div class="label">ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</div><div class="value" id="hPhone">-</div></div>
  <div class="info"><div class="label">ğŸ¥ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</div><div class="value" id="hDepartments">-</div></div>
  <div class="info"><div class="label">ğŸ“ Ø§Ù„ÙˆØµÙ:</div><div class="value" id="hDescription">-</div></div>
  <a id="mapBtn" class="btn-submit" href="#" target="_blank" style="text-decoration:none; text-align:center;"><i class="fas fa-map-marker-alt"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
</div>

<div class="card">
  <h3>â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…</h3>
  <div class="avg-rating" id="avgRating">0.0</div>
  <div class="rating-stars" id="ratingStars">â˜†â˜†â˜†â˜†â˜†</div>
  <div style="text-align:center; color:#666;" id="ratingCount">0 ØªÙ‚ÙŠÙŠÙ…</div>
</div>

<div class="card">
  <h3>ğŸ“‹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>
  <div id="reviewsList" style="min-height: 100px;">
    <div style="text-align:center; padding:30px; color:#777;">
      <i class="fas fa-comments" style="font-size:48px; color:#ddd; margin-bottom:10px;"></i><br>
      Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ‚ÙŠÙ…!
    </div>
  </div>
</div>
<div class="card">
  <h3>âœï¸ Ø£Ø¶Ù ØªÙ‚ÙŠÙŠÙ…Ùƒ</h3>

  <div class="stars-input" id="starsInput">
    <span class="star" data-rating="1">â˜†</span>
    <span class="star" data-rating="2">â˜†</span>
    <span class="star" data-rating="3">â˜†</span>
    <span class="star" data-rating="4">â˜†</span>
    <span class="star" data-rating="5">â˜†</span>
  </div>

  <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
  <div id="ratingMessage" class="rating-message"></div>
</div>
  <div style="text-align:center; color:#666; margin-bottom:15px;">Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù…Ù† 1 Ø¥Ù„Ù‰ 5</div>
  <textarea id="reviewText" placeholder="Ø´Ø§Ø±ÙƒÙ†Ø§ ØªØ¬Ø±Ø¨ØªÙƒ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰..."></textarea>
  <button id="sendReview" class="btn-submit"><i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
</div>

<div class="card" id="doctorsSection" style="display:none;">
  <h3>ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</h3>
  <div id="hospitalDoctors"></div>
</div>
 

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const SUPABASE_URL = 'https://gxuumjhtutkipvkljjhj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4dXVtamh0dXRraXB2a2xqamhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NTM2MzEsImV4cCI6MjA4MTEyOTYzMX0.rmsSRTQ57cAJ3VAiQMe0mdxEYcERh6zQDep7DN_frFI';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const urlParams = new URLSearchParams(window.location.search);
const hospitalId = urlParams.get('id');
if (!hospitalId) { 
  const alertDiv = document.createElement('div');
  alertDiv.className = 'alert alert-error';
  alertDiv.textContent = 'Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªØ´ÙÙ‰';
  document.body.appendChild(alertDiv);
  setTimeout(() => { window.location.href='hospitals.html'; }, 2000);
}

let selectedRating = 0;
let userIdentifier = null;

// ==== ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====
async function generateUserIdentifier() {
  const local = localStorage.getItem('user_identifier');
  if (local) return local;
  
  try {
    const resp = await fetch('https://api.ipify.org?format=json');
    const data = await resp.json();
    const id = 'ip_' + data.ip;
    localStorage.setItem('user_identifier', id);
    return id;
  } catch (e) {
    console.warn('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP:', e);
  }
  
  const id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('user_identifier', id);
  return id;
}
function showRatingMessage(msg, type = 'error') {
  const box = document.getElementById('ratingMessage');
  if (!box) return;

  box.textContent = msg;
  box.className = `rating-message ${type}`;
  box.style.display = 'block';

  setTimeout(() => {
    box.style.display = 'none';
  }, 3000);
}
// ==== Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ø¬ÙˆÙ… ====
function generateStars() {
  const container = document.getElementById('starsInput');
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }
  
  for (let i = 1; i <= 5; i++) {
    const star = document.createElement('span');
    star.className = 'star';
    star.dataset.rating = i;
    star.textContent = 'â˜†';
    star.addEventListener('mouseover', () => highlightStars(i));
    star.addEventListener('mouseout', () => resetStars());
    star.addEventListener('click', () => selectRating(i));
    container.appendChild(star);
  }
}

function highlightStars(r) { 
  document.querySelectorAll('.star').forEach((s, i) => {
    s.textContent = i < r ? 'â˜…' : 'â˜†';
    s.style.color = i < r ? '#ffc107' : '#ddd';
  });
}

function resetStars() { 
  document.querySelectorAll('.star').forEach((s, i) => {
    s.textContent = i < selectedRating ? 'â˜…' : 'â˜†';
    s.style.color = i < selectedRating ? '#ffc107' : '#ddd';
  });
}

function selectRating(r) { 
  selectedRating = r; 
  resetStars(); 
}

// ==== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ ====
async function loadHospital() {
  try {
    const { data, error } = await supabase
      .from('hospitals')
      .select('*')
      .eq('id', hospitalId)
      .single();
    
    if (error) { 
      showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰', 'error'); 
      return; 
    }
    
    document.getElementById('hName').textContent = data.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    document.getElementById('hCity').textContent = data.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    document.getElementById('hPhone').textContent = data.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    document.getElementById('hDepartments').textContent = data.department || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    document.getElementById('hDescription').textContent = data.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
    
    const img = document.getElementById('hospitalImg');
    img.src = data.img || 'https://via.placeholder.com/150?text=Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰';
    img.alt = data.name || 'ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰';
    
    const mapBtn = document.getElementById('mapBtn');
    if (data.map) {
      mapBtn.href = data.map;
    } else {
      mapBtn.style.display = 'none';
    }
  } catch (err) {
    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰', 'error');
  }
}

// ==== Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± ØªÙ‚ÙŠÙŠÙ… ====
function createReviewElement(review) {
  const reviewDiv = document.createElement('div');
  reviewDiv.className = 'review';
  
  // Ø§Ù„Ù†Ø¬ÙˆÙ…
  const starsDiv = document.createElement('div');
  starsDiv.className = 'stars';
  starsDiv.textContent = 'â˜…'.repeat(review.rating || 0) + 'â˜†'.repeat(5 - (review.rating || 0));
  
  // Ø§Ù„Ù†Øµ
  const textP = document.createElement('p');
  textP.style.marginBottom = '10px';
  textP.textContent = review.text || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚';
  
  // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· (ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨)
  const metaDiv = document.createElement('div');
  metaDiv.style.display = 'flex';
  metaDiv.style.justifyContent = 'space-between';
  metaDiv.style.alignItems = 'center';
  
  const dateSpan = document.createElement('span');
  dateSpan.style.color = '#666';
  dateSpan.style.fontSize = '14px';
  
  const calendarIcon = document.createElement('i');
  calendarIcon.className = 'far fa-calendar';
  dateSpan.appendChild(calendarIcon);
  
  const dateText = document.createTextNode(' ' + (review.date ? new Date(review.date).toLocaleDateString('ar-SA') : 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
  dateSpan.appendChild(dateText);
  
  // Ø¹Ù†ØµØ± ÙØ§Ø±Øº Ù„Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨)
  const emptyDiv = document.createElement('div');
  
  metaDiv.appendChild(dateSpan);
  metaDiv.appendChild(emptyDiv);
  
  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
  reviewDiv.appendChild(starsDiv);
  reviewDiv.appendChild(textP);
  reviewDiv.appendChild(metaDiv);
  
  return reviewDiv;
}

// ==== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ====
async function loadReviews() {
  const reviewsList = document.getElementById('reviewsList');
  
  try {
    const { data: reviews, error } = await supabase
      .from('reviews')
      .select('*')
      .eq('hospital_id', hospitalId)
      .order('date', { ascending: false });
    
    if (error) { 
      showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª', 'error'); 
      return; 
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    let total = 0;
    reviews.forEach(r => total += (r.rating || 0));
    const avg = reviews.length > 0 ? (total / reviews.length).toFixed(1) : '0.0';
    const stars = Math.round(parseFloat(avg) || 0);
    
    document.getElementById('avgRating').textContent = avg;
    document.getElementById('ratingStars').textContent = 'â˜…'.repeat(stars) + 'â˜†'.repeat(5 - stars);
    document.getElementById('ratingCount').textContent = `${reviews.length} ØªÙ‚ÙŠÙŠÙ…`;
    
    // ØªÙØ±ÙŠØº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    while (reviewsList.firstChild) {
      reviewsList.removeChild(reviewsList.firstChild);
    }
    
    if (!reviews || reviews.length === 0) {
      const emptyDiv = document.createElement('div');
      emptyDiv.style.textAlign = 'center';
      emptyDiv.style.padding = '30px';
      emptyDiv.style.color = '#777';
      
      const commentIcon = document.createElement('i');
      commentIcon.className = 'fas fa-comments';
      commentIcon.style.fontSize = '48px';
      commentIcon.style.color = '#ddd';
      commentIcon.style.marginBottom = '10px';
      
      const br = document.createElement('br');
      
      const message = document.createTextNode('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ‚ÙŠÙ…!');
      
      emptyDiv.appendChild(commentIcon);
      emptyDiv.appendChild(br);
      emptyDiv.appendChild(message);
      
      reviewsList.appendChild(emptyDiv);
      return;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
    reviews.forEach(review => {
      const reviewElement = createReviewElement(review);
      reviewsList.appendChild(reviewElement);
    });
    
  } catch (err) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª:', err);
    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª', 'error');
  }
}

// ==== Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±) ====
async function addReview() {
  const text = document.getElementById('reviewText').value.trim();
  
  if (selectedRating === 0) {
   showRatingMessage('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ…');
    return;
  }
  
  if (text.length < 5) {
    
    showRatingMessage('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚ Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 5 Ø£Ø­Ø±Ù');
    return;
  }
  
  const btn = document.getElementById('sendReview');
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… DOM API
  const spinner = document.createElement('i');
  spinner.className = 'fas fa-spinner fa-spin';
  const textNode = document.createTextNode(' Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
  
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… DOM API Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† innerHTML
  while (btn.firstChild) {
    btn.removeChild(btn.firstChild);
  }
  btn.appendChild(spinner);
  btn.appendChild(textNode);
  btn.disabled = true;
  
  try {
    if (!userIdentifier) {
      userIdentifier = await generateUserIdentifier();
    }
    
    // ===========================================
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªÙ‚ÙŠÙŠÙ… Ø³Ø§Ø¨Ù‚ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    // ===========================================
    const { data: existingReview, error: checkError } = await supabase
      .from('reviews')
      .select('id')
      .eq('hospital_id', hospitalId)
      .eq('user', userIdentifier)
      .maybeSingle();
    
    if (checkError) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚:', checkError);
      throw new Error('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
    }
    
    if (existingReview) {
      showRatingMessage('Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
      return;
    }
    // ===========================================
    
    // ØªÙˆÙ„ÙŠØ¯ ID ÙØ±ÙŠØ¯ Ù„Ù„ØªÙ‚ÙŠÙŠÙ…
    const reviewId = 'review_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    const { error } = await supabase
      .from('reviews')
      .insert([{
        id: reviewId,
        rating: selectedRating,
        text: text,
        hospital_id: hospitalId,
        user: userIdentifier,
        date: new Date().toISOString()
      }]);
    
    if (error) throw error;
    
    showRatingMessage('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    document.getElementById('reviewText').value = '';
    selectedRating = 0;
    resetStars();
    await loadReviews();
    
  } catch (err) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:', err);
    showAlert(err.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'error');
  } finally {
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… DOM API ÙÙ‚Ø·
    const planeIcon = document.createElement('i');
    planeIcon.className = 'fas fa-paper-plane';
    const submitText = document.createTextNode(' Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… DOM API Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† innerHTML
    while (btn.firstChild) {
      btn.removeChild(btn.firstChild);
    }
    btn.appendChild(planeIcon);
    btn.appendChild(submitText);
    btn.disabled = false;
  }
}

// ==== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ ====
async function loadDoctors() {
  try {
    const { data: hosp, error: hErr } = await supabase
      .from('hospitals')
      .select('name')
      .eq('id', hospitalId)
      .single();
    
    if (hErr || !hosp) return;
    
    const { data: doctors, error: dErr } = await supabase
      .from('doctors')
      .select('*')
      .ilike('hospital', `%${hosp.name}%`);
    
    if (dErr || !doctors || doctors.length === 0) return;
    
    const container = document.getElementById('hospitalDoctors');
    const doctorsSection = document.getElementById('doctorsSection');
    
    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ø§ÙˆÙŠØ©
    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }
    
    doctorsSection.style.display = 'block';
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡
    doctors.forEach(doc => {
      const doctorDiv = document.createElement('div');
      doctorDiv.style.background = '#f8f9fa';
      doctorDiv.style.padding = '15px';
      doctorDiv.style.borderRadius = '10px';
      doctorDiv.style.marginBottom = '10px';
      
      const flexDiv = document.createElement('div');
      flexDiv.style.display = 'flex';
      flexDiv.style.alignItems = 'center';
      flexDiv.style.gap = '15px';
      
      const img = document.createElement('img');
      img.src = doc.img || 'https://via.placeholder.com/50';
      img.style.width = '50px';
      img.style.height = '50px';
      img.style.borderRadius = '50%';
      img.style.objectFit = 'cover';
      
      const infoDiv = document.createElement('div');
      infoDiv.style.flex = '1';
      
      const nameDiv = document.createElement('div');
      nameDiv.style.fontWeight = 'bold';
      nameDiv.style.color = '#00695C';
      nameDiv.textContent = doc.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      
      const specialtyDiv = document.createElement('div');
      specialtyDiv.style.color = '#666';
      specialtyDiv.textContent = doc.specialty || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      
      const scheduleDiv = document.createElement('div');
      scheduleDiv.style.fontSize = '14px';
      scheduleDiv.style.color = '#888';
      
      const calendarIcon = document.createElement('i');
      calendarIcon.className = 'far fa-calendar';
      scheduleDiv.appendChild(calendarIcon);
      
      let scheduleText = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      if (doc.schedule) {
        const sched = doc.schedule;
        const days = sched.days || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const times = sched.times || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        scheduleText = `${days} | ${times}`;
      }
      
      scheduleDiv.appendChild(document.createTextNode(' ' + scheduleText));
      
      infoDiv.appendChild(nameDiv);
      infoDiv.appendChild(specialtyDiv);
      infoDiv.appendChild(scheduleDiv);
      
      flexDiv.appendChild(img);
      flexDiv.appendChild(infoDiv);
      doctorDiv.appendChild(flexDiv);
      container.appendChild(doctorDiv);
    });
    
  } catch (err) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡:', err);
  }
}

// ==== Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ====
function showAlert(msg, type) {
  const old = document.querySelector('.alert');
  if (old) old.remove();
  
  const div = document.createElement('div');
  div.className = `alert alert-${type}`;
  div.textContent = msg;
  
  document.body.insertBefore(div, document.body.firstChild);
  
  setTimeout(() => {
    if (div.parentNode) {
      div.parentNode.removeChild(div);
    }
  }, 3000);
}

// ==== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© ====
document.addEventListener('DOMContentLoaded', async () => {
  if (!hospitalId) return;
  
  generateStars();
  
  try {
    await Promise.all([
      loadHospital(),
      loadReviews(),
      loadDoctors()
    ]);
  } catch (err) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  document.getElementById('sendReview').addEventListener('click', addReview);
  
  document.getElementById('reviewText').addEventListener('keypress', e => {
    if (e.key === 'Enter' && e.ctrlKey) {
      addReview();
    }
  });
});

// ==== ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© ====
if (hospitalId) {
  setInterval(async () => {
    await loadReviews();
  }, 30000);
}
</script>
</body>
  </html>
