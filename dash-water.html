<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙŠØ§Ù‡</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Cairo',sans-serif; margin:0; background:#f0f0f0; }
header { background:#0099ff; color:white; text-align:center; padding:1rem; }
main { max-width:1000px; margin:2rem auto; padding:1rem; background:white; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
input, button, select { padding:0.5rem; margin:0.2rem 0; border-radius:6px; border:1px solid #ccc; font-size:1rem; }
button { background:#0099ff; color:white; border:none; cursor:pointer; transition:0.3s;}
button:hover { background:#007acc; }
table { width:100%; border-collapse:collapse; margin-top:1rem; }
th, td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
th { background:#0099ff; color:white; }
.message-box { background:#f0faff; padding:1rem 1.5rem; border-radius:10px; margin-bottom:1rem; font-size:1.1rem;}
</style>
</head>
<body>
<header>
  <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙŠØ§Ù‡</h1>
</header>

<main>
  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="authSection">
    <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="dashboard" style="display:none;">
    <div class="user-info" id="userInfo" style="margin-bottom:1rem; padding:0.5rem; background:#e6f2ff; border-radius:6px;"></div>

    <h3>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
    <input type="text" id="newMessage" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§" style="width:70%;"/>
    <button id="updateMessageBtn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>

    <h3>Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹</h3>
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ø³Ø§Ø¹Ø©</th>
          <th>Ø§Ù„Ø­ÙŠ</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø­ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="tablesContainer"></tbody>
    </table>

    <h3>Ø¥Ø¶Ø§ÙØ© ØªÙˆØ²ÙŠØ¹ Ø¬Ø¯ÙŠØ¯</h3>
    <input type="date" id="newDate">
    <input type="time" id="newTime">
    <input type="text" id="newArea" placeholder="Ø§Ù„Ø­ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ">
    <select id="newStatus">
      <option value="Ù†Ø´Ø·">Ù†Ø´Ø·</option>
      <option value="Ù…ØªÙˆÙ‚Ù">Ù…ØªÙˆÙ‚Ù</option>
      <option value="Ù…Ø­Ø¯ÙˆØ¯">Ù…Ø­Ø¯ÙˆØ¯</option>
    </select>
    <input type="text" id="newNextArea" placeholder="Ø§Ù„Ø­ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ">
    <input type="text" id="newNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©">
    <button id="addBtn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
    <button id="logoutBtn" style="background:#ff4d4d;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</main>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// Ø¥Ø¹Ø¯Ø§Ø¯ Supabase - Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶
const supabaseUrl = "https://gxuumjhtutkipvkljjhj.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4dXVtamh0dXRraXB2a2xqamhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NTM2MzEsImV4cCI6MjA4MTEyOTYzMX0.rmsSRTQ57cAJ3VAiQMe0mdxEYcERh6zQDep7DN_frFI";
const supabase = createClient(supabaseUrl, supabaseKey);

const authSection = document.getElementById("authSection");
const dashboard = document.getElementById("dashboard");
const userInfo = document.getElementById("userInfo");

// ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
checkAuth();

async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    showDashboard(session.user);
  }
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  
  const { data, error } = await supabase.auth.signInWithPassword({ 
    email, 
    password 
  });
  
  if(error) return alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message);
  
  showDashboard(data.user);
});

function showDashboard(user) {
  authSection.style.display = "none";
  dashboard.style.display = "block";
  userInfo.innerHTML = `ğŸ‘¤ Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ÙƒÙ€: <strong>${user.email}</strong>`;
  loadDistributions();
  loadGeneralMessage();
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  const { error } = await supabase.auth.signOut();
  if(error) alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + error.message);
  
  authSection.style.display = "block";
  dashboard.style.display = "none";
  document.getElementById("email").value = "";
  document.getElementById("password").value = "";
});

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© - ØªØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶
document.getElementById("updateMessageBtn").addEventListener("click", async ()=>{
  const message = document.getElementById("newMessage").value;
  if(!message) return alert("Ø£Ø¯Ø®Ù„ Ø±Ø³Ø§Ù„Ø© ØµØ­ÙŠØ­Ø©");

  const { error } = await supabase
    .from('general_message')
    .upsert({ id: 1, message }, { onConflict: 'id' })
    .select();
    
  if(error) {
    alert("Ø®Ø·Ø£: " + error.message);
  } else {
    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
    loadGeneralMessage();
  }
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© - ØªØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶
async function loadGeneralMessage() {
  const { data, error } = await supabase
    .from('general_message')
    .select('message')
    .eq('id', 1)
    .single();
    
  if(data && !error) {
    document.getElementById("newMessage").value = data.message || "";
  }
}

// ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ - Ù‡ÙŠÙƒÙ„ Ù…Ø·Ø§Ø¨Ù‚ Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶
const tablesContainer = document.getElementById("tablesContainer");
async function loadDistributions(){
  const { data, error } = await supabase
    .from('water_distribution')
    .select('*')
    .order('date', { ascending: true }); // Ù†ÙØ³ ØªØ±ØªÙŠØ¨ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶
    
  if(error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
    return;
  }
  
  tablesContainer.innerHTML = "";

  data.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.time}</td>
      <td>${r.area}</td>
      <td>${r.status}</td>
      <td>${r.next_area || ''}</td>
      <td>${r.note || ''}</td>
      <td>
        <button onclick="editDistribution('${r.id}')">ØªØ¹Ø¯ÙŠÙ„ ÙƒØ§Ù…Ù„</button>
        <button onclick="deleteRow('${r.id}')">Ø­Ø°Ù</button>
      </td>
    `;
    tablesContainer.appendChild(tr);
  });
}

// Ø¥Ø¶Ø§ÙØ© ØªÙˆØ²ÙŠØ¹ Ø¬Ø¯ÙŠØ¯ - Ù‡ÙŠÙƒÙ„ Ù…Ø·Ø§Ø¨Ù‚ Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶
document.getElementById("addBtn").addEventListener("click", async ()=>{
  const date = document.getElementById("newDate").value;
  const time = document.getElementById("newTime").value;
  const area = document.getElementById("newArea").value;
  const status = document.getElementById("newStatus").value;
  const next_area = document.getElementById("newNextArea").value;
  const note = document.getElementById("newNote").value;
  
  if(!date || !time || !area) {
    return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ø³Ø§Ø¹Ø©ØŒ Ø§Ù„Ø­ÙŠ)");
  }

  const { error } = await supabase
    .from('water_distribution')
    .insert([{
      date, time, area, status, next_area, note,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    }])
    .select();
    
  if(error) {
    alert("Ø®Ø·Ø£: " + error.message);
  } else {
    alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
    
    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById("newDate").value = "";
    document.getElementById("newTime").value = "";
    document.getElementById("newArea").value = "";
    document.getElementById("newNextArea").value = "";
    document.getElementById("newNote").value = "";
    
    loadDistributions();
  }
});

// Ø¯ÙˆØ§Ù„ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù
window.deleteRow = async (id)=>{
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØ²ÙŠØ¹ØŸ")) return;
  
  const { error } = await supabase
    .from('water_distribution')
    .delete()
    .eq('id', id)
    .select();
    
  if(error) {
    alert("Ø®Ø·Ø£: " + error.message);
  } else {
    alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
    loadDistributions();
  }
};

// Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ ÙƒØ§Ù…Ù„Ø© Ø¨Ù…Ø±Ø¨Ø¹ Ø­ÙˆØ§Ø± Ù…Ø®ØµØµ
window.editDistribution = async (id) => {
  // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const { data, error: fetchError } = await supabase
    .from('water_distribution')
    .select('*')
    .eq('id', id)
    .single();

  if (fetchError) return alert('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + fetchError.message);
  if (!data) return alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„');

  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± dialog Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  const dialog = document.createElement('dialog');
  dialog.style.cssText = `
    width: 400px;
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #0099ff;
    direction: rtl;
    text-align: right;
  `;

  dialog.innerHTML = `
    <h3 style="margin-top:0; color:#0099ff;">ØªØ¹Ø¯ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙŠØ§Ù‡</h3>
    
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px;">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="editDate" value="${data.date}" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc;">
    </div>
    
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px;">Ø§Ù„ÙˆÙ‚Øª:</label>
      <input type="text" id="editTime" value="${data.time}" placeholder="Ù…Ø«Ø§Ù„: ØµØ¨Ø§Ø­Ø§Ù‹" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc;">
    </div>
    
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px;">Ø§Ø³Ù… Ø§Ù„Ø­ÙŠ:</label>
      <input type="text" id="editArea" value="${data.area}" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc;">
    </div>
    
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px;">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
      <select id="editStatus" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc;">
        <option value="Ù†Ø´Ø·" ${data.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Ù†Ø´Ø·</option>
        <option value="Ù…ØªÙˆÙ‚Ù" ${data.status === 'Ù…ØªÙˆÙ‚Ù' ? 'selected' : ''}>Ù…ØªÙˆÙ‚Ù</option>
        <option value="Ù…Ø­Ø¯ÙˆØ¯" ${data.status === 'Ù…Ø­Ø¯ÙˆØ¯' ? 'selected' : ''}>Ù…Ø­Ø¯ÙˆØ¯</option>
      </select>
    </div>
    
    <div style="margin-bottom:15px;">
      <label style="display:block; margin-bottom:5px;">Ø§Ù„Ø­ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ:</label>
      <input type="text" id="editNextArea" value="${data.next_area || ''}" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc;">
    </div>
    
    <div style="margin-bottom:20px;">
      <label style="display:block; margin-bottom:5px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
      <textarea id="editNote" rows="3" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc;">${data.note || ''}</textarea>
    </div>
    
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button id="cancelEdit" style="padding:10px 20px; background:#ccc; border:none; border-radius:5px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="saveEdit" style="padding:10px 20px; background:#0099ff; color:white; border:none; border-radius:5px; cursor:pointer;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
  `;

  // Ø¥Ø¶Ø§ÙØ© dialog Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
  document.body.appendChild(dialog);
  dialog.showModal();

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  document.getElementById('cancelEdit').onclick = () => {
    dialog.close();
    dialog.remove();
  };

  document.getElementById('saveEdit').onclick = async () => {
    const updatedData = {
      date: document.getElementById('editDate').value,
      time: document.getElementById('editTime').value,
      area: document.getElementById('editArea').value,
      status: document.getElementById('editStatus').value,
      next_area: document.getElementById('editNextArea').value || null,
      note: document.getElementById('editNote').value || null,
      updated_at: new Date().toISOString()
    };

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!updatedData.date || !updatedData.time || !updatedData.area || !updatedData.status) {
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©');
      return;
    }

    // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ø¯ÙŠØ«
    const { error } = await supabase
      .from('water_distribution')
      .update(updatedData)
      .eq('id', id)
      .select();

    if (error) {
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message);
    } else {
      alert('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
      dialog.close();
      dialog.remove();
      loadDistributions();
    }
  };
};
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
document.addEventListener('DOMContentLoaded', () => {
  loadGeneralMessage();
});
</script>
</body>
</html>