<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙ†Ø¯Ù‚</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  *{
    margin:0; padding:0; box-sizing:border-box;
    font-family:'Cairo', sans-serif;
  }

  body {
    background:#eef6ff;
    display:flex;
    justify-content:center;
  }

  .container {
    width:100%;
    max-width:380px;
    padding:12px;
  }

  .back-btn{
    display:inline-block;
    background:#0d4d91;
    color:#fff;
    padding:8px 14px;
    border-radius:10px;
    text-decoration:none;
    font-size:15px;
    margin-bottom:12px;
  }

  .title {
    text-align:center;
    font-size:23px;
    font-weight:800;
    color:#0d4d91;
    margin-bottom:12px;
  }

  .card {
    background:white;
    padding:16px;
    border-radius:14px;
    margin-bottom:14px;
    box-shadow:0 3px 10px rgba(0,0,0,0.10);
  }

  .hotel-img {
    width:100%;
    height:210px;
    object-fit:cover;
    border-radius:12px;
    margin-bottom:10px;
    border:3px solid #0d4d91;
  }

  .section-title {
    font-size:17px;
    font-weight:700;
    margin-top:12px;
    color:#0d4d91;
  }

  p { font-size:15px; color:#333; margin:4px 0; }

  .btn {
    display:block;
    width:100%;
    padding:10px;
    margin-top:10px;
    background:#0d4d91;
    color:white;
    text-align:center;
    font-size:15px;
    border-radius:10px;
    text-decoration:none;
    font-weight:600;
  }

  /* â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª */
  .stars {
    margin:6px 0;
  }

  .star {
    font-size:26px;
    cursor:pointer;
    color:#ccc;
  }
  .star.active {
    color:#ffb400;
  }

  .review {
    background:#fff;
    padding:12px;
    margin-top:10px;
    border-radius:10px;
    border-right:4px solid #0d4d91;
  }

  .like-btn {
    margin-top:8px;
    color:#d40000;
    cursor:pointer;
    font-size:15px;
  }

  .avg-box {
    background:#ffffff;
    padding:12px;
    border-radius:12px;
    margin:10px 0;
    text-align:center;
    font-size:17px;
    font-weight:700;
    color:#0d4d91;
    box-shadow:0 2px 8px rgba(0,0,0,0.10);
  }
</style>
</head>

<body>

<div class="container">

  <a href="hotels.html" class="back-btn">â¬… Ø±Ø¬ÙˆØ¹</a>

  <h1 class="title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙ†Ø¯Ù‚</h1>

  <div class="card">
    <img id="hotelImg" class="hotel-img">

    <div class="section-title">Ø§Ø³Ù… Ø§Ù„ÙÙ†Ø¯Ù‚</div>
    <p id="hotelName">â€”</p>

    <div class="section-title">Ø§Ù„Ø³Ø¹Ø±</div>
    <p id="hotelPrice">â€”</p>

    <div class="section-title">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</div>
    <p id="hotelServices">â€”</p>

    <div class="section-title">Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„</div>
    <p id="hotelPhone">â€”</p>

    <a id="mapBtn" class="btn" target="_blank">ğŸ“ Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
  </div>

  <div id="avgRatingBox" class="avg-box">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨â€¦</div>

  <h2 class="section-title">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>

  <div id="reviewsList"></div>

  <div class="card">
    <h3 style="font-size:18px;margin-bottom:8px;color:#0d4d91;">Ø£Ø¶Ù ØªÙ‚ÙŠÙŠÙ…Ùƒ</h3>

    <div id="stars">
      <span class="star" data-v="1">â˜…</span>
      <span class="star" data-v="2">â˜…</span>
      <span class="star" data-v="3">â˜…</span>
      <span class="star" data-v="4">â˜…</span>
      <span class="star" data-v="5">â˜…</span>
    </div>

    <textarea id="reviewText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒâ€¦" 
      style="width:100%;height:80px;margin-top:10px;padding:10px;border-radius:10px;border:1px solid #ccc;"></textarea>

    <button id="sendReview" class="btn" style="margin-top:10px;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
  </div>

</div>

<script type="module">

  import { db } from "./firebase-config.js";
  import { 
    doc, getDoc, collection, addDoc, getDocs, updateDoc 
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // ------------------ Ø¬Ù„Ø¨ ID ------------------
  const id = new URL(window.location.href).searchParams.get("id");

  // ------------------ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙ†Ø¯Ù‚ ------------------
  async function loadHotel() {
    const snap = await getDoc(doc(db, "tourism_hotels", id));
    const d = snap.data();

    hotelImg.src = d.image;
    hotelName.textContent = d.name;
    hotelPrice.textContent = d.price;
    hotelServices.textContent = d.services;
    hotelPhone.textContent = d.phone;
    mapBtn.href = d.map_link;
  }
  loadHotel();

  // ------------------ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª + Ø§Ù„Ù…ØªÙˆØ³Ø· + Ø²Ø± Ø¥Ø¹Ø¬Ø§Ø¨ ------------------
  async function loadReviews() {
    const list = document.getElementById("reviewsList");
    const avgBox = document.getElementById("avgRatingBox");

    const q = await getDocs(collection(db, "tourism_hotels", id, "reviews"));

    list.innerHTML = "";
    let total = 0, count = 0;

    q.forEach(s => {
      const r = s.data();
      const rid = s.id;

      const likes = r.likes || 0;
      const rating = r.rating;

      count++;
      total += rating;

      const liked = localStorage.getItem("liked_" + rid) ? "â¤ï¸ ØªÙ… Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨" : "ğŸ¤ Ø£Ø¹Ø¬Ø¨Ù†ÙŠ";

      list.innerHTML += `
        <div class="review">
          <p>â­ ${"â˜…".repeat(rating)}${"â˜†".repeat(5 - rating)}</p>
          <p>${r.text}</p>

          <div class="like-btn" onclick="likeReview('${rid}', ${likes})">
            ${liked} (${likes})
          </div>
        </div>
      `;
    });

    if (count === 0) {
      avgBox.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯";
      return;
    }

    const avg = (total / count).toFixed(1);
    avgBox.textContent = `Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${avg} â­`;
  }
  loadReviews();

  // ------------------ Ø¥Ø¹Ø¬Ø§Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ------------------
  window.likeReview = async (rid, oldLikes) => {
    const key = "liked_" + rid;

    if (localStorage.getItem(key)) {
      alert("Ù„Ù‚Ø¯ Ø£Ø¹Ø¬Ø¨Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ù† Ù‚Ø¨Ù„ âœ”");
      return;
    }

    const ref = doc(db, "tourism_hotels", id, "reviews", rid);

    await updateDoc(ref, { likes: oldLikes + 1 });

    localStorage.setItem(key, "1");

    loadReviews();
  };

  // ------------------ Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· ------------------
  let selectedStars = 0;

  document.querySelectorAll(".star").forEach(star => {
    star.addEventListener("click", () => {
      selectedStars = Number(star.dataset.v);

      document.querySelectorAll(".star").forEach(s => s.classList.remove("active"));
      for (let i = 1; i <= selectedStars; i++) {
        document.querySelector(`.star[data-v="${i}"]`).classList.add("active");
      }
    });
  });

  sendReview.onclick = async () => {
    const text = reviewText.value.trim();

    if (!selectedStars) return alert("Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ…");
    if (!text) return alert("Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…");

    // âŒ Ù…Ù†Ø¹ Ø£ÙƒØ«Ø± Ù…Ù† ØªØ¹Ù„ÙŠÙ‚ Ù„Ù†ÙØ³ Ø§Ù„ÙÙ†Ø¯Ù‚
    if (localStorage.getItem("comment_" + id)) {
      return alert("Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ÙƒØªØ§Ø¨Ø© ØªÙ‚ÙŠÙŠÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙ†Ø¯Ù‚ Ù…Ù† Ù‚Ø¨Ù„ âœ”");
    }

    await addDoc(collection(db, "tourism_hotels", id, "reviews"), {
      rating: selectedStars,
      text,
      likes: 0,
      time: Date.now()
    });

    // âœ” ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    localStorage.setItem("comment_" + id, "1");

    alert("âœ” ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…");

    reviewText.value = "";
    selectedStars = 0;
    document.querySelectorAll(".star").forEach(s => s.classList.remove("active"));

    loadReviews();
  };

</script>

</body>
</html>
