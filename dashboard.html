<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#004D40; --bg2:#00695C; --accent:#009688; --white:#fff;
    --card-bg: #fff; --muted:#7a7a7a;
    --danger:#E53935; --primary:#00796B;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif}
  html,body{height:100%}
  body{
    background: linear-gradient(180deg,var(--bg1),var(--bg2) 60%,var(--accent));
    color:var(--white);
    -webkit-font-smoothing:antialiased;
    padding:20px;
    display:flex;
    justify-content:center;
  }

  .wrap{ width:100%; max-width:920px; margin:0 auto; }

  header.top{ text-align:center; margin-bottom:14px; }
  header.top h1{ font-size:20px; font-weight:800; color:var(--white); letter-spacing:0.2px; }

  .tabs{ display:flex; gap:8px; justify-content:center; margin:14px 0; flex-wrap:wrap; }
  .tab {
    background: rgba(255,255,255,0.08);
    color:var(--white);
    padding:8px 12px;
    border-radius:12px;
    font-weight:700;
    cursor:pointer;
    font-size:14px;
    min-width:110px;
    text-align:center;
  }
  .tab.active{
    background:var(--card-bg);
    color:var(--primary);
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  }

  .card { background: var(--card-bg); color:#222; border-radius:16px; padding:14px; margin:12px 0; box-shadow:0 8px 22px rgba(0,0,0,0.22); }

  .controls{ display:flex; gap:8px; margin-bottom:10px; align-items:center; }
  .controls .search{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid #eee; font-size:14px; }
  .controls .btn { background:var(--primary); color:var(--card-bg); border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; font-size:14px; }
  .controls .btn.ghost{ background:transparent; color:var(--primary); border:1px solid var(--primary); }

  .table-wrap{ overflow:auto }
  table.table{ width:100%; border-collapse:collapse; font-size:14px; min-width:640px; }
  table th, table td{ padding:10px 8px; text-align:right; vertical-align:middle; border-bottom:1px solid #eee; color:#333; background:transparent; }
  table th{ background:transparent; color:#555; text-align:right; font-weight:700; font-size:13px; }
  .actions-row{ display:flex; gap:6px; justify-content:flex-start }
  .action-btn{ border:none; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; font-size:13px; }
  .action-btn.edit{ background:#FFF3CD; color:#8A6D02 }
  .action-btn.delete{ background:#F8D7DA; color:#721C24 }
  .action-btn.view{ background:#E3F2FD; color:#0D47A1 }

  .td-doctor{ display:flex; align-items:center; gap:10px; justify-content:flex-end; }
  .td-doctor img{ width:44px; height:44px; border-radius:50%; object-fit:cover; border:2px solid #eee; }
  .muted{ color:var(--muted); font-size:13px }

  .overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:80; padding:18px; }
  .overlay.show{ display:flex }
  .modal{ width:100%; max-width:720px; background:var(--card-bg); color:#222; border-radius:14px; padding:16px; box-shadow:0 18px 40px rgba(0,0,0,0.4); max-height:92vh; overflow:auto; }
  .modal h3{ font-size:18px; margin-bottom:10px; color:var(--primary) }
  .form-row{ display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap }
  .form-row .field{ flex:1; min-width:160px }
  input[type=text], input[type=url], textarea, select{ width:100%; padding:10px; border:1px solid #e6e6e6; border-radius:10px; font-size:14px; }
  textarea{ min-height:80px; resize:vertical; padding-top:10px }
  label.small{ display:block; margin-bottom:6px; font-size:13px; color:#444 }

  .days-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-bottom:8px }
  .day-field{ background:#f7f7f7; padding:8px; border-radius:8px }
  .day-field input{ background:transparent; border:none; padding:6px; width:100% }

  .modal-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:6px }
  .modal .btn{ padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700 }
  .btn.save{ background:var(--primary); color:#fff }
  .btn.cancel{ background:#eee; color:#444 }

  @media(max-width:420px){
    .tabs{ flex-wrap:wrap }
    table.table{ min-width:360px }
    .days-grid{ grid-template-columns:repeat(1,1fr) }
  }
</style>
</head>

<body>
  <button class="logout-btn" onclick="logoutDashboard()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>


<style>
.logout-btn{
    display:block;
    width:100%;
    background:#d40000;
    color:#fff;
    padding:10px;
    border-radius:10px;
    font-size:16px;
    font-weight:700;
    border:none;
    cursor:pointer;
    margin-top:15px;
    box-shadow:0 3px 10px rgba(0,0,0,0.15);
}
.logout-btn:hover{
    background:#b30000;
}
</style>

<style>
.move-btn{
    display:inline-block !important;
    width:auto !important;
    max-width:max-content !important;
    
    background:#0d4d91;
    color:#fff;
    padding:5px 10px; /* ØµØºÙŠØ± */
    border-radius:10px;
    text-decoration:none;
    font-size:14px;   /* Ø®Ø· ØµØºÙŠØ± */
    font-weight:600;
    box-shadow:0 3px 10px rgba(0,0,0,0.15);
    margin:5px 0;     /* Ù…Ø³Ø§ÙØ© Ø¨Ø³ÙŠØ·Ø© */
}
</style>

<a href="dashboard2.html" class="move-btn">Ù†Ù‚Ù„ ÙƒÙ‡Ø±Ø¨Ø§Ø¡</a>
<a href="dashbmagedddddd.html" class="move-btn">Ù†Ù‚Ù„ Ù…Ø­Ø§ÙØ¸</a>
<a href="admin-all.html" class="move-btn">Ù†Ù‚Ù„ Ø³ÙŠØ§Ø­Ù‡</a>


  <div class="wrap">
    <header class="top">
      <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… â€” Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚</h1>
    </header>

    <div class="tabs" role="tablist">
      <div id="tabDashboard" class="tab">Ø§Ù„Ù…Ù„Ø®Øµ</div>
      <div id="tabDoctors" class="tab">Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</div>
      <div id="tabHospitals" class="tab">Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª</div>
      <div id="tabClinics" class="tab">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª</div>
      <div id="tabLabs" class="tab">Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø§Øª</div>
      <div id="tabEmergency" class="tab">Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</div>
      <div id="tabBlog" class="tab">Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©</div>
    </div>

    <!-- DASHBOARD -->
    <div id="pageDashboard" class="card" style="display:block">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div>
          <div style="font-weight:800;font-size:18px;color:var(--primary)">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
          <div class="muted" style="margin-top:6px">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ØªØ¨ÙˆÙŠØ¨ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        </div>

        <div style="display:flex;gap:18px;align-items:center">
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:800;color:#222" id="statDoctors">0</div>
            <div class="muted">Ø£Ø·Ø¨Ø§Ø¡</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:800;color:#222" id="statHospitals">0</div>
            <div class="muted">Ù…Ø³ØªØ´ÙÙŠØ§Øª</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:800;color:#222" id="statClinics">0</div>
            <div class="muted">Ø¹ÙŠØ§Ø¯Ø§Øª</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:800;color:#222" id="statLabs">0</div>
            <div class="muted">Ù…Ø®ØªØ¨Ø±Ø§Øª</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:800;color:#222" id="statEmergency">0</div>
            <div class="muted">Ø·ÙˆØ§Ø±Ø¦</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:800;color:#222" id="statBlog">0</div>
            <div class="muted">Ù…Ù‚Ø§Ù„Ø§Øª</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DOCTORS -->
    <div id="pageDoctors" class="card" style="display:none">
      <div class="controls">
        <input id="searchDoctors" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø£Ùˆ ØªØ®ØµØµ Ø£Ùˆ Ù…Ø³ØªØ´ÙÙ‰..." />
        <button id="btnAddDoctor" class="btn">+ Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      <div class="table-wrap">
        <table class="table" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡">
          <thead>
            <tr>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„ØªØ®ØµØµ</th>
              <th>Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</th>
              <th>Ø±Ù‚Ù…</th>
              <th>Ø§Ù„Ø£ÙŠØ§Ù…</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="doctorsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- HOSPITALS -->
    <div id="pageHospitals" class="card" style="display:none">
      <div class="controls">
        <input id="searchHospitals" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." />
        <button id="btnAddHospital" class="btn">+ Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      <div class="table-wrap">
        <table class="table" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª">
          <thead>
            <tr>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
              <th>Ù‡Ø§ØªÙ</th>
              <th>Ø£Ù‚Ø³Ø§Ù…</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="hospitalsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- CLINICS -->
    <div id="pageClinics" class="card" style="display:none">
      <div class="controls">
        <input id="searchClinics" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." />
        <button id="btnAddClinic" class="btn">+ Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      <div class="table-wrap">
        <table class="table" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª">
          <thead>
            <tr>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
              <th>Ù‡Ø§ØªÙ</th>
              <th>Ø£Ù‚Ø³Ø§Ù…</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="clinicsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- LABS -->
    <div id="pageLabs" class="card" style="display:none">
      <div class="controls">
        <input id="searchLabs" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." />
        <button id="btnAddLab" class="btn">+ Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      <div class="table-wrap">
        <table class="table" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø§Øª">
          <thead>
            <tr>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
              <th>Ù‡Ø§ØªÙ</th>
              <th>Ø£Ù‚Ø³Ø§Ù…</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="labsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- EMERGENCY -->
    <div id="pageEmergency" class="card" style="display:none">

  <div class="controls">
    <input id="searchEmergency" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ² Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." />
    <button id="btnAddEmergency" class="btn">+ Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <div class="table-wrap">
    <table class="table" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ø§Ù„ÙˆØµÙ</th>
          <th>Ø§Ù„Ø®Ø±ÙŠØ·Ø©</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>

      <tbody id="emergencyTbody"></tbody>
    </table>
  </div>

</div>


    <!-- BLOG -->
    <div id="pageBlog" class="card" style="display:none">
      <div class="controls">
        <input id="searchBlog" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ù…Ù‚ØªØ·Ù..." />
        <button id="btnAddBlog" class="btn">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„</button>
      </div>
      <div class="table-wrap">
        <table class="table" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª">
          <thead>
            <tr>
              <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
              <th>Ù…Ù‚ØªØ·Ù</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="blogTbody"></tbody>


        </table>
      </div>
    </div>

  </div>

  <!-- Overlay modal for Add/Edit -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„</h3>

      <form id="modalForm">
        <div id="formFields"></div>
        <div class="modal-actions">
          <button type="button" id="btnCancel" class="btn cancel">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" id="btnSave" class="btn save">Ø­ÙØ¸</button>
        </div>
      </form>
    </div>
  </div>

<script type="module">
/* dashboard.html â€” unified CRUD for doctors/hospitals/clinics/labs/emergency/blogs
   Requires: ./firebase-config.js exporting { auth, db }
*/

import { auth, db } from "./firebase-config.js";
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

import {
  collection, getDocs, addDoc, updateDoc, deleteDoc, doc,
  getDoc, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";


/* =======================================================
   ğŸ” Ø­Ù…Ø§ÙŠØ© ØµÙØ­Ø© Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ â€” Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
   ======================================================= */
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
  }
});


/* =======================================================
   ğŸšª Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
   ======================================================= */
function logoutDashboard() {
  signOut(auth).then(() => {
    localStorage.removeItem("loginToken");
    window.location.href = "login.html";
  });
}

// Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„ÙŠØ¹Ù…Ù„ onclick Ù…Ù† Ø§Ù„Ù€ HTML
window.logoutDashboard = logoutDashboard;

/* DOM refs */
const tabs = {
  dashboard: document.getElementById('tabDashboard'),
  doctors: document.getElementById('tabDoctors'),
  hospitals: document.getElementById('tabHospitals'),
  clinics: document.getElementById('tabClinics'),
  labs: document.getElementById('tabLabs'),
  emergency: document.getElementById('tabEmergency'),
  blog: document.getElementById('tabBlog')
};

const pages = {
  dashboard: document.getElementById('pageDashboard'),
  doctors: document.getElementById('pageDoctors'),
  hospitals: document.getElementById('pageHospitals'),
  clinics: document.getElementById('pageClinics'),
  labs: document.getElementById('pageLabs'),
  emergency: document.getElementById('pageEmergency'),
  blog: document.getElementById('pageBlog')
};

const tbodies = {
  doctors: document.getElementById('doctorsTbody'),
  hospitals: document.getElementById('hospitalsTbody'),
  clinics: document.getElementById('clinicsTbody'),
  labs: document.getElementById('labsTbody'),
  emergency: document.getElementById('emergencyTbody'),
  blog: document.getElementById('blogTbody') // âœ”ï¸ ØµØ­ 100%

};

const controls = {
  btnAddDoctor: document.getElementById('btnAddDoctor'),
  btnAddHospital: document.getElementById('btnAddHospital'),
  btnAddClinic: document.getElementById('btnAddClinic'),
  btnAddLab: document.getElementById('btnAddLab'),
  btnAddEmergency: document.getElementById('btnAddEmergency'),
  btnAddBlog: document.getElementById('btnAddBlog'),
  searchDoctors: document.getElementById('searchDoctors'),
  searchHospitals: document.getElementById('searchHospitals'),
  searchClinics: document.getElementById('searchClinics'),
  searchLabs: document.getElementById('searchLabs'),
  searchEmergency: document.getElementById('searchEmergency'),
  searchBlog: document.getElementById('searchBlog')
};

const overlay = document.getElementById('overlay');
const formFields = document.getElementById('formFields');
const modalTitle = document.getElementById('modalTitle');
const modalForm = document.getElementById('modalForm');
const btnCancel = document.getElementById('btnCancel');
const statDoctors = document.getElementById('statDoctors');
const statHospitals = document.getElementById('statHospitals');
const statClinics = document.getElementById('statClinics');
const statLabs = document.getElementById('statLabs');
const statEmergency = document.getElementById('statEmergency');
const statBlog = document.getElementById('statBlog');

let activePage = 'dashboard';
let editing = null; // { collection, id, viewOnly? }

/* Auth guard */
onAuthStateChanged(auth, (user) => {
  if (!user) window.location.href = 'login.html';
  else updateCounts();
});

/* Tab navigation */
function setActiveTab(key){
  Object.values(tabs).forEach(t=>t.classList.remove('active'));
  Object.values(pages).forEach(p=>p.style.display = 'none');

  tabs[key].classList.add('active');
  pages[key].style.display = 'block';
  activePage = key;

  // lazy load tables
  if(key === 'doctors') loadDoctors();
  if(key === 'hospitals') loadHospitals();
  if(key === 'clinics') loadClinics();
  if(key === 'labs') loadLabs();
  if(key === 'emergency') loadEmergency();
  if(key === 'blog') loadBlogs();
}

Object.entries(tabs).forEach(([k,el])=>el.addEventListener('click', ()=>setActiveTab(k)));

function esc(s){ return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------- LOAD functions ---------- */

async function loadDoctors(){
  tbodies.doctors.innerHTML = `<tr><td colspan="6" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>`;
  try {
    const snap = await getDocs(collection(db,'doctors'));
    statDoctors.textContent = snap.size;
    if(snap.empty){ tbodies.doctors.innerHTML = `<tr><td colspan="6" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡</td></tr>`; return; }
    const html = [];
    snap.forEach(docu=>{
      const d = docu.data(); const id = docu.id;
      const hasSchedule = d.schedule ? Object.values(d.schedule).some(s=>s && s.time && s.time.trim().length>0) : false;
      const daysLabel = hasSchedule ? 'Ù…ÙˆØ¬ÙˆØ¯' : '-';
      html.push(`
        <tr data-id="${id}">
          <td class="td-doctor">
            <img src="${esc(d.img || 'https://via.placeholder.com/120')}" alt="">
            <div style="text-align:right">
              <div style="font-weight:800">${esc(d.name)}</div>
              <div class="muted">${esc(d.specialty||'')}</div>
            </div>
          </td>
          <td>${esc(d.specialty||'-')}</td>
          <td>${esc(d.hospital||'-')}</td>
          <td>${esc(d.phone||'-')}</td>
          <td class="muted">${daysLabel}</td>
          <td>
            <div class="actions-row">
              <button class="action-btn view" data-action="view-doctor" data-id="${id}">Ø¹Ø±Ø¶</button>
              <button class="action-btn edit" data-action="edit-doctor" data-id="${id}">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="action-btn delete" data-action="delete-doctor" data-id="${id}">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>
      `);
    });
    tbodies.doctors.innerHTML = html.join('');
  } catch(err){ console.error(err); tbodies.doctors.innerHTML = `<tr><td colspan="6" class="muted">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>`; }
}

async function loadHospitals(){
  tbodies.hospitals.innerHTML = `<tr><td colspan="5" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>`;
  try {
    const snap = await getDocs(collection(db,'hospitals'));
    statHospitals.textContent = snap.size;
    if(snap.empty){ tbodies.hospitals.innerHTML = `<tr><td colspan="5" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ´ÙÙŠØ§Øª</td></tr>`; return; }
    const rows=[]; snap.forEach(docu=>{
      const h=docu.data(), id=docu.id;
      rows.push(`
        <tr data-id="${id}">
          <td style="font-weight:800">${esc(h.name)}</td>
          <td>${esc(h.city||'-')}</td>
          <td>${esc(h.phone||'-')}</td>
          <td class="muted" style="max-width:180px">${esc(h.department||'-')}</td>
          <td>
            <div class="actions-row">
              <button class="action-btn view" data-action="view-hospital" data-id="${id}">Ø¹Ø±Ø¶</button>
              <button class="action-btn edit" data-action="edit-hospital" data-id="${id}">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="action-btn delete" data-action="delete-hospital" data-id="${id}">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>
      `);
    });
    tbodies.hospitals.innerHTML = rows.join('');
  } catch(err){ console.error(err); tbodies.hospitals.innerHTML = `<tr><td colspan="5" class="muted">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>`; }
}

async function loadClinics(){
  tbodies.clinics.innerHTML = `<tr><td colspan="5" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>`;
  try {
    const snap = await getDocs(collection(db,'clinics'));
    statClinics.textContent = snap.size;
    if(snap.empty){ tbodies.clinics.innerHTML = `<tr><td colspan="5" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹ÙŠØ§Ø¯Ø§Øª</td></tr>`; return; }
    const rows=[]; snap.forEach(docu=>{
      const c=docu.data(), id=docu.id;
      rows.push(`
        <tr data-id="${id}">
          <td style="font-weight:800">${esc(c.name)}</td>
          <td>${esc(c.city||'-')}</td>
          <td>${esc(c.phone||'-')}</td>
          <td class="muted" style="max-width:180px">${esc(c.department||'-')}</td>
          <td>
            <div class="actions-row">
              <button class="action-btn view" data-action="view-clinic" data-id="${id}">Ø¹Ø±Ø¶</button>
              <button class="action-btn edit" data-action="edit-clinic" data-id="${id}">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="action-btn delete" data-action="delete-clinic" data-id="${id}">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>
      `);
    });
    tbodies.clinics.innerHTML = rows.join('');
  } catch(err){ console.error(err); tbodies.clinics.innerHTML = `<tr><td colspan="5" class="muted">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>`; }
}

async function loadLabs(){
  tbodies.labs.innerHTML = `<tr><td colspan="5" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>`;
  try {
    const snap = await getDocs(collection(db,'labs'));
    statLabs.textContent = snap.size;
    if(snap.empty){ tbodies.labs.innerHTML = `<tr><td colspan="5" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®ØªØ¨Ø±Ø§Øª</td></tr>`; return; }
    const rows=[]; snap.forEach(docu=>{
      const l=docu.data(), id=docu.id;
      rows.push(`
        <tr data-id="${id}">
          <td style="font-weight:800">${esc(l.name)}</td>
          <td>${esc(l.city||'-')}</td>
          <td>${esc(l.phone||'-')}</td>
          <td class="muted" style="max-width:180px">${esc(l.department||'-')}</td>
          <td>
            <div class="actions-row">
              <button class="action-btn view" data-action="view-lab" data-id="${id}">Ø¹Ø±Ø¶</button>
              <button class="action-btn edit" data-action="edit-lab" data-id="${id}">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="action-btn delete" data-action="delete-lab" data-id="${id}">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>
      `);
    });
    tbodies.labs.innerHTML = rows.join('');
  } catch(err){ console.error(err); tbodies.labs.innerHTML = `<tr><td colspan="5" class="muted">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>`; }
}

async function loadEmergency(){
  tbodies.emergency.innerHTML = `<tr><td colspan="5" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>`;
  try {
    const snap = await getDocs(collection(db,'emergency'));
    statEmergency.textContent = snap.size;
    if(snap.empty){ tbodies.emergency.innerHTML = `<tr><td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§ÙƒØ² Ø·ÙˆØ§Ø±Ø¦</td></tr>`; return; }
    const rows=[]; snap.forEach(docu=>{
      const e=docu.data(), id=docu.id;
      rows.push(`
        <tr data-id="${id}">
          <td style="font-weight:800">${esc(e.name)}</td>
          <td>${esc(e.city||'-')}</td>
          <td>${esc(e.phone||'-')}</td>
          <td class="muted" style="max-width:180px">${esc(e.department||'-')}</td>
          <td>
            <div class="actions-row">
              <button class="action-btn view" data-action="view-emergency" data-id="${id}">Ø¹Ø±Ø¶</button>
              <button class="action-btn edit" data-action="edit-emergency" data-id="${id}">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="action-btn delete" data-action="delete-emergency" data-id="${id}">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>
      `);
    });
    tbodies.emergency.innerHTML = rows.join('');
  } catch(err){ console.error(err); tbodies.emergency.innerHTML = `<tr><td colspan="5" class="muted">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>`; }
}

/* BLOG: simple articles (title, short, content, img, createdAt) */
async function loadBlogs() {
  tbodies.blog.innerHTML = `
    <tr><td colspan="4" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
  `;

  try {
    // Ù†Ø±ØªØ¨ Ø­Ø³Ø¨ createdAt Ù„Ø£Ù†Ù‡ Ø±Ù‚Ù…
    const q = query(collection(db, 'blog'), orderBy('createdAt', 'desc'));
    const snap = await getDocs(q);

    statBlog.textContent = snap.size;

    if (snap.empty) {
      tbodies.blog.innerHTML = `
        <tr><td colspan="4" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª</td></tr>
      `;
      return;
    }

    const rows = [];

    snap.forEach(docu => {
      const b = docu.data();
      const id = docu.id;

      // ØªØ­ÙˆÙŠÙ„ createdAt Ø±Ù‚Ù… â†’ ØªØ§Ø±ÙŠØ® Ø¹Ø±Ø¨ÙŠ
      let dateStr = "";
      if (b.createdAt) {
        dateStr = new Date(b.createdAt).toLocaleDateString("ar");
      }

      rows.push(`
        <tr data-id="${id}">
          <td style="font-weight:800">${esc(b.title || "-")}</td>
          <td class="muted" style="max-width:300px">${esc(b.short || "-")}</td>
          <td>${esc(dateStr)}</td>

          <td>
            <div class="actions-row">
              <button class="action-btn view" data-action="view-blog" data-id="${id}">Ø¹Ø±Ø¶</button>
              <button class="action-btn edit" data-action="edit-blog" data-id="${id}">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="action-btn delete" data-action="delete-blog" data-id="${id}">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>
      `);
    });

    tbodies.blog.innerHTML = rows.join('');

  } catch (err) {
    console.error(err);
    tbodies.blog.innerHTML = `
      <tr><td colspan="4" class="muted">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>
    `;
  }
}


/* Update counts (dashboard) */
async function updateCounts(){
  try { statDoctors.textContent = (await getDocs(collection(db,'doctors'))).size } catch(e){ console.warn(e); }
  try { statHospitals.textContent = (await getDocs(collection(db,'hospitals'))).size } catch(e){ }
  try { statClinics.textContent = (await getDocs(collection(db,'clinics'))).size } catch(e){ }
  try { statLabs.textContent = (await getDocs(collection(db,'labs'))).size } catch(e){ }
  try { statEmergency.textContent = (await getDocs(collection(db,'emergency'))).size } catch(e){ }
  try { statBlog.textContent = (await getDocs(collection(db,'blog'))).size } catch(e){ }
}

/* Event delegation for table action buttons */
document.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('button[data-action]');
  if(!btn) return;
  const action = btn.dataset.action;
  const id = btn.dataset.id;

  // DELETE handlers
  if(action === 'delete-doctor'){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø¨ÙŠØ¨ØŸ')) return; await deleteDoc(doc(db,'doctors',id)); await loadDoctors(); updateCounts(); return; }
  if(action === 'delete-hospital'){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ØŸ')) return; await deleteDoc(doc(db,'hospitals',id)); await loadHospitals(); updateCounts(); return; }
  if(action === 'delete-clinic'){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©ØŸ')) return; await deleteDoc(doc(db,'clinics',id)); await loadClinics(); updateCounts(); return; }
  if(action === 'delete-lab'){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø®ØªØ¨Ø±ØŸ')) return; await deleteDoc(doc(db,'labs',id)); await loadLabs(); updateCounts(); return; }
  if(action === 'delete-emergency'){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙƒØ²ØŸ')) return; await deleteDoc(doc(db,'emergency',id)); await loadEmergency(); updateCounts(); return; }
  if(action === 'delete-blog'){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§Ù„ØŸ')) return; await deleteDoc(doc(db,'blog',id)); await loadBlogs(); updateCounts(); return; }

  // EDIT handlers
  if(action === 'edit-doctor'){ editing = { collection:'doctors', id }; await openDoctorForm(id); return; }
  if(action === 'edit-hospital'){ editing = { collection:'hospitals', id }; await openHospitalForm(id); return; }
  if(action === 'edit-clinic'){ editing = { collection:'clinics', id }; await openClinicForm(id); return; }
  if(action === 'edit-lab'){ editing = { collection:'labs', id }; await openLabForm(id); return; }
  if(action === 'edit-emergency'){ editing = { collection:'emergency', id }; await openEmergencyForm(id); return; }
  if(action === 'edit-blog'){ editing = { collection:'blog', id }; await openBlogForm(id); return; }

  // VIEW handlers (viewOnly)
  if(action === 'view-doctor'){ editing = { collection:'doctors', id, viewOnly:true }; await openDoctorForm(id, {viewOnly:true}); return; }
  if(action === 'view-hospital'){ editing = { collection:'hospitals', id, viewOnly:true }; await openHospitalForm(id, {viewOnly:true}); return; }
  if(action === 'view-clinic'){ editing = { collection:'clinics', id, viewOnly:true }; await openClinicForm(id, {viewOnly:true}); return; }
  if(action === 'view-lab'){ editing = { collection:'labs', id, viewOnly:true }; await openLabForm(id, {viewOnly:true}); return; }
  if(action === 'view-emergency'){ editing = { collection:'emergency', id, viewOnly:true }; await openEmergencyForm(id, {viewOnly:true}); return; }
  if(action === 'view-blog'){ editing = { collection:'blog', id, viewOnly:true }; await openBlogForm(id, {viewOnly:true}); return; }
});

/* Add buttons */
controls.btnAddDoctor.addEventListener('click', ()=>{ editing = { collection:'doctors', id:null }; openDoctorForm(null); });
controls.btnAddHospital.addEventListener('click', ()=>{ editing = { collection:'hospitals', id:null }; openHospitalForm(null); });
controls.btnAddClinic.addEventListener('click', ()=>{ editing = { collection:'clinics', id:null }; openClinicForm(null); });
controls.btnAddLab.addEventListener('click', ()=>{ editing = { collection:'labs', id:null }; openLabForm(null); });
controls.btnAddEmergency.addEventListener('click', ()=>{ editing = { collection:'emergency', id:null }; openEmergencyForm(null); });
controls.btnAddBlog.addEventListener('click', ()=>{ editing = { collection:'blog', id:null }; openBlogForm(null); });

/* ---------- FORM HTML builders ---------- */

function doctorFormHtml(data = {}){
  return `
    <label class="small">Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨</label>
    <input type="text" name="name" value="${esc(data.name||'')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨" required>

    <div class="form-row">
      <div class="field">
        <label class="small">Ø§Ù„ØªØ®ØµØµ</label>
        <input type="text" name="specialty" value="${esc(data.specialty||'')}" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø·Ù†ÙŠ">
      </div>
      <div class="field">
        <label class="small">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label>
        <input type="text" name="hospital" value="${esc(data.hospital||'')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰">
      </div>
    </div>

    <div class="form-row">
      <div class="field">
        <label class="small">Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input type="text" name="phone" value="${esc(data.phone||'')}" placeholder="Ù…Ø«Ø§Ù„: 77xxxxxx">
      </div>
      <div class="field">
        <label class="small">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)</label>
        <input type="url" name="img" value="${esc(data.img||'')}" placeholder="https://...">
      </div>
    </div>

    <label class="small" style="margin-top:8px">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ§Ù… â€” Ø§Ù…Ù„Ø£ ÙƒÙ„ ÙŠÙˆÙ… (Ø³Ø·Ø± Ù…Ù†ÙØµÙ„)</label>
    <div class="days-grid">
      ${['saturday','sunday','monday','tuesday','wednesday','thursday','friday'].map((d,i)=>`
        <div class="day-field">
          <div style="font-weight:700;margin-bottom:6px">${['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'][i]}</div>
          <input type="text" name="day_${d}" value="${esc((data.schedule && data.schedule[d] && data.schedule[d].time) || '')}" placeholder="Ù…Ø«Ø§Ù„: 8 Øµ - 2 Ù…">
        </div>
      `).join('')}
    </div>

    <label class="small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª / ÙˆØµÙ</label>
    <textarea name="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©">${esc(data.notes||'')}</textarea>
  `;
}

function hospitalFormHtml(data={}) {
  return `
    <label class="small">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label>
    <input type="text" name="name" value="${esc(data.name||'')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰" required>

    <div class="form-row">
      <div class="field">
        <label class="small">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
        <input type="text" name="city" value="${esc(data.city||'')}" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø¯Ù†">
      </div>
      <div class="field">
        <label class="small">Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input type="text" name="phone" value="${esc(data.phone||'')}" placeholder="ØºÙŠØ± Ù…ØªÙˆÙØ±">
      </div>
    </div>

    <label class="small">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨ÙØ§ØµÙ„Ø©)</label>
    <input type="text" name="department" value="${esc(data.department||'')}" placeholder="Ø¨Ø§Ø·Ù†ÙŠ, Ø¹ÙŠÙˆÙ†,...">

    <label class="small">Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©</label>
    <input type="url" name="img" value="${esc(data.img||'')}" placeholder="https://...">

    <label class="small">Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
    <input type="url" name="map" value="${esc(data.map||'')}" placeholder="https://maps...">

    <label class="small">ÙˆØµÙ</label>
    <textarea name="description" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰">${esc(data.description||'')}</textarea>
  `;
}

function genericPlaceFormHtml(data={}, title='Ø§Ù„Ù…ÙƒØ§Ù†', opts={}) {
  return `
    <label class="small">Ø§Ø³Ù… ${title}</label>
    <input type="text" name="name" value="${esc(data.name||'')}" placeholder="Ø§Ù„Ø§Ø³Ù…" required>

    <div class="form-row">
      <div class="field">
        <label class="small">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
        <input type="text" name="city" value="${esc(data.city||'')}" placeholder="Ù…Ø«Ø§Ù„: ØµÙ†Ø¹Ø§Ø¡">
      </div>
      <div class="field">
        <label class="small">Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input type="text" name="phone" value="${esc(data.phone||'')}" placeholder="ØºÙŠØ± Ù…ØªÙˆÙØ±">
      </div>
    </div>

    <label class="small">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)</label>
    <input type="text" name="department" value="${esc(data.department||'')}" placeholder="Ù‚Ø³Ù…1, Ù‚Ø³Ù…2">

    <label class="small">Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©</label>
    <input type="url" name="img" value="${esc(data.img||'')}" placeholder="https://...">

    <label class="small">Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
    <input type="url" name="map" value="${esc(data.map||'')}" placeholder="https://maps...">

    ${opts.includeTests ? `
      <label class="small">Ø§Ù„ÙØ­ÙˆØµØ§Øª (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)</label>
      <input type="text" name="tests" value="${esc(data.tests || '')}" placeholder="CBC, Glucose, ...">
    ` : ''}

    ${opts.includeOpen24 ? `
      <div style="margin:8px 0">
        <label class="small">ÙŠØ¹Ù…Ù„ 24 Ø³Ø§Ø¹Ø©ØŸ</label>
        <label><input type="checkbox" name="open24" ${data.open24 ? 'checked' : ''}> Ù†Ø¹Ù…</label>
      </div>
    ` : ''}

    <label class="small">ÙˆØµÙ</label>
    <textarea name="description" placeholder="ÙˆØµÙ">${esc(data.description||'')}</textarea>
  `;
}

/* BLOG form (simple) */
function blogFormHtml(data={}) {
  return `
    <label class="small">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„</label>
    <input type="text" name="title" value="${esc(data.title||'')}" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù‚ØµÙŠØ±" required>

    <label class="small">Ù…Ù‚ØªØ·Ù / ÙˆØµÙ Ù‚ØµÙŠØ±</label>
    <input type="text" name="excerpt" value="${esc(data.excerpt||'')}" placeholder="Ù…Ù‚ØªØ·Ù ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…">

    <label class="small">Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (URL)</label>
    <input type="url" name="img" value="${esc(data.img||'')}" placeholder="https://...">

    <label class="small">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
    <textarea name="content" placeholder="Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ù‚Ø§Ù„">${esc(data.content||'')}</textarea>
  `;
}

/* ---------- open forms (fetch data if edit) ---------- */

async function openDoctorForm(id=null, opts={}) {
  modalTitle.textContent = id ? (opts.viewOnly ? 'Ø¹Ø±Ø¶ Ø§Ù„Ø·Ø¨ÙŠØ¨' : 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ø¨ÙŠØ¨') : 'Ø¥Ø¶Ø§ÙØ© Ø·Ø¨ÙŠØ¨';
  formFields.innerHTML = `<div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
  overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
  if(!id){ formFields.innerHTML = doctorFormHtml({}); if(opts.viewOnly) disableFormFields(true); return; }
  try {
    const snap = await getDoc(doc(db,'doctors',id));
    if(!snap.exists()) { formFields.innerHTML = `<div class="muted">Ø§Ù„Ø·Ø¨ÙŠØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>`; return; }
    formFields.innerHTML = doctorFormHtml(snap.data());
    if(opts.viewOnly) disableFormFields(true);
  } catch(err){ console.error(err); formFields.innerHTML = `<div class="muted">Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø¨</div>`; }
}

async function openHospitalForm(id=null, opts={}) {
  modalTitle.textContent = id ? (opts.viewOnly ? 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰' : 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰') : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ´ÙÙ‰';
  formFields.innerHTML = `<div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
  overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
  if(!id){ formFields.innerHTML = hospitalFormHtml({}); if(opts.viewOnly) disableFormFields(true); return; }
  try {
    const snap = await getDoc(doc(db,'hospitals',id));
    if(!snap.exists()) { formFields.innerHTML = `<div class="muted">Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>`; return; }
    formFields.innerHTML = hospitalFormHtml(snap.data());
    if(opts.viewOnly) disableFormFields(true);
  } catch(err){ console.error(err); formFields.innerHTML = `<div class="muted">Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø¨</div>`; }
}

async function openClinicForm(id=null, opts={}) {
  modalTitle.textContent = id ? (opts.viewOnly ? 'Ø¹Ø±Ø¶ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©' : 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©') : 'Ø¥Ø¶Ø§ÙØ© Ø¹ÙŠØ§Ø¯Ø©';
  formFields.innerHTML = `<div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
  overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
  if(!id){ formFields.innerHTML = genericPlaceFormHtml({},"Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©", {}); if(opts.viewOnly) disableFormFields(true); return; }
  try {
    const snap = await getDoc(doc(db,'clinics',id));
    if(!snap.exists()){ formFields.innerHTML = `<div class="muted">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</div>`; return; }
    formFields.innerHTML = genericPlaceFormHtml(snap.data(),"Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©", {});
    if(opts.viewOnly) disableFormFields(true);
  } catch(err){ console.error(err); formFields.innerHTML = `<div class="muted">Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø¨</div>`; }
}

async function openLabForm(id=null, opts={}) {
  modalTitle.textContent = id ? (opts.viewOnly ? 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ¨Ø±' : 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø®ØªØ¨Ø±') : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø®ØªØ¨Ø±';
  formFields.innerHTML = `<div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
  overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
  if(!id){ formFields.innerHTML = genericPlaceFormHtml({},"Ø§Ù„Ù…Ø®ØªØ¨Ø±", { includeTests:true }); if(opts.viewOnly) disableFormFields(true); return; }
  try {
    const snap = await getDoc(doc(db,'labs',id));
    if(!snap.exists()){ formFields.innerHTML = `<div class="muted">Ø§Ù„Ù…Ø®ØªØ¨Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>`; return; }
    formFields.innerHTML = genericPlaceFormHtml(snap.data(),"Ø§Ù„Ù…Ø®ØªØ¨Ø±", { includeTests:true });
    if(opts.viewOnly) disableFormFields(true);
  } catch(err){ console.error(err); formFields.innerHTML = `<div class="muted">Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø¨</div>`; }
}

async function openEmergencyForm(id = null, opts = {}) {

  modalTitle.textContent = 
      id 
      ? (opts.viewOnly ? "Ø¹Ø±Ø¶ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦" : "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦") 
      : "Ø¥Ø¶Ø§ÙØ© Ø·ÙˆØ§Ø±Ø¦";

  formFields.innerHTML = `<div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
  
  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden","false");

  // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
  if (!id) {
    formFields.innerHTML = genericPlaceFormHtml(
      {
        name: "",
        city: "",
        phone: "",
        description: "",
        img: "",
        map: "",
        open24: true
      },
      "Ù…Ø±ÙƒØ² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦",
      { includeOpen24: true }
    );

    if (opts.viewOnly) disableFormFields(true);
    return;
  }

  // ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¹Ø±Ø¶
  try {
    const snap = await getDoc(doc(db, "emergency", id));

    if (!snap.exists()) {
      formFields.innerHTML = `<div class="muted">Ø§Ù„Ù…Ø±ÙƒØ² ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>`;
      return;
    }

    const data = snap.data();

    // Ø¯Ù…Ø¬ Ø£ÙŠ Ù†Ù‚Øµ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¸Ù‡ÙˆØ± undefined
    const mergedData = {
      name: data.name || "",
      city: data.city || "",
      phone: data.phone || "",
      description: data.description || "",
      img: data.img || "",
      map: data.map || "",
      open24: data.open24 ?? true
    };

    formFields.innerHTML = genericPlaceFormHtml(
      mergedData,
      "Ù…Ø±ÙƒØ² Ø§Ù„Ø·ÙˆØ§Ø±Ø¦",
      { includeOpen24: true }
    );

    if (opts.viewOnly) disableFormFields(true);

  } catch(err) {
    console.error(err);
    formFields.innerHTML = `<div class="muted">Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø¨</div>`;
  }
}


async function openBlogForm(id=null, opts={}) {
  modalTitle.textContent = id ? (opts.viewOnly ? 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ù„' : 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„') : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„';
  formFields.innerHTML = `<div class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
  overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
  if(!id){ formFields.innerHTML = blogFormHtml({}); if(opts.viewOnly) disableFormFields(true); return; }
  try {
    const snap = await getDoc(doc(db,'blogs',id));
    if(!snap.exists()){ formFields.innerHTML = `<div class="muted">Ø§Ù„Ù…Ù‚Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>`; return; }
    const data = snap.data() || {};
    formFields.innerHTML = blogFormHtml(data);
    if(opts.viewOnly) disableFormFields(true);
  } catch(err){ console.error(err); formFields.innerHTML = `<div class="muted">Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø¨</div>`; }
}

/* disable fields for view-only */
function disableFormFields(disable=true){
  const els = formFields.querySelectorAll('input,textarea,select,button');
  els.forEach(el=>{
    if(el.id === 'btnSave') return;
    el.disabled = disable;
  });
  document.getElementById('btnSave').style.display = disable ? 'none' : '';
}

/* Close modal */
btnCancel.addEventListener('click', closeModal);
overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });
function closeModal(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); formFields.innerHTML = ''; editing = null; document.getElementById('btnSave').style.display = ''; }

/* Submit modal (add/update) */
modalForm.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const fd = new FormData(modalForm);
  if(!editing || !editing.collection){ alert('Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©'); return; }
  const col = editing.collection;
  try {
    if(col === 'doctors'){
      const schedule = {
        saturday: { time: fd.get('day_saturday') || '' },
        sunday: { time: fd.get('day_sunday') || '' },
        monday: { time: fd.get('day_monday') || '' },
        tuesday: { time: fd.get('day_tuesday') || '' },
        wednesday: { time: fd.get('day_wednesday') || '' },
        thursday: { time: fd.get('day_thursday') || '' },
        friday: { time: fd.get('day_friday') || '' }
      };
      const data = {
        name: (fd.get('name')||'').trim(),
        specialty: (fd.get('specialty')||'').trim(),
        hospital: (fd.get('hospital')||'').trim(),
        phone: (fd.get('phone')||'').trim(),
        img: (fd.get('img')||'').trim(),
        notes: (fd.get('notes')||'').trim(),
        schedule
      };
      if(editing.id) await updateDoc(doc(db,'doctors',editing.id), data);
      else await addDoc(collection(db,'doctors'), data);
      await loadDoctors(); updateCounts(); closeModal(); return;
    }

    // places: hospitals/clinics/labs/emergency
    if(['hospitals','clinics','labs','emergency'].includes(col)){
      // common fields
      const base = {
        name: (fd.get('name')||'').trim(),
        city: (fd.get('city')||'').trim(),
        phone: (fd.get('phone')||'').trim(),
        department: (fd.get('department')||'').trim(),
        img: (fd.get('img')||'').trim(),
        map: (fd.get('map')||'').trim(),
        description: (fd.get('description')||'').trim()
      };

      // extras
      if(col === 'labs') base.tests = (fd.get('tests')||'').trim();
      if(col === 'emergency') base.open24 = !!fd.get('open24');

      if(editing.id) await updateDoc(doc(db,col,editing.id), base);
      else await addDoc(collection(db,col), base);

      if(col === 'hospitals') await loadHospitals();
      if(col === 'clinics') await loadClinics();
      if(col === 'labs') await loadLabs();
      if(col === 'emergency') await loadEmergency();

      updateCounts(); closeModal(); return;
    }

    // BLOG (simple)
    if(col === 'blog'){
      const data = {
        title: (fd.get('title')||'').trim(),
        excerpt: (fd.get('excerpt')||'').trim(),
        img: (fd.get('img')||'').trim(),
        content: (fd.get('content')||'').trim(),
        // date: serverTimestamp()  -> set only for new articles; keep original date on update
      };
      if(editing.id){
        await updateDoc(doc(db,'blog',editing.id), data);
      } else {
        await addDoc(collection(db,'blog'), { ...data, date: serverTimestamp() });
      }
      await loadBlogs(); updateCounts(); closeModal(); return;
    }

  } catch(err){ console.error(err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + (err.message||'Ø®Ø·Ø£')); }
});

/* Search filters (client-side) */
controls.searchDoctors.addEventListener('input', ()=>{ const q = controls.searchDoctors.value.trim().toLowerCase(); Array.from(tbodies.doctors.querySelectorAll('tr')).forEach(r=>{ r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none'; }); });
controls.searchHospitals.addEventListener('input', ()=>{ const q = controls.searchHospitals.value.trim().toLowerCase(); Array.from(tbodies.hospitals.querySelectorAll('tr')).forEach(r=>{ r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none'; }); });
controls.searchClinics.addEventListener('input', ()=>{ const q = controls.searchClinics.value.trim().toLowerCase(); Array.from(tbodies.clinics.querySelectorAll('tr')).forEach(r=>{ r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none'; }); });
controls.searchLabs.addEventListener('input', ()=>{ const q = controls.searchLabs.value.trim().toLowerCase(); Array.from(tbodies.labs.querySelectorAll('tr')).forEach(r=>{ r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none'; }); });
controls.searchEmergency.addEventListener('input', ()=>{ const q = controls.searchEmergency.value.trim().toLowerCase(); Array.from(tbodies.emergency.querySelectorAll('tr')).forEach(r=>{ r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none'; }); });
controls.searchBlog.addEventListener('input', ()=>{ const q = controls.searchBlog.value.trim().toLowerCase(); Array.from(tbodies.blog.querySelectorAll('tr')).forEach(r=>{ r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none'; }); });

/* Initial active tab */
setActiveTab('dashboard');

</script>

</body>
</html>


