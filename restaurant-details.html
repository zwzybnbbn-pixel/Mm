<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø·Ø¹Ù…</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo';}
body{background:#FFF7F0;padding:12px;}
.back-btn{
  display:inline-block;background:#A04000;color:#fff;
  padding:10px 16px;border-radius:10px;
  text-decoration:none;margin-bottom:15px;font-size:16px;
}
.card{
  width:100%;background:white;padding:18px;
  border-radius:15px;box-shadow:0 3px 12px #00000022;
  margin-bottom:15px;
}
h2{
  font-size:22px;color:#A04000;
  text-align:center;margin-bottom:15px;font-weight:800;
}
.info{
  background:#FFF3E0;padding:12px;
  border-left:5px solid #E67E22;
  border-radius:12px;margin-bottom:12px;
}
.label{font-size:15px;font-weight:700;color:#A04000;}
.value{font-size:16px;color:#333;margin-top:4px;}
.review-like{
  margin-top:8px;font-size:15px;color:#D35400;cursor:pointer;
}
.review-like span{font-weight:bold;color:#E67E22;}
.avg-box{text-align:center;margin-bottom:10px;}
.avg-rating{font-size:40px;font-weight:900;color:#E67E22;}
.rating-stars{font-size:22px;color:#E67E22;}
.reviews .review{
  background:#fff;padding:12px;border-radius:12px;
  margin-bottom:12px;box-shadow:0 2px 10px #00000015;
}
.review .stars{color:#E67E22;font-size:18px;}
.add-review textarea{
  width:100%;min-height:120px;padding:10px;
  border-radius:10px;border:1px solid #ccc;
}
.stars-input span{font-size:30px;color:#ccc;cursor:pointer;}
.stars-input .active{color:#E67E22;}
.btn{
  background:#D35400;color:white;padding:10px;
  border:0;border-radius:10px;font-size:16px;
  cursor:pointer;margin-top:10px;
}
.hospital-imgcircle{
  width:120px;height:120px;border-radius:50%;object-fit:cover;
  display:block;margin:10px auto;border:3px solid #D35400;
}
.map-btn{
  display:block;width:100%;padding:14px;margin-top:12px;
  background:#D35400;color:white;font-size:17px;
  border-radius:10px;text-align:center;text-decoration:none;
  font-weight:700;
}
.map-btn:hover{background:#E67E22;}
@media (min-width:900px){
  .card{max-width:900px;margin-inline:auto;}
  .send-area {display:flex; gap:12px;}
}
.send-area {margin-top:12px; display:flex; gap:10px; flex-direction:column;}
</style>

</head>
<body>

<a href="restaurants.html" class="back-btn">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
<img id="restImg" class="hospital-imgcircle" alt="restaurant image">

<div class="card">
  <h2 id="rName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>

  <div class="info">
    <div class="label">ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</div>
    <div class="value" id="rAddress"></div>
  </div>

  <div class="info">
    <div class="label">ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</div>
    <div class="value" id="rPhone"></div>
  </div>

  <div class="info">
    <div class="label">ğŸ½ Ø§Ù„Ù†ÙˆØ¹:</div>
    <div class="value" id="rType"></div>
  </div>

  <div class="info">
    <div class="label">ğŸ“ Ø§Ù„ÙˆØµÙ:</div>
    <div class="value" id="rDescription"></div>
  </div>

  <a id="mapBtn" class="map-btn" href="#" target="_blank">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
</div>

<div class="card">
  <div class="avg-box">
    <div class="avg-rating" id="avgRating">0.0</div>
    <div class="rating-stars" id="ratingStars">â˜…â˜…â˜…â˜…â˜…</div>
    <div id="ratingCount">0 ØªÙ‚ÙŠÙŠÙ…</div>
  </div>
  <div class="reviews" id="reviewsList">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.</div>
</div>

<div class="card add-review">
  <h3 style="color:#A04000;">Ø§ÙƒØªØ¨ ØªÙ‚ÙŠÙŠÙ…Ùƒ</h3>

  <div id="starsInput" class="stars-input" style="text-align:center;margin-bottom:10px;"></div>

  <textarea id="reviewText" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§..."></textarea>

  <div class="send-area">
    <input id="reviewName" placeholder="Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
    <button id="sendReview" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
  </div>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import {
  doc, getDoc,
  collection, addDoc, updateDoc,
  query, orderBy, serverTimestamp,
  increment,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const id = new URLSearchParams(location.search).get("id");

/* DOM */
const rName = document.getElementById("rName");
const rImg = document.getElementById("restImg");
const rAddress = document.getElementById("rAddress");
const rPhone = document.getElementById("rPhone");
const rType = document.getElementById("rType");
const rDescription = document.getElementById("rDescription");
const mapBtn = document.getElementById("mapBtn");
const avgRatingEl = document.getElementById("avgRating");
const ratingStarsEl = document.getElementById("ratingStars");
const ratingCountEl = document.getElementById("ratingCount");
const reviewsList = document.getElementById("reviewsList");
const starsInput = document.getElementById("starsInput");
const reviewText = document.getElementById("reviewText");
const reviewName = document.getElementById("reviewName");
const sendReviewBtn = document.getElementById("sendReview");

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ */
async function loadDetails(){
  const ref = doc(db, "tourism_restaurants", id);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;

  const d = snap.data();
  rName.textContent = d.name || "";
  rImg.src = d.image || "https://via.placeholder.com/300x300?text=No+Image";
  rAddress.textContent = d.address || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  rPhone.innerHTML = d.phone ? `<a href="tel:${d.phone}">${d.phone}</a>` : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  rType.textContent = d.type || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  rDescription.textContent = d.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
  mapBtn.href = d.map_link || "#";
}

/* Ø±Ø³Ù… Ø§Ù„Ù†Ø¬ÙˆÙ… */
let selected = 5;
function drawStarsInput(){
  let html = "";
  for(let i=1;i<=5;i++){
    html += `<span data-id="${i}" class="${i<=selected?'active':''}">â˜…</span>`;
  }
  starsInput.innerHTML = html;
}
drawStarsInput();

starsInput.addEventListener("click", e=>{
  const s = e.target.closest("span");
  if(!s) return;
  selected = Number(s.dataset.id);
  drawStarsInput();
});

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª â€” LIVE */
function loadReviews() {
  const ref = collection(db, "tourism_restaurants", id, "reviews");
  const q = query(ref, orderBy("date", "desc"));

  onSnapshot(q, snap => {
    let sum = 0, count = 0, html = "";

    snap.forEach(r => {
      const d = r.data();
      const rating = d.rating || 0;
      const likes = d.likes || 0;

      sum += rating;
      count++;

      html += `
        <div class="review">
          <div class="stars">${"â˜…".repeat(rating)}${"â˜†".repeat(5-rating)}</div>

          <p>${d.text || ""}</p>
          <small style="color:#666">${d.name ? ("â€” " + d.name) : ""}</small>

          <div class="review-like" onclick="likeReview('${r.id}')">
            â¤ï¸ Ø£Ø¹Ø¬Ø¨Ù†ÙŠ <span>(${likes})</span>
          </div>
        </div>
      `;
    });

    /* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªÙˆØ³Ø· */
    avgRatingEl.textContent = count ? (sum / count).toFixed(1) : "0.0";

    /* ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø¥Ù„Ù‰ Ù†Ø¬ÙˆÙ… */
    const avg = count ? Math.round(sum / count) : 0;
    ratingStarsEl.textContent = "â˜…".repeat(avg) + "â˜†".repeat(5 - avg);

    /* Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª */
    ratingCountEl.textContent = count + " ØªÙ‚ÙŠÙŠÙ…";

    /* Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
    reviewsList.innerHTML = html || "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.";
  });
}

/* Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… Ù…Ø¹ Ø§Ù„Ù…Ù†Ø¹ */
sendReviewBtn.addEventListener("click", async ()=>{

  if (localStorage.getItem("reviewed_restaurant_" + id)) {
      alert("Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… Ù…Ø³Ø¨Ù‚Ø§Ù‹");
      return;
  }

  const text = reviewText.value.trim();
  if(!text) return alert("Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹");

  await addDoc(collection(db, "tourism_restaurants", id, "reviews"), {
    rating: selected,
    text,
    name: reviewName.value.trim() || "",
    likes: 0,
    date: serverTimestamp()
  });

  localStorage.setItem("reviewed_restaurant_" + id, "1");

  reviewText.value = "";
  reviewName.value = "";
  selected = 5;
  drawStarsInput();

  alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰");
});

/* Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ */
window.likeReview = async function(rid){
  if(localStorage.getItem("liked_"+rid)) return alert("Ù„Ù‚Ø¯ Ø£Ø¹Ø¬Ø¨Øª Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù…Ø³Ø¨Ù‚Ø§Ù‹");

  const ref = doc(db, "tourism_restaurants", id, "reviews", rid);
  await updateDoc(ref, { likes: increment(1) });

  localStorage.setItem("liked_"+rid, "1");
};

await loadDetails();
loadReviews();
</script>


</body>
</html>
